<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DumpTrack Pro — Sistema de Gestión</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0a;
  --surface: #141414;
  --surface2: #1c1c1c;
  --surface3: #242424;
  --border: #2c2c2c;
  --accent: #f5a623;
  --accent2: #d4891a;
  --danger: #e05252;
  --success: #4caf7d;
  --info: #4a9fcf;
  --purple: #9b7fd4;
  --teal: #4cbfb0;
  --text: #e8e8e8;
  --muted: #666;
  --label: #999;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'IBM Plex Sans',sans-serif;min-height:100vh;overflow-x:hidden;}
input,select,textarea{font-family:'IBM Plex Sans',sans-serif;}

/* ── HEADER ── */
header{
  background:var(--surface);border-bottom:2px solid var(--accent);
  height:auto;min-height:60px;display:flex;align-items:center;padding:0 clamp(.75rem,1.5vw,1.5rem);
  gap:clamp(.5rem,1vw,1.5rem);position:sticky;top:0;z-index:500;flex-wrap:wrap;
}
.logo{font-family:'Bebas Neue',sans-serif;font-size:clamp(1.3rem, 2.5vw, 1.8rem);letter-spacing:clamp(2px,0.3vw,4px);color:var(--accent);white-space:nowrap;display:flex;align-items:center;gap:8px;}
.logo em{color:var(--text);font-style:normal;}

/* ── NAV ── */
nav{display:flex;align-items:center;gap:clamp(1px,0.3vw,4px);flex:1;min-width:0;overflow:visible;}
.nav-btn{
  background:none;border:none;color:var(--label);cursor:pointer;
  padding:8px clamp(6px, 1vw, 14px);font-family:'IBM Plex Mono',monospace;font-size:clamp(0.62rem, 0.9vw, 0.72rem);
  letter-spacing:1px;text-transform:uppercase;border-radius:2px;
  transition:all .15s;white-space:nowrap;position:relative;
}
.nav-btn:hover,.nav-btn.active{color:var(--text);background:var(--surface2);}
.nav-btn.active::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:2px;background:var(--accent);}

/* ── DROPDOWN ── */
.dropdown{position:relative;}
.dropdown-menu{
  position:absolute;top:calc(100% + 12px);left:0;
  background:var(--surface);border:1px solid var(--border);
  border-top:2px solid var(--accent);min-width:220px;
  box-shadow:0 16px 40px rgba(0,0,0,.7);opacity:0;
  pointer-events:none;transform:translateY(-8px);
  transition:all .2s;z-index:600;border-radius:0 0 4px 4px;
}
.dropdown.open .dropdown-menu{opacity:1;pointer-events:all;transform:translateY(0);}
.dropdown-menu a{
  display:flex;align-items:center;gap:12px;padding:11px 16px;
  color:var(--label);text-decoration:none;font-family:'IBM Plex Mono',monospace;
  font-size:0.72rem;letter-spacing:1px;text-transform:uppercase;
  border-bottom:1px solid var(--border);transition:all .15s;cursor:pointer;
}
.dropdown-menu a:last-child{border-bottom:none;}
.dropdown-menu a:hover,.dropdown-menu a.active{background:var(--surface2);color:var(--text);}
.dropdown-menu a .menu-icon{font-size:1rem;width:20px;text-align:center;}
.dropdown-menu a .menu-badge{margin-left:auto;background:var(--surface3);border:1px solid var(--border);font-size:0.65rem;padding:1px 6px;border-radius:8px;color:var(--muted);}
.dropdown-arrow{font-size:0.6rem;margin-left:4px;transition:transform .2s;}
.dropdown.open .dropdown-arrow{transform:rotate(180deg);}

.header-right{margin-left:auto;display:flex;align-items:center;gap:10px;}
.week-badge{background:var(--surface2);border:1px solid var(--border);padding:5px 12px;font-family:'IBM Plex Mono',monospace;font-size:0.7rem;color:var(--label);border-radius:2px;}

/* ── PAGES ── */
.page{display:none;animation:fadeIn .25s ease;}
.page.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.container{max-width:1440px;margin:0 auto;padding:1.75rem;}

/* ── SECTION HEADER ── */
.section-header{display:flex;align-items:center;gap:16px;margin-bottom:1.75rem;padding-bottom:1rem;border-bottom:1px solid var(--border);}
.section-icon{font-size:1.6rem;width:48px;height:48px;display:flex;align-items:center;justify-content:center;background:var(--surface2);border:1px solid var(--border);border-radius:4px;}
.section-title h1{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:3px;color:var(--accent);}
.section-title p{font-size:0.75rem;color:var(--muted);font-family:'IBM Plex Mono',monospace;letter-spacing:1px;margin-top:2px;}

/* ── STATS ── */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:.875rem;margin-bottom:1.75rem;}
.stat-card{background:var(--surface);border:1px solid var(--border);padding:1.1rem 1.4rem;border-radius:3px;border-left:3px solid var(--accent);transition:transform .2s;}
.stat-card:hover{transform:translateY(-2px);}
.stat-label{font-size:0.65rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);margin-bottom:5px;font-family:'IBM Plex Mono',monospace;}
.stat-value{font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--accent);letter-spacing:2px;}
.stat-sub{font-size:0.65rem;color:var(--muted);margin-top:2px;font-family:'IBM Plex Mono',monospace;}

/* ── LAYOUT ── */
.main-grid{display:grid;grid-template-columns:380px 1fr;gap:1.5rem;}
.main-grid.full{grid-template-columns:1fr;}

/* ── CARDS ── */
.card{background:var(--surface);border:1px solid var(--border);border-radius:3px;overflow:hidden;}
.card-header{background:var(--surface2);padding:.875rem 1.25rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.card-header h3{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;}
.card-header .accent-dot{width:7px;height:7px;border-radius:50%;background:var(--accent);flex-shrink:0;}
.card-body{padding:1.25rem;}

/* ── FORM ── */
.form-group{margin-bottom:.875rem;}
.form-group label{display:block;font-size:0.65rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--label);margin-bottom:5px;font-family:'IBM Plex Mono',monospace;}
.form-group input,.form-group select,.form-group textarea{
  width:100%;background:var(--surface2);border:1px solid var(--border);
  color:var(--text);padding:9px 11px;border-radius:2px;
  font-size:0.85rem;transition:border-color .2s;outline:none;
}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--accent);}
select option{background:var(--surface2);}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}

.route-sep{display:flex;align-items:center;gap:8px;margin:2px 0;font-family:'IBM Plex Mono',monospace;font-size:0.65rem;color:var(--accent);}
.route-sep::before,.route-sep::after{content:'';flex:1;height:1px;background:var(--border);}

.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;border:none;cursor:pointer;border-radius:2px;transition:all .15s;font-family:'IBM Plex Mono',monospace;font-size:0.72rem;letter-spacing:1px;text-transform:uppercase;}
.btn-primary{background:var(--accent);color:#000;padding:11px 20px;font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:3px;width:100%;margin-top:4px;}
.btn-primary:hover{background:var(--accent2);transform:translateY(-1px);}
.btn-primary:active{transform:translateY(0);}
.btn-primary.edit-mode{background:#4a8fcf;}
.btn-secondary{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:9px 16px;width:100%;margin-top:6px;}
.btn-secondary:hover{border-color:var(--text);}
.btn-sm{padding:5px 10px;font-size:0.65rem;}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--label);padding:7px 14px;}
.btn-outline:hover{border-color:var(--accent);color:var(--accent);}
.btn-success-outline{background:transparent;border:1px solid var(--border);color:var(--label);padding:7px 14px;}
.btn-success-outline:hover{border-color:var(--success);color:var(--success);}

/* ── TABLE ── */
.table-toolbar{background:var(--surface2);padding:.875rem 1.25rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.table-toolbar h3{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;}
.count-badge{background:var(--accent);color:#000;font-size:0.65rem;font-weight:700;padding:2px 8px;border-radius:10px;font-family:'IBM Plex Mono',monospace;}
.search-input{background:var(--surface3);border:1px solid var(--border);color:var(--text);padding:6px 11px;border-radius:2px;font-family:'IBM Plex Sans',sans-serif;font-size:0.78rem;outline:none;width:160px;transition:border-color .2s;}
.search-input:focus{border-color:var(--accent);}
.ml-auto{margin-left:auto;}

.tbl-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
th{background:var(--surface2);padding:9px 12px;text-align:left;font-family:'IBM Plex Mono',monospace;font-size:0.62rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);border-bottom:1px solid var(--border);white-space:nowrap;}
td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.04);font-size:0.8rem;vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(245,166,35,.03);}
.mono{font-family:'IBM Plex Mono',monospace;}
.accent{color:var(--accent);}
.muted{color:var(--muted);}
.actions{display:flex;gap:5px;}
.btn-icon{background:var(--surface2);border:1px solid var(--border);color:var(--muted);cursor:pointer;padding:4px 8px;border-radius:2px;font-size:0.72rem;transition:all .15s;}
.btn-edit:hover{border-color:var(--info);color:var(--info);}
.btn-del:hover{border-color:var(--danger);color:var(--danger);}

/* STATUS BADGES */
.badge{display:inline-block;padding:2px 9px;border-radius:2px;font-size:0.62rem;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:1px;font-weight:600;}
.badge-green{background:rgba(76,175,125,.15);color:var(--success);border:1px solid rgba(76,175,125,.3);}
.badge-red{background:rgba(224,82,82,.15);color:var(--danger);border:1px solid rgba(224,82,82,.3);}
.badge-yellow{background:rgba(245,166,35,.15);color:var(--accent);border:1px solid rgba(245,166,35,.3);}
.badge-blue{background:rgba(74,159,207,.15);color:var(--info);border:1px solid rgba(74,159,207,.3);}
.badge-purple{background:rgba(155,127,212,.15);color:var(--purple);border:1px solid rgba(155,127,212,.3);}

/* MATERIAL */
.mat-badge{display:inline-block;padding:2px 8px;border-radius:2px;font-size:0.62rem;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:1px;font-weight:600;}

/* TOTALS ROW */
.totals-row td{background:var(--surface2)!important;font-family:'IBM Plex Mono',monospace;font-weight:600;color:var(--accent);border-top:2px solid var(--accent)!important;}

/* EMPTY */
.empty-state{text-align:center;padding:3.5rem 2rem;color:var(--muted);}
.empty-state .icon{font-size:2.5rem;margin-bottom:.875rem;opacity:.3;}
.empty-state p{font-size:0.72rem;letter-spacing:2px;text-transform:uppercase;font-family:'IBM Plex Mono',monospace;}

/* WEEK NAV */
.week-nav{display:flex;align-items:center;gap:10px;margin-bottom:1.5rem;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:3px;}
.week-nav h2{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:3px;color:var(--accent);}
.week-info{font-family:'IBM Plex Mono',monospace;font-size:0.75rem;color:var(--label);}
.btn-wk{background:var(--surface2);border:1px solid var(--border);color:var(--text);cursor:pointer;padding:6px 12px;font-family:'IBM Plex Mono',monospace;font-size:0.72rem;border-radius:2px;transition:all .15s;}
.btn-wk:hover{border-color:var(--accent);color:var(--accent);}

/* TOAST */
.toast{position:fixed;bottom:22px;right:22px;background:var(--surface);border:1px solid var(--accent);border-left:4px solid var(--accent);padding:12px 18px;border-radius:3px;font-size:0.8rem;z-index:9999;transform:translateX(130%);transition:transform .3s ease;font-family:'IBM Plex Mono',monospace;max-width:320px;}
.toast.show{transform:translateX(0);}
.toast.error{border-color:var(--danger);border-left-color:var(--danger);}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:800;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--surface);border:1px solid var(--border);border-top:3px solid var(--danger);padding:1.75rem;border-radius:4px;width:340px;text-align:center;transform:translateY(-16px);transition:transform .2s;}
.modal-overlay.open .modal{transform:translateY(0);}
.modal h3{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:2px;margin-bottom:.5rem;}
.modal p{color:var(--label);font-size:0.82rem;margin-bottom:1.25rem;line-height:1.6;}
.modal-btns{display:flex;gap:8px;justify-content:center;}
.btn-cancel-modal{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:9px 20px;cursor:pointer;border-radius:2px;font-family:'IBM Plex Mono',monospace;font-size:0.75rem;transition:all .15s;}
.btn-cancel-modal:hover{border-color:var(--text);}
.btn-del-confirm{background:var(--danger);border:none;color:#fff;padding:9px 20px;cursor:pointer;border-radius:2px;font-family:'IBM Plex Mono',monospace;font-size:0.75rem;transition:all .15s;}
.btn-del-confirm:hover{background:#c84444;}

/* COLOR PICKER ROW */
.color-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;}
.color-swatch{width:24px;height:24px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .15s;}
.color-swatch:hover,.color-swatch.selected{border-color:#fff;transform:scale(1.15);}

/* TAG */
.tag{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:2px;font-size:0.65rem;font-family:'IBM Plex Mono',monospace;letter-spacing:1px;text-transform:uppercase;}

/* TRUCK AVATAR */
.truck-avatar{width:36px;height:36px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}

/* CDL badge */
.cdl-badge{font-family:'Bebas Neue',sans-serif;font-size:0.85rem;letter-spacing:2px;padding:2px 8px;border-radius:2px;}

/* COMPANY CARD */
.company-initials{width:40px;height:40px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:1.1rem;flex-shrink:0;}


.user-pill{display:flex;align-items:center;gap:8px;padding:4px 10px;border:1px solid var(--border);background:var(--surface2);border-radius:2px;font-family:'IBM Plex Mono',monospace;font-size:0.68rem;color:var(--label);}
.login-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1200;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;}
.login-overlay.open{opacity:1;pointer-events:all;}

.login-overlay{overflow:hidden;background:
  radial-gradient(1200px 500px at 10% 10%, rgba(245,166,35,.08), transparent 60%),
  radial-gradient(900px 420px at 90% 90%, rgba(245,166,35,.06), transparent 65%),
  linear-gradient(rgba(0,0,0,.82), rgba(0,0,0,.88));
}
.login-overlay::before,.login-overlay::after{content:'';position:absolute;inset:0;pointer-events:none;}
.login-overlay::before{
  background-image:url("data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%20320%20120%27%3E%3Cg%20fill%3D%27white%27%3E%3Crect%20x%3D%2718%27%20y%3D%2756%27%20width%3D%27148%27%20height%3D%2730%27%20rx%3D%274%27/%3E%3Cpath%20d%3D%27M166%2056h36l28-20h40v50h-104z%27/%3E%3Crect%20x%3D%27203%27%20y%3D%2730%27%20width%3D%2738%27%20height%3D%2718%27%20rx%3D%272%27/%3E%3Ccircle%20cx%3D%2774%27%20cy%3D%2792%27%20r%3D%2718%27/%3E%3Ccircle%20cx%3D%27150%27%20cy%3D%2792%27%20r%3D%2718%27/%3E%3Ccircle%20cx%3D%27240%27%20cy%3D%2792%27%20r%3D%2718%27/%3E%3Cpath%20d%3D%27M28%2046l110-18%2028%2018H28z%27%20opacity%3D%27.9%27/%3E%3C/g%3E%3C/svg%3E"), url("data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%20360%20140%27%3E%3Cg%20fill%3D%27white%27%3E%3Cpath%20d%3D%27M18%2076h182v26H18z%27/%3E%3Cpath%20d%3D%27M200%2054h52l30-20h54v68H200z%27/%3E%3Cpath%20d%3D%27M58%2038h108l20%2016H42z%27%20opacity%3D%27.95%27/%3E%3Ccircle%20cx%3D%2772%27%20cy%3D%27104%27%20r%3D%2719%27/%3E%3Ccircle%20cx%3D%27152%27%20cy%3D%27104%27%20r%3D%2719%27/%3E%3Ccircle%20cx%3D%27276%27%20cy%3D%27104%27%20r%3D%2720%27/%3E%3C/g%3E%3C/svg%3E"), url("data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%20320%20120%27%3E%3Cg%20fill%3D%27white%27%3E%3Crect%20x%3D%2718%27%20y%3D%2756%27%20width%3D%27148%27%20height%3D%2730%27%20rx%3D%274%27/%3E%3Cpath%20d%3D%27M166%2056h36l28-20h40v50h-104z%27/%3E%3Crect%20x%3D%27203%27%20y%3D%2730%27%20width%3D%2738%27%20height%3D%2718%27%20rx%3D%272%27/%3E%3Ccircle%20cx%3D%2774%27%20cy%3D%2792%27%20r%3D%2718%27/%3E%3Ccircle%20cx%3D%27150%27%20cy%3D%2792%27%20r%3D%2718%27/%3E%3Ccircle%20cx%3D%27240%27%20cy%3D%2792%27%20r%3D%2718%27/%3E%3Cpath%20d%3D%27M28%2046l110-18%2028%2018H28z%27%20opacity%3D%27.9%27/%3E%3C/g%3E%3C/svg%3E");
  background-repeat:no-repeat,no-repeat,no-repeat;
  background-size:420px auto, 520px auto, 380px auto;
  background-position:8% 78%, 92% 18%, 70% 88%;
  opacity:.10;
}
.login-overlay::after{
  background:
    linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.35)),
    repeating-linear-gradient(120deg, rgba(255,255,255,.02) 0 2px, transparent 2px 28px);
  opacity:.35;
}
.login-box{position:relative;z-index:1;backdrop-filter: blur(2px);}

.login-box{width:420px;max-width:92vw;background:var(--surface);border:1px solid var(--border);border-top:3px solid var(--accent);border-radius:4px;overflow:hidden;}
.login-box-hdr{padding:1rem 1.25rem;background:var(--surface2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.login-box-hdr h3{font-family:'Bebas Neue',sans-serif;letter-spacing:3px;font-size:1.1rem;color:var(--accent);}
.login-box-body{padding:1.25rem;}
.login-progress-wrap{display:none;margin-top:10px;padding:10px;border:1px solid var(--border);background:var(--surface2);border-radius:3px;}
.login-progress-wrap.show{display:block;}
.login-progress-bar{height:10px;border:1px solid var(--border);background:var(--surface3);border-radius:999px;overflow:hidden;margin-top:8px;}
.login-progress-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--success));transition:width .18s ease;}
.login-progress-meta{display:flex;justify-content:space-between;align-items:center;font-family:'IBM Plex Mono',monospace;font-size:0.68rem;color:var(--label);}
body.app-locked header, body.app-locked .page{visibility:hidden;pointer-events:none;}
body.app-locked{overflow:hidden;}
@media(max-width:1100px){.main-grid{grid-template-columns:1fr;}.stats-grid{grid-template-columns:repeat(2,1fr);}}
@media(max-width:640px){.stats-grid{grid-template-columns:repeat(2,1fr);}.container{padding:1rem;}.week-nav{flex-wrap:wrap;}}
/* ══════════════════════════════════════════════════════════
   PRINT STYLES — SISTEMA COMPLETO DE IMPRESIÓN
══════════════════════════════════════════════════════════ */
@media print {
  /* Reset base */
  *, *::before, *::after { box-shadow: none !important; text-shadow: none !important; }
  html, body {
    background: #fff !important;
    color: #111 !important;
    font-size: 11pt;
    width: 100%;
    margin: 0;
    padding: 0;
  }

  /* Ocultar todo lo que no se imprime */
  header, .form-card, .week-nav, .table-toolbar .btn,
  .table-toolbar .search-input, .actions, .btn-icon,
  .btn-wk, .btn-primary, .btn-secondary, .btn-add-entry,
  .modal-overlay, .toast, .login-overlay,
  .pdf-reader-panel, .ai-results-section,
  .backup-btn, .btn-print-hide,
  #dd_settings, .dropdown-menu,
  select.search-input,
  .print-hide { display: none !important; }

  /* Mostrar solo la página activa */
  .page { display: none !important; }
  .page.active { display: block !important; }

  /* Variables de color para impresión */
  :root {
    --bg: #fff;
    --surface: #fff;
    --surface2: #f5f5f5;
    --surface3: #ebebeb;
    --border: #ccc;
    --accent: #c47a00;
    --accent2: #a36600;
    --danger: #c0392b;
    --success: #1a7a45;
    --info: #1565a0;
    --purple: #5e35b1;
    --teal: #00796b;
    --text: #111;
    --muted: #555;
    --label: #333;
  }

  /* ── PRINT HEADER dinámico — visible solo al imprimir ── */
  .prt-injected-header {
    display: block !important;
  }
  /* Ocultar los print-company-header estáticos viejos (por compatibilidad) */
  .print-company-header[style*="display:none"] {
    display: none !important;
  }
  .print-company-header {
    display: flex !important;
    page-break-inside: avoid;
  }

  /* ── PRINT FOOTER ── */
  .print-footer {
    display: block !important;
    position: fixed;
    bottom: 0; left: 0; right: 0;
    border-top: 1px solid #ccc;
    padding: 6px 0 2px;
    font-size: 7.5pt;
    color: #888;
    text-align: center;
    background: #fff;
  }

  /* Contenedor */
  .container { max-width: 100%; padding: 0.5rem 0 !important; margin: 0 !important; }

  /* Stats grid — compacto */
  .stats-grid {
    display: grid !important;
    grid-template-columns: repeat(4, 1fr) !important;
    gap: 6px !important;
    margin-bottom: 12px !important;
  }
  .stat-card {
    border: 1px solid #ccc !important;
    border-left: 3px solid #c47a00 !important;
    padding: 8px 10px !important;
    background: #fff !important;
    break-inside: avoid;
  }
  .stat-label { color: #555 !important; font-size: 7pt !important; }
  .stat-value { font-size: 16pt !important; color: #111 !important; }
  .stat-sub { color: #888 !important; font-size: 7pt !important; }

  /* Section header */
  .section-header {
    border-bottom: 1px solid #ccc !important;
    margin-bottom: 12px !important;
    padding-bottom: 8px !important;
  }
  .section-title h1 { color: #111 !important; font-size: 16pt !important; }
  .section-title p { color: #555 !important; font-size: 8pt !important; }
  .section-icon { display: none !important; }

  /* Tables */
  table { width: 100% !important; border-collapse: collapse !important; font-size: 9pt; }
  th {
    background: #f0f0f0 !important;
    color: #333 !important;
    border-bottom: 2px solid #ccc !important;
    padding: 6px 8px !important;
    font-size: 7.5pt !important;
    border: 1px solid #ddd !important;
  }
  td {
    padding: 5px 8px !important;
    border-bottom: 1px solid #e5e5e5 !important;
    color: #111 !important;
    font-size: 9pt !important;
    border: 1px solid #e5e5e5 !important;
  }
  tr:hover td { background: none !important; }
  tr:nth-child(even) td { background: #fafafa !important; }
  .totals-row td {
    background: #fff3dc !important;
    color: #8a5a00 !important;
    font-weight: 700 !important;
    border-top: 2px solid #c47a00 !important;
  }
  .tbl-wrap { overflow: visible !important; }

  /* Cards */
  .card { border: 1px solid #ccc !important; break-inside: avoid; background: #fff !important; }
  .card-header { background: #f5f5f5 !important; border-bottom: 1px solid #ccc !important; }
  .card-header h3 { color: #111 !important; font-size: 10pt !important; }

  /* Badges */
  .badge { border: 1px solid #ccc !important; font-size: 7pt !important; }
  .badge-green { background: #e8f5e9 !important; color: #1a7a45 !important; }
  .badge-red { background: #fdecea !important; color: #c0392b !important; }
  .badge-yellow { background: #fff8e1 !important; color: #8a5a00 !important; }
  .badge-blue { background: #e3f2fd !important; color: #1565a0 !important; }
  .badge-purple { background: #ede7f6 !important; color: #5e35b1 !important; }

  /* Main grid — una columna al imprimir */
  .main-grid { grid-template-columns: 1fr !important; gap: 10px !important; }

  /* Earnings */
  .earnings-hero { border: 1px solid #ccc !important; background: #fff !important; padding: 10px 14px !important; }
  .earnings-hero::before { display: none !important; }
  .hero-amount { color: #1a7a45 !important; }
  .broker-header { border: 1px solid #ccc !important; background: #f5f5f5 !important; }
  .broker-body { border: 1px solid #ccc !important; border-top: none !important; }
  .broker-collapsed .broker-body { display: block !important; }
  .broker-name { color: #111 !important; }
  .broker-total { color: #1a7a45 !important; }

  /* P&L */
  .pl-hero { grid-template-columns: repeat(3, 1fr) !important; gap: 8px !important; }
  .pl-card { border: 1px solid #ccc !important; background: #fff !important; break-inside: avoid; }
  .pl-val { font-size: 18pt !important; }
  .bar-chart { display: none !important; }
  .chart-container { display: none !important; }
  .pl-table-section { break-inside: avoid; border: 1px solid #ccc !important; margin-bottom: 10px !important; }
  .pl-section-hdr { background: #f5f5f5 !important; color: #333 !important; border-bottom: 1px solid #ccc !important; }

  /* Closing */
  .cl-status-bar { border: 1px solid #ccc !important; background: #fff !important; }
  .cl-broker-card { break-inside: avoid; }
  .cl-status-pill { border: 1px solid #ccc !important; }

  /* Alerts */
  .alert-card { border: 1px solid #ccc !important; break-inside: avoid; }

  /* Expenses */
  .earnings-footer { border: 1px solid #ccc !important; background: #fff !important; }

  /* Settings — no imprimible */
  #page-settings.active .settings-section { display: none !important; }

  /* Page breaks */
  .broker-section { break-inside: avoid; }
  .page-break { page-break-before: always; }

  /* Accent text color para impresión */
  .accent { color: #c47a00 !important; }
  .muted { color: #777 !important; }
  .mono { font-family: 'Courier New', monospace !important; }

  /* Truck / driver avatar */
  .truck-avatar { background: #f0f0f0 !important; border: 1px solid #ddd !important; }
  .company-initials { background: #f0f0f0 !important; color: #333 !important; }

  /* Quitar sombras y bordes redondeados */
  .card, .stat-card, .pl-card, .broker-header, .broker-body,
  .earnings-hero, .earnings-footer { border-radius: 0 !important; }
}

/* ── EARNINGS PAGE ── */
.earnings-hero{
  background:var(--surface);border:1px solid var(--border);border-radius:4px;
  padding:1.5rem 2rem;margin-bottom:1.5rem;
  display:flex;align-items:center;gap:2rem;
  border-left:4px solid var(--success);
  position:relative;overflow:hidden;
}
.earnings-hero::before{
  content:'$';position:absolute;right:1.5rem;top:50%;transform:translateY(-50%);
  font-family:'Bebas Neue',sans-serif;font-size:8rem;color:rgba(76,175,125,.06);
  line-height:1;pointer-events:none;
}
.hero-label{font-size:0.65rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);font-family:'IBM Plex Mono',monospace;margin-bottom:4px;}
.hero-amount{font-family:'Bebas Neue',sans-serif;font-size:3.5rem;color:var(--success);letter-spacing:2px;line-height:1;}
.hero-sub{font-size:0.72rem;color:var(--muted);font-family:'IBM Plex Mono',monospace;margin-top:4px;}
.hero-divider{width:1px;height:80px;background:var(--border);flex-shrink:0;}
.hero-stat{text-align:center;}
.hero-stat-val{font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--text);letter-spacing:2px;}
.hero-stat-lbl{font-size:0.62rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);font-family:'IBM Plex Mono',monospace;margin-top:2px;}

/* Quick entry panel */
.qentry-panel{background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:1.25rem;margin-bottom:1.5rem;}
.qentry-title{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;color:var(--accent);margin-bottom:1rem;display:flex;align-items:center;gap:8px;}
.qentry-grid{display:grid;grid-template-columns:160px 130px 150px 150px 110px 120px 120px 140px auto;gap:10px;align-items:end;}
.qentry-grid .form-group{margin-bottom:0;}
.btn-add-entry{background:var(--success);border:none;color:#000;padding:9px 20px;cursor:pointer;border-radius:2px;font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;transition:all .15s;white-space:nowrap;height:38px;}
.btn-add-entry:hover{background:#3d9e6a;transform:translateY(-1px);}

/* broker sections */
.broker-section{margin-bottom:1.25rem;}
.broker-header{
  display:flex;align-items:center;gap:10px;padding:.875rem 1.25rem;
  background:var(--surface);border:1px solid var(--border);
  border-left:4px solid var(--accent);border-radius:3px 3px 0 0;
  cursor:pointer;user-select:none;transition:background .15s;
}
.broker-header:hover{background:var(--surface2);}
.broker-name{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;}
.broker-total{margin-left:auto;font-family:'Bebas Neue',sans-serif;font-size:1.3rem;color:var(--success);letter-spacing:2px;}
.broker-count{font-family:'IBM Plex Mono',monospace;font-size:0.7rem;color:var(--muted);}
.broker-body{background:var(--surface);border:1px solid var(--border);border-top:none;border-radius:0 0 3px 3px;overflow:hidden;}
.broker-collapsed .broker-body{display:none;}
.collapse-icon{font-size:0.65rem;color:var(--muted);transition:transform .2s;}
.broker-collapsed .collapse-icon{transform:rotate(-90deg);}

/* Progress bar */
.progress-bar-wrap{height:4px;background:var(--surface3);border-radius:2px;margin-top:8px;overflow:hidden;}
.progress-bar{height:100%;background:var(--success);border-radius:2px;transition:width .4s ease;}

/* Earnings summary footer */
.earnings-footer{
  background:var(--surface);border:1px solid var(--border);border-radius:3px;
  padding:1.25rem 1.5rem;margin-top:1.25rem;
  display:flex;align-items:center;gap:1.5rem;flex-wrap:wrap;
  border-top:2px solid var(--success);
}
.ef-item{text-align:center;}
.ef-label{font-size:0.62rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);font-family:'IBM Plex Mono',monospace;}
.ef-value{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;color:var(--success);letter-spacing:2px;}

/* Autofill indicator */
.autofill-indicator{
  display:flex;align-items:center;gap:6px;padding:5px 10px;
  background:rgba(76,175,125,.08);border:1px solid rgba(76,175,125,.2);
  border-radius:2px;font-size:0.68rem;font-family:'IBM Plex Mono',monospace;
  color:var(--success);margin-top:4px;
}
/* ── CLOSING PAGE ── */
.cl-status-bar{
  display:flex;align-items:center;gap:1rem;padding:1rem 1.5rem;
  background:var(--surface);border:1px solid var(--border);border-radius:3px;
  margin-bottom:1.5rem;flex-wrap:wrap;
}
.cl-status-pill{
  display:inline-flex;align-items:center;gap:6px;padding:5px 14px;
  border-radius:20px;font-family:'IBM Plex Mono',monospace;font-size:0.7rem;
  letter-spacing:1px;text-transform:uppercase;font-weight:600;
  border:1px solid transparent;cursor:default;
}
.cl-pill-open{background:rgba(245,166,35,.12);color:var(--accent);border-color:rgba(245,166,35,.3);}
.cl-pill-partial{background:rgba(74,159,207,.12);color:var(--info);border-color:rgba(74,159,207,.3);}
.cl-pill-closed{background:rgba(76,175,125,.12);color:var(--success);border-color:rgba(76,175,125,.3);}
.cl-pill-disputed{background:rgba(224,82,82,.12);color:var(--danger);border-color:rgba(224,82,82,.3);}

/* Broker closing card */
.cl-broker-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:4px;margin-bottom:1.25rem;overflow:hidden;
}
.cl-broker-head{
  display:grid;grid-template-columns:auto 1fr auto auto auto auto;
  align-items:center;gap:1rem;padding:1rem 1.5rem;
  background:var(--surface2);border-bottom:1px solid var(--border);
}
.cl-broker-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0;}
.cl-broker-title{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;}
.cl-col-head{font-family:'IBM Plex Mono',monospace;font-size:0.6rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);text-align:right;}
.cl-col-val{font-family:'Bebas Neue',sans-serif;font-size:1.25rem;letter-spacing:1px;text-align:right;}

/* Ticket checklist row */
.cl-ticket-row{
  display:grid;
  grid-template-columns:36px 90px 100px 1fr 110px 110px 110px 100px 80px;
  align-items:center;gap:8px;
  padding:9px 1.5rem;border-bottom:1px solid rgba(255,255,255,.03);
  transition:background .12s;
}
.cl-ticket-row:last-child{border-bottom:none;}
.cl-ticket-row:hover{background:rgba(255,255,255,.02);}
.cl-ticket-row.confirmed{background:rgba(76,175,125,.04);}
.cl-ticket-row.disputed{background:rgba(224,82,82,.04);}
.cl-ticket-row.missing{background:rgba(245,166,35,.04);}

/* Custom checkbox */
.cl-check{
  width:22px;height:22px;border-radius:3px;border:2px solid var(--border);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .15s;flex-shrink:0;background:var(--surface2);
}
.cl-check:hover{border-color:var(--success);}
.cl-check.checked{background:var(--success);border-color:var(--success);color:#000;font-size:0.85rem;}
.cl-check.disputed-chk{background:var(--danger);border-color:var(--danger);color:#fff;font-size:0.75rem;}

/* Inline price input */
.cl-price-input{
  background:var(--surface3);border:1px solid var(--border);color:var(--text);
  padding:5px 8px;border-radius:2px;font-family:'IBM Plex Mono',monospace;
  font-size:0.8rem;text-align:right;outline:none;width:100%;
  transition:border-color .15s;
}
.cl-price-input:focus{border-color:var(--accent);}
.cl-price-input.over{border-color:var(--success);color:var(--success);}
.cl-price-input.under{border-color:var(--danger);color:var(--danger);}

/* Diff badge */
.diff-badge{
  font-family:'IBM Plex Mono',monospace;font-size:0.72rem;font-weight:600;
  padding:3px 8px;border-radius:2px;text-align:right;white-space:nowrap;
}
.diff-pos{background:rgba(76,175,125,.15);color:var(--success);}
.diff-neg{background:rgba(224,82,82,.15);color:var(--danger);}
.diff-zero{background:rgba(255,255,255,.05);color:var(--muted);}

/* Closing footer card */
.cl-summary-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:4px;padding:1.5rem;margin-bottom:1.5rem;
}
.cl-summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.25rem;}
.cl-sum-box{
  background:var(--surface2);border:1px solid var(--border);
  padding:1rem 1.25rem;border-radius:3px;border-left:3px solid var(--border);
}
.cl-sum-label{font-size:0.62rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);font-family:'IBM Plex Mono',monospace;margin-bottom:4px;}
.cl-sum-val{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:2px;}

.btn-close-week{
  display:flex;align-items:center;justify-content:center;gap:10px;
  width:100%;padding:16px;background:var(--success);border:none;color:#000;
  font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:4px;
  cursor:pointer;border-radius:3px;transition:all .2s;
}
.btn-close-week:hover{background:#3d9e6a;transform:translateY(-2px);box-shadow:0 8px 24px rgba(76,175,125,.3);}
.btn-close-week:active{transform:translateY(0);}
.btn-close-week:disabled{background:var(--surface3);color:var(--muted);cursor:not-allowed;transform:none;box-shadow:none;}
.btn-reopen{
  width:100%;padding:10px;background:transparent;border:1px solid var(--border);
  color:var(--muted);font-family:'IBM Plex Mono',monospace;font-size:0.72rem;
  letter-spacing:1px;text-transform:uppercase;cursor:pointer;border-radius:2px;
  transition:all .15s;margin-top:8px;
}
.btn-reopen:hover{border-color:var(--accent);color:var(--accent);}

/* CLOSED overlay banner */
.cl-closed-banner{
  background:rgba(76,175,125,.08);border:1px solid rgba(76,175,125,.3);
  border-radius:3px;padding:1rem 1.5rem;margin-bottom:1.25rem;
  display:flex;align-items:center;gap:12px;
}
.cl-closed-banner h3{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:2px;color:var(--success);}

/* Ticket row col headers */
.cl-col-headers{
  display:grid;
  grid-template-columns:36px 90px 100px 1fr 110px 110px 110px 100px 80px;
  gap:8px;padding:6px 1.5rem;background:var(--surface2);
  border-bottom:1px solid var(--border);
}
.cl-col-headers span{font-family:'IBM Plex Mono',monospace;font-size:0.6rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);}

/* Missing ticket row */
.cl-missing-row{
  display:flex;align-items:center;gap:10px;padding:8px 1.5rem;
  background:rgba(245,166,35,.05);border-bottom:1px solid rgba(245,166,35,.08);
  font-size:0.78rem;
}

/* Notes input */
.cl-notes{
  background:var(--surface3);border:1px solid var(--border);color:var(--text);
  padding:6px 10px;border-radius:2px;font-family:'IBM Plex Sans',sans-serif;
  font-size:0.8rem;outline:none;resize:none;width:100%;transition:border-color .15s;
}
.cl-notes:focus{border-color:var(--accent);}

/* Dispute badge */
.dispute-btn{
  background:transparent;border:1px solid var(--border);color:var(--muted);
  cursor:pointer;padding:3px 7px;border-radius:2px;font-size:0.65rem;
  font-family:'IBM Plex Mono',monospace;transition:all .15s;
}
.dispute-btn:hover{border-color:var(--danger);color:var(--danger);}
.dispute-btn.active-dispute{background:rgba(224,82,82,.15);border-color:var(--danger);color:var(--danger);}

/* ── PDF READER ── */
.pdf-reader-panel{
  background:var(--surface);border:1px solid var(--border);border-radius:4px;
  margin-bottom:1.5rem;overflow:hidden;
  border-top:3px solid var(--info);
}
.pdf-reader-header{
  display:flex;align-items:center;gap:12px;padding:1rem 1.5rem;
  background:var(--surface2);border-bottom:1px solid var(--border);
  cursor:pointer;user-select:none;
}
.pdf-reader-header h3{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:3px;color:var(--info);}
.pdf-reader-body{padding:1.25rem 1.5rem;}

.drop-zone{
  border:2px dashed var(--border);border-radius:4px;padding:2.5rem 1.5rem;
  text-align:center;cursor:pointer;transition:all .2s;position:relative;
  background:var(--surface2);
}
.drop-zone:hover,.drop-zone.drag-over{border-color:var(--info);background:rgba(74,159,207,.06);}
.drop-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.drop-zone-icon{font-size:2.5rem;margin-bottom:.75rem;opacity:.5;}
.drop-zone-title{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;color:var(--label);margin-bottom:4px;}
.drop-zone-sub{font-size:0.7rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);}
.drop-zone.has-file{border-color:var(--info);border-style:solid;background:rgba(74,159,207,.05);}
.drop-zone.has-file .drop-zone-icon{opacity:1;}

/* Progress stages */
.ai-progress-wrap{margin:1.25rem 0;display:none;}
.ai-progress-label{display:flex;justify-content:space-between;margin-bottom:6px;}
.ai-progress-title{font-family:'IBM Plex Mono',monospace;font-size:0.72rem;color:var(--info);letter-spacing:1px;}
.ai-progress-pct{font-family:'Bebas Neue',sans-serif;font-size:0.9rem;color:var(--info);letter-spacing:2px;}
.ai-progress-bar-outer{height:8px;background:var(--surface3);border-radius:4px;overflow:hidden;position:relative;}
.ai-progress-bar-inner{
  height:100%;border-radius:4px;transition:width .4s ease;
  background:linear-gradient(90deg,var(--info),#7adcf5);
  position:relative;overflow:hidden;
}
.ai-progress-bar-inner::after{
  content:'';position:absolute;inset:0;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);
  animation:shimmer 1.2s infinite;
}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

.ai-stages{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;}
.ai-stage{
  display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:12px;
  font-family:'IBM Plex Mono',monospace;font-size:0.62rem;letter-spacing:1px;
  border:1px solid var(--border);color:var(--muted);transition:all .3s;
}
.ai-stage.active{background:rgba(74,159,207,.15);border-color:var(--info);color:var(--info);}
.ai-stage.done{background:rgba(76,175,125,.1);border-color:var(--success);color:var(--success);}
.ai-stage.error{background:rgba(224,82,82,.1);border-color:var(--danger);color:var(--danger);}
.ai-stage-dot{width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0;}
.ai-stage.active .ai-stage-dot{animation:pulse-dot .8s infinite;}
@keyframes pulse-dot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.7)}}

/* Results panel */
.ai-results{margin-top:1.25rem;display:none;}
.ai-results-header{
  display:flex;align-items:center;gap:10px;padding:.75rem 1rem;
  background:var(--surface2);border:1px solid var(--border);border-bottom:none;border-radius:3px 3px 0 0;
}
.ai-results-title{font-family:'Bebas Neue',sans-serif;font-size:0.9rem;letter-spacing:2px;}
.ai-results-stats{display:flex;gap:12px;margin-left:auto;flex-wrap:wrap;}
.ai-stat-chip{
  padding:3px 10px;border-radius:12px;font-family:'IBM Plex Mono',monospace;
  font-size:0.65rem;letter-spacing:1px;font-weight:600;
}

.ai-row{
  display:grid;grid-template-columns:90px 80px 110px 110px 100px 1fr auto;
  gap:8px;align-items:center;padding:9px 1rem;
  border:1px solid var(--border);border-top:none;transition:background .12s;
}
.ai-row:hover{background:var(--surface2);}
.ai-row.ai-match{background:rgba(76,175,125,.04);}
.ai-row.ai-diff{background:rgba(245,166,35,.04);}
.ai-row.ai-missing{background:rgba(224,82,82,.04);}
.ai-row.ai-extra{background:rgba(74,159,207,.04);}
.ai-row-header{background:var(--surface2)!important;border-radius:0;}

.ai-match-badge{
  display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;
  font-family:'IBM Plex Mono',monospace;font-size:0.62rem;font-weight:600;letter-spacing:.5px;
  white-space:nowrap;
}
.badge-match{background:rgba(76,175,125,.15);color:var(--success);border:1px solid rgba(76,175,125,.3);}
.badge-diff{background:rgba(245,166,35,.15);color:var(--accent);border:1px solid rgba(245,166,35,.3);}
.badge-missing{background:rgba(224,82,82,.15);color:var(--danger);border:1px solid rgba(224,82,82,.3);}
.badge-extra{background:rgba(74,159,207,.15);color:var(--info);border:1px solid rgba(74,159,207,.3);}

.btn-apply-row{
  background:var(--success);border:none;color:#000;padding:4px 10px;
  border-radius:2px;font-family:'IBM Plex Mono',monospace;font-size:0.65rem;
  cursor:pointer;transition:all .15s;white-space:nowrap;
}
.btn-apply-row:hover{background:#3d9e6a;}
.btn-apply-all{
  display:flex;align-items:center;justify-content:center;gap:8px;
  width:100%;padding:10px;background:var(--success);border:none;color:#000;
  font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:3px;
  cursor:pointer;border-radius:0 0 3px 3px;transition:all .15s;
  border-top:1px solid rgba(76,175,125,.3);
}
.btn-apply-all:hover{background:#3d9e6a;}
.btn-apply-all:disabled{background:var(--surface3);color:var(--muted);cursor:not-allowed;}

/* Raw text display */
.ai-raw-text{
  background:var(--surface3);border:1px solid var(--border);border-radius:2px;
  padding:.75rem 1rem;font-family:'IBM Plex Mono',monospace;font-size:0.68rem;
  color:var(--muted);white-space:pre-wrap;max-height:120px;overflow-y:auto;
  margin-top:.75rem;line-height:1.6;
}
.ai-broker-selector{margin-bottom:1rem;}

/* ── GASTOS ── */
.exp-cat-pill{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:12px;font-size:0.65rem;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:1px;font-weight:600;}
.exp-row-amount{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;color:var(--danger);letter-spacing:1px;}
.cat-bar-wrap{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.cat-bar{height:6px;border-radius:3px;transition:width .4s;}
.cat-label{font-size:0.72rem;font-family:'IBM Plex Mono',monospace;color:var(--label);min-width:90px;}
.cat-amount{font-size:0.72rem;font-family:'IBM Plex Mono',monospace;color:var(--text);margin-left:auto;min-width:70px;text-align:right;}

/* ── P&L ── */
.pl-hero{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.5rem;}
.pl-card{background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:1.25rem 1.5rem;position:relative;overflow:hidden;}
.pl-card-icon{position:absolute;right:1rem;top:50%;transform:translateY(-50%);font-size:3.5rem;opacity:.06;}
.pl-label{font-size:0.62rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);font-family:'IBM Plex Mono',monospace;margin-bottom:6px;}
.pl-val{font-family:'Bebas Neue',sans-serif;font-size:2.2rem;letter-spacing:2px;line-height:1;}
.pl-sub{font-size:0.68rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);margin-top:4px;}
.pl-table-section{background:var(--surface);border:1px solid var(--border);border-radius:3px;margin-bottom:1rem;overflow:hidden;}
.pl-section-hdr{background:var(--surface2);padding:.75rem 1.25rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;font-family:'Bebas Neue',sans-serif;font-size:0.9rem;letter-spacing:2px;}
.chart-container{padding:1.25rem;background:var(--surface);border:1px solid var(--border);border-radius:3px;margin-bottom:1rem;}
.bar-chart{display:flex;align-items:flex-end;gap:6px;height:120px;padding:0 4px;}
.bar-col{display:flex;flex-direction:column;align-items:center;flex:1;gap:4px;}
.bar-col-inner{width:100%;border-radius:2px 2px 0 0;transition:height .4s;min-height:2px;cursor:default;}
.bar-lbl{font-size:0.58rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);text-align:center;white-space:nowrap;}
.bar-amt{font-size:0.6rem;font-family:'IBM Plex Mono',monospace;color:var(--label);text-align:center;}

/* ── BROKER REPORT ── */
.br-report-card{background:var(--surface);border:1px solid var(--border);border-radius:3px;margin-bottom:1rem;overflow:hidden;}
.br-report-hdr{display:flex;align-items:center;gap:12px;padding:1rem 1.5rem;background:var(--surface2);border-bottom:1px solid var(--border);}
.br-report-name{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;}
.br-stat{text-align:center;min-width:80px;}
.br-stat-val{font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:1px;}
.br-stat-lbl{font-size:0.58rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
.br-divider{width:1px;height:40px;background:var(--border);}
.br-spark{display:flex;align-items:flex-end;gap:3px;height:32px;}
.br-spark-bar{width:8px;border-radius:1px 1px 0 0;min-height:2px;transition:height .3s;}

/* ── ALERTAS ── */
.alert-card{display:flex;align-items:center;gap:14px;padding:1rem 1.5rem;background:var(--surface);border:1px solid var(--border);border-radius:3px;margin-bottom:8px;transition:background .15s;}
.alert-card:hover{background:var(--surface2);}
.alert-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
.alert-title{font-weight:600;font-size:0.85rem;margin-bottom:2px;}
.alert-sub{font-size:0.72rem;color:var(--muted);font-family:'IBM Plex Mono',monospace;}
.alert-days{font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:2px;text-align:right;margin-left:auto;}
.alert-days-lbl{font-size:0.6rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);text-align:right;margin-top:1px;}
.alert-section-title{font-family:'Bebas Neue',sans-serif;font-size:0.9rem;letter-spacing:3px;color:var(--muted);padding:.5rem 0;margin-bottom:6px;border-bottom:1px solid var(--border);}
.alert-empty{text-align:center;padding:2rem;color:var(--muted);font-family:'IBM Plex Mono',monospace;font-size:0.72rem;text-transform:uppercase;letter-spacing:1px;}
/* ── SETTINGS ── */
.settings-section{background:var(--surface);border:1px solid var(--border);border-radius:4px;margin-bottom:1.5rem;overflow:hidden;}
.settings-section-hdr{display:flex;align-items:center;gap:12px;padding:1rem 1.5rem;background:var(--surface2);border-bottom:1px solid var(--border);}
.settings-section-hdr h3{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:3px;color:var(--accent);}
.settings-section-hdr p{font-size:0.65rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);margin-left:auto;}
.settings-body{padding:1.5rem;display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
.settings-body.single{grid-template-columns:1fr;}
.settings-body.three{grid-template-columns:1fr 1fr 1fr;}
.settings-save-btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:11px;background:var(--accent);border:none;color:#000;font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:3px;cursor:pointer;transition:all .15s;border-radius:2px;margin-top:.5rem;}
.settings-save-btn:hover{background:var(--accent-hover);}
.company-preview{border:1px solid var(--border);border-radius:3px;padding:1.25rem 1.5rem;background:var(--surface2);}
.company-logo-box{width:80px;height:80px;border:2px dashed var(--border);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:2rem;cursor:pointer;transition:all .15s;overflow:hidden;background:var(--surface3);}
.company-logo-box:hover{border-color:var(--accent);}
.company-logo-box img{width:100%;height:100%;object-fit:contain;}
.data-danger-zone{background:rgba(224,82,82,.05);border:1px solid rgba(224,82,82,.25);border-radius:3px;padding:1.25rem 1.5rem;}
.data-danger-zone h4{color:var(--danger);font-family:'Bebas Neue',sans-serif;font-size:0.9rem;letter-spacing:2px;margin-bottom:.75rem;}
.backup-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border:1px solid var(--border);background:var(--surface2);color:var(--label);border-radius:2px;font-family:'IBM Plex Mono',monospace;font-size:0.72rem;cursor:pointer;transition:all .15s;margin-right:8px;margin-bottom:8px;}
.backup-btn:hover{border-color:var(--accent);color:var(--accent);}
.backup-btn.danger:hover{border-color:var(--danger);color:var(--danger);}

/* ==== AUTO-AJUSTE GLOBAL MONITORES ==== */
html,body{width:100%;max-width:100%;}
nav::-webkit-scrollbar{display:none;}
.logo{flex-shrink:0;}
.user-pill{max-width:100%;}

.container{
  width:100%;
  max-width:min(1800px, 100vw);
  padding:clamp(.85rem, 1.6vw, 1.75rem);
}

.card,.settings-section,.pl-card,.pl-table-section,.br-report-card,.broker-body{
  max-width:100%;
}

.tbl-wrap,.broker-table-wrap,.table-wrap,.table-scroll{
  width:100%;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
}

input,select,textarea,button{
  max-width:100%;
}

.login-overlay{
  padding:clamp(12px, 3vw, 28px);
}

.login-box{
  width:min(460px, 96vw);
  max-width:96vw;
}

@media (min-width: 1600px){
  body{font-size:16px;}
  .container{max-width:1900px;}
}

@media (max-width: 1200px){
  .qentry-grid{
    grid-template-columns:repeat(2,minmax(180px,1fr));
  }
  .settings-body{
    grid-template-columns:1fr;
  }
  .cl-summary-grid{
    grid-template-columns:repeat(2,1fr);
  }
  .pl-hero{
    grid-template-columns:1fr;
  }
}

@media (max-width: 900px){
  header{
    padding:.6rem .875rem;
    gap:.5rem;
    align-items:center;
  }
  nav{
    order:3;
    width:100%;
    overflow:visible;
    padding-bottom:2px;
    flex-wrap:wrap;
    flex:unset;
  }
  .header-right{
    margin-left:auto;
  }
  .user-pill{
    max-width:160px;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .main-grid{
    grid-template-columns:1fr !important;
    gap:1rem;
  }
  .form-row,.form-row-3,.three{
    grid-template-columns:1fr !important;
  }
  .qentry-grid{
    grid-template-columns:1fr;
    gap:8px;
  }
  .cl-broker-head{
    grid-template-columns:1fr;
    gap:8px;
  }
  .ai-row{
    grid-template-columns:1fr;
  }
  .cl-ticket-row,.cl-col-headers{
    min-width:860px;
  }
}

@media (max-width: 640px){
  .container{padding:.75rem;}
  .stats-grid{
    grid-template-columns:1fr !important;
  }
  .cl-summary-grid{
    grid-template-columns:1fr;
  }
  .login-box-hdr{
    padding:.8rem 1rem;
  }
  .login-box-body{
    padding:1rem;
  }
}

</style>
</head>
<body>

<header>
  <div class="logo">🚛 <em>Dump</em>Track</div>
  <nav>
    <button class="nav-btn active" onclick="showPage('tickets',this)">🎫 Tickets</button>
    <button class="nav-btn" onclick="showPage('earnings',this)" id="earningsNavBtn">💰 Ganancias</button>
    <button class="nav-btn" onclick="showPage('closing',this)" id="closingNavBtn">🔒 Cierre</button>
    <button class="nav-btn" onclick="showPage('expenses',this)" id="expensesNavBtn">📉 Gastos</button>
    <button class="nav-btn" onclick="showPage('alerts',this)" id="alertsNavBtn" style="position:relative">
      🔔 Alertas <span id="alertsBadge" style="display:none;position:absolute;top:4px;right:4px;width:8px;height:8px;border-radius:50%;background:var(--danger)"></span>
    </button>

    <div class="dropdown" id="dd_reports">
      <button class="nav-btn" id="reportsBtn" onclick="toggleDropdown('dd_reports')">📊 Reportes <span class="dropdown-arrow">▾</span></button>
      <div class="dropdown-menu">
        <a onclick="showPage('pl',this)"><span class="menu-icon">📈</span> P&L — Pérd. y Ganancias</a>
        <a onclick="showPage('brokerreport',this)"><span class="menu-icon">🤝</span> Reporte por Broker</a>
      </div>
    </div>

    <div class="dropdown" id="dd_registros">
      <button class="nav-btn" id="registrosBtn" onclick="toggleDropdown('dd_registros')">📋 Registros <span class="dropdown-arrow">▾</span></button>
      <div class="dropdown-menu" id="regMenu">
        <a onclick="showPage('trucks',this)">
          <span class="menu-icon">🚛</span> Camiones
          <span class="menu-badge" id="truckMenuBadge">0</span>
        </a>
        <a onclick="showPage('drivers',this)">
          <span class="menu-icon">👤</span> Choferes
          <span class="menu-badge" id="driverMenuBadge">0</span>
        </a>
        <a onclick="showPage('brokers',this)">
          <span class="menu-icon">🤝</span> Brokers
          <span class="menu-badge" id="brokerMenuBadge">0</span>
        </a>
      </div>
    </div>
  </nav>
  <div class="header-right">
    <div class="week-badge" id="headerWeekBadge">SEMANA ACTUAL</div>
    <div class="user-pill" id="userPill">👤 Invitado</div>
    <button class="nav-btn" onclick="openLoginModal()" id="loginNavBtn" style="border-color:var(--border);opacity:.85">🔐 Login</button>
    <div class="dropdown" id="dd_settings">
      <button class="nav-btn" id="settingsNavBtn" onclick="toggleDropdown('dd_settings')" style="border-color:var(--border);opacity:.85">⚙ Settings <span class="dropdown-arrow">▾</span></button>
      <div class="dropdown-menu">
        <a onclick="showPage('settings',this)"><span class="menu-icon">⚙️</span> Configuración</a>
        <a onclick="showPage('settings',this);setTimeout(()=>document.getElementById('usersSettingsSection')?.scrollIntoView({behavior:'smooth',block:'start'}),120)"><span class="menu-icon">👥</span> Registro de Usuarios</a>
      </div>
    </div>
  </div>
</header>

<!-- ═══════════════════════════════════════════════════════
     PAGE: TICKETS
═══════════════════════════════════════════════════════ -->
<div class="page active" id="page-tickets">
<div class="container">
  <!-- PRINT HEADER — oculto en pantalla -->
  <div class="print-company-header" style="display:none">
    <div class="pch-info">
      <div class="pch-name" id="prt_tickets_name">DUMPTRACK PRO</div>
      <div class="pch-sub" id="prt_tickets_sub"></div>
    </div>
    <div class="pch-right">
      <strong>REPORTE DE TICKETS</strong>
      <span id="prt_tickets_week"></span><br>
      <span id="prt_tickets_date"></span>
    </div>
  </div>

  <div class="week-nav">
    <button class="btn-wk" onclick="changeWeek(-1)">◀</button>
    <div class="week-info" id="weekLabel">—</div>
    <button class="btn-wk" onclick="changeWeek(1)">▶</button>
    <h2 id="weekTitle">SEMANA</h2>
    <button class="btn-wk" onclick="goToCurrentWeek()" style="margin-left:8px;border-color:var(--accent);color:var(--accent)">HOY</button>
    <div style="margin-left:auto;display:flex;gap:8px;">
      <button class="btn btn-success-outline btn-sm" onclick="printPage('tickets')">🖨 Imprimir</button>
      <button class="btn btn-outline btn-sm" onclick="exportCSV()">⬇ CSV</button>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card"><div class="stat-label">Tickets</div><div class="stat-value" id="stTickets">0</div><div class="stat-sub">Esta semana</div></div>
    <div class="stat-card"><div class="stat-label">Cant. Total</div><div class="stat-value" id="stLoads">0</div><div class="stat-sub">Cargas / viajes</div></div>
    <div class="stat-card" style="border-left-color:var(--success)"><div class="stat-label">Total Bruto $</div><div class="stat-value" id="stTotal" style="color:var(--success);font-size:1.4rem">$0</div><div class="stat-sub">Antes de descuento</div></div>
    <div class="stat-card" style="border-left-color:var(--danger)"><div class="stat-label">Descuentos $</div><div class="stat-value" id="stDiscount" style="color:var(--danger);font-size:1.4rem">$0</div><div class="stat-sub">Total aplicado</div></div>
    <div class="stat-card" style="border-left-color:var(--accent);border-width:2px"><div class="stat-label">NET $</div><div class="stat-value" id="stNet" style="color:var(--accent);font-size:1.4rem">$0</div><div class="stat-sub">Lo que cobra el broker</div></div>
  </div>

  <div class="main-grid">
    <!-- FORM -->
    <div class="card form-card">
      <div class="card-header"><div class="accent-dot"></div><h3 id="ticketFormTitle">NUEVO TICKET</h3></div>
      <div class="card-body">

        <div class="form-row">
          <div class="form-group"><label>No. Ticket *</label><input type="text" id="t_num" placeholder="T-001"/></div>
          <div class="form-group"><label>Fecha *</label><input type="date" id="t_date"/></div>
        </div>

        <div class="form-row">
          <div class="form-group"><label>Chofer</label>
            <select id="t_driver"><option value="">-- Seleccionar --</option></select>
          </div>
          <div class="form-group"><label>🚛 Camión *</label>
            <select id="t_truck" onchange="onTruckSelect(this)"><option value="">-- Seleccionar --</option></select>
          </div>
        </div>

        <!-- Truck display badge -->
        <div id="t_truckBadge" style="display:none;margin:-4px 0 10px;padding:6px 12px;background:rgba(245,166,35,.1);border:1px solid rgba(245,166,35,.25);border-radius:3px;font-family:'IBM Plex Mono',monospace;font-size:0.72rem;color:var(--accent);display:flex;align-items:center;gap:8px">
          <span style="font-size:1rem">🚛</span>
          <span id="t_truckBadgeText">—</span>
        </div>

        <div class="form-group"><label>Broker</label>
          <select id="t_broker"><option value="">-- Seleccionar --</option></select>
        </div>

        <div class="form-group"><label>🔴 Desde (Pickup) *</label><input type="text" id="t_from" placeholder="Dirección de origen"/></div>
        <div class="route-sep">▼ RUTA</div>
        <div class="form-group"><label>🟢 Hasta (Delivery) *</label><input type="text" id="t_to" placeholder="Dirección de destino"/></div>

        <div class="form-group"><label>Material</label>
          <select id="t_material">
            <option value="">-- Seleccionar --</option>
            <option>Dirt</option><option>Gravel</option><option>Sand</option>
            <option>Concrete</option><option>Asphalt</option><option>Debris</option>
            <option>Fill</option><option>Stone</option><option>Other</option>
          </select>
        </div>

        <!-- PRICING SECTION -->
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:3px;padding:.85rem 1rem;margin-bottom:1rem">
          <div style="font-family:'Bebas Neue',sans-serif;font-size:0.8rem;letter-spacing:2px;color:var(--label);margin-bottom:.75rem">💲 PRECIO & CANTIDADES</div>
          <div class="form-row">
            <div class="form-group" style="margin-bottom:.5rem">
              <label>Cant. (Loads)</label>
              <input type="number" id="t_loads" placeholder="0" min="0" oninput="autoCalcTicket()"/>
            </div>
            <div class="form-group" style="margin-bottom:.5rem">
              <label>Tons</label>
              <input type="number" id="t_tons" placeholder="0.00" min="0" step="0.01" oninput="autoCalcTicket()"/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group" style="margin-bottom:.5rem">
              <label>Precio / Rate ($)</label>
              <input type="number" id="t_rate" placeholder="0.00" min="0" step="0.01" oninput="autoCalcTicket()"/>
            </div>
            <div class="form-group" style="margin-bottom:.5rem">
              <label>Tipo Rate</label>
              <select id="t_rateType" onchange="autoCalcTicket()">
                <option value="ton">Per Ton</option>
                <option value="load">Per Load</option>
                <option value="hour">Per Hour</option>
                <option value="flat">Flat Rate</option>
              </select>
            </div>
          </div>

          <!-- Total -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-top:.25rem">
            <div class="form-group" style="margin-bottom:.25rem">
              <label style="color:var(--success)">Total Bruto $</label>
              <input type="number" id="t_total" placeholder="0.00" min="0" step="0.01" oninput="autoCalcNet()" style="border-color:rgba(76,175,125,.4);background:rgba(76,175,125,.05)"/>
            </div>
            <div class="form-group" style="margin-bottom:.25rem">
              <label style="color:var(--accent);font-weight:700">Net $ (Broker paga)</label>
              <input type="number" id="t_net" placeholder="0.00" min="0" step="0.01" readonly style="border-color:rgba(245,166,35,.5);background:rgba(245,166,35,.06);color:var(--accent);font-weight:600;cursor:default"/>
            </div>
          </div>

          <!-- DISCOUNT CHECKBOX -->
          <div style="margin-top:.75rem;padding:.75rem;background:rgba(224,82,82,.06);border:1px solid rgba(224,82,82,.2);border-radius:3px">
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none">
              <div style="position:relative">
                <input type="checkbox" id="t_hasDiscount" onchange="toggleDiscount()" style="width:18px;height:18px;cursor:pointer;accent-color:var(--danger)"/>
              </div>
              <div>
                <div style="font-weight:600;font-size:0.82rem;color:var(--danger)">⚠ Hay descuento del Broker</div>
                <div style="font-size:0.68rem;font-family:'IBM Plex Mono',monospace;color:var(--muted)">El broker aplica una deducción al Total</div>
              </div>
            </label>
            <!-- Discount fields (hidden by default) -->
            <div id="t_discountFields" style="display:none;margin-top:.75rem;border-top:1px solid rgba(224,82,82,.2);padding-top:.75rem">
              <div class="form-row">
                <div class="form-group" style="margin-bottom:.25rem">
                  <label>Tipo de descuento</label>
                  <select id="t_discountType" onchange="autoCalcNet()">
                    <option value="pct">% Porcentaje</option>
                    <option value="flat">$ Monto fijo</option>
                  </select>
                </div>
                <div class="form-group" style="margin-bottom:.25rem">
                  <label id="t_discountLabel">Descuento (%)</label>
                  <input type="number" id="t_discount" placeholder="0" min="0" step="0.01" oninput="autoCalcNet()" style="border-color:rgba(224,82,82,.4);background:rgba(224,82,82,.05)"/>
                </div>
              </div>
              <div style="display:flex;align-items:center;justify-content:space-between;padding:.5rem .75rem;background:rgba(224,82,82,.1);border-radius:2px;margin-top:.25rem">
                <span style="font-family:'IBM Plex Mono',monospace;font-size:0.72rem;color:var(--muted)">Descuento aplicado:</span>
                <span id="t_discountDisplay" style="font-family:'Bebas Neue',sans-serif;font-size:1.1rem;color:var(--danger);letter-spacing:1px">$0.00</span>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group"><label>Notas</label><textarea id="t_notes" rows="2" placeholder="Observaciones..."></textarea></div>

        <button class="btn btn-primary" id="t_submitBtn" onclick="saveTicket()">GUARDAR TICKET</button>
        <button class="btn btn-secondary" id="t_cancelBtn" style="display:none" onclick="cancelTicketEdit()">CANCELAR EDICIÓN</button>
      </div>
    </div>

    <!-- TABLE -->
    <div class="card">
      <div class="table-toolbar">
        <div class="accent-dot" style="width:7px;height:7px;border-radius:50%;background:var(--accent)"></div>
        <h3>TICKETS DE LA SEMANA</h3>
        <span class="count-badge" id="t_countBadge">0</span>
        <input type="text" class="search-input" id="t_search" placeholder="Buscar..." oninput="renderTickets()"/>
      </div>
      <div class="tbl-wrap">
        <table>
          <thead><tr>
            <th>Ticket</th><th>Fecha</th><th>Chofer / Truck</th>
            <th>Broker</th><th>Material</th><th>Cant</th><th>Precio</th><th>Total</th><th>Desc.</th><th>NET</th><th></th>
          </tr></thead>
          <tbody id="t_tbody"></tbody>
          <tfoot id="t_tfoot"></tfoot>
        </table>
      </div>
    </div>
  </div>
</div>
</div>

<!-- ═══════════════════════════════════════════════════════
     PAGE: TRUCKS
═══════════════════════════════════════════════════════ -->
<div class="page" id="page-trucks">
<div class="container">
  <div class="print-company-header" style="display:none">
    <div class="pch-info">
      <div class="pch-name" id="prt_trucks_name">DUMPTRACK PRO</div>
      <div class="pch-sub" id="prt_trucks_sub"></div>
    </div>
    <div class="pch-right"><strong>REGISTRO DE CAMIONES</strong><br><span id="prt_trucks_date"></span></div>
  </div>
  <div class="section-header">
    <div class="section-icon">🚛</div>
    <div class="section-title"><h1>CAMIONES</h1><p>Registro y gestión de flota</p></div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button class="btn btn-success-outline btn-sm" onclick="printPage('trucks')">🖨 Imprimir</button>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card" style="border-left-color:var(--info)"><div class="stat-label">Total Flota</div><div class="stat-value" id="tk_statTotal" style="color:var(--info)">0</div><div class="stat-sub">Unidades registradas</div></div>
    <div class="stat-card" style="border-left-color:var(--success)"><div class="stat-label">Activos</div><div class="stat-value" id="tk_statActive" style="color:var(--success)">0</div><div class="stat-sub">En servicio</div></div>
    <div class="stat-card" style="border-left-color:var(--danger)"><div class="stat-label">Inactivos</div><div class="stat-value" id="tk_statInactive" style="color:var(--danger)">0</div><div class="stat-sub">Fuera de servicio</div></div>
    <div class="stat-card" style="border-left-color:var(--accent)"><div class="stat-label">En Mantenimiento</div><div class="stat-value" id="tk_statMaint" style="color:var(--accent)">0</div><div class="stat-sub">En taller</div></div>
  </div>

  <div class="main-grid">
    <div class="card">
      <div class="card-header"><div class="accent-dot"></div><h3 id="truckFormTitle">NUEVO CAMIÓN</h3></div>
      <div class="card-body">
        <div class="form-row">
          <div class="form-group"><label>No. Unidad *</label><input type="text" id="tk_num" placeholder="TRK-001"/></div>
          <div class="form-group"><label>Año *</label><input type="number" id="tk_year" placeholder="2020" min="1990" max="2030"/></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Marca *</label><input type="text" id="tk_make" placeholder="Kenworth, Peterbilt..."/></div>
          <div class="form-group"><label>Modelo</label><input type="text" id="tk_model" placeholder="T800, 379..."/></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Color</label><input type="text" id="tk_color" placeholder="Negro, Blanco..."/></div>
          <div class="form-group"><label>Tipo de Truck</label>
            <select id="tk_type">
              <option value="dump">Dump Truck</option>
              <option value="semi">Semi-Truck</option>
              <option value="tandem">Tandem</option>
              <option value="triaxle">Tri-Axle</option>
              <option value="quad">Quad Axle</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Placa (Tag)</label><input type="text" id="tk_plate" placeholder="ABC-1234"/></div>
          <div class="form-group"><label>Estado</label>
            <select id="tk_state">
              <option value="FL">FL</option><option value="TX">TX</option><option value="GA">GA</option>
              <option value="NC">NC</option><option value="CA">CA</option><option value="NY">NY</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>VIN</label><input type="text" id="tk_vin" placeholder="1HTMKABL..." maxlength="17"/></div>
          <div class="form-group"><label>GVWR (lbs)</label><input type="number" id="tk_gvwr" placeholder="80000"/></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Payload (tons)</label><input type="number" id="tk_payload" placeholder="15" step="0.5"/></div>
          <div class="form-group"><label>Capacidad (yds)</label><input type="number" id="tk_capacity" placeholder="14" step="0.5"/></div>
        </div>
        <div class="form-group"><label>Vencimiento Seguro</label><input type="date" id="tk_insurance"/></div>
        <div class="form-group"><label>Vencimiento Inspección DOT</label><input type="date" id="tk_dot"/></div>
        <div class="form-group"><label>Estado del Camión</label>
          <select id="tk_status">
            <option value="active">✅ Activo</option>
            <option value="maintenance">🔧 En Mantenimiento</option>
            <option value="inactive">❌ Inactivo</option>
          </select>
        </div>
        <div class="form-group"><label>Notas</label><textarea id="tk_notes" rows="2" placeholder="Observaciones..."></textarea></div>
        <button class="btn btn-primary" id="tk_submitBtn" onclick="saveTruck()">GUARDAR CAMIÓN</button>
        <button class="btn btn-secondary" id="tk_cancelBtn" style="display:none" onclick="cancelTruckEdit()">CANCELAR EDICIÓN</button>
      </div>
    </div>

    <div class="card">
      <div class="table-toolbar">
        <div class="accent-dot" style="width:7px;height:7px;border-radius:50%;background:var(--info)"></div>
        <h3>FLOTA</h3>
        <span class="count-badge" style="background:var(--info)" id="tk_countBadge">0</span>
        <input type="text" class="search-input" id="tk_search" placeholder="Buscar..." oninput="renderTrucks()"/>
      </div>
      <div class="tbl-wrap">
        <table>
          <thead><tr>
            <th>Unidad</th><th>Año / Marca</th><th>Tipo</th><th>Placa</th>
            <th>Payload</th><th>Seguro</th><th>DOT</th><th>Estado</th><th></th>
          </tr></thead>
          <tbody id="tk_tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
</div>

<!-- ═══════════════════════════════════════════════════════
     PAGE: DRIVERS
═══════════════════════════════════════════════════════ -->
<div class="page" id="page-drivers">
<div class="container">
  <div class="print-company-header" style="display:none">
    <div class="pch-info">
      <div class="pch-name" id="prt_drivers_name">DUMPTRACK PRO</div>
      <div class="pch-sub" id="prt_drivers_sub"></div>
    </div>
    <div class="pch-right"><strong>REGISTRO DE CHOFERES</strong><br><span id="prt_drivers_date"></span></div>
  </div>
  <div class="section-header">
    <div class="section-icon">👤</div>
    <div class="section-title"><h1>CHOFERES</h1><p>Registro de conductores</p></div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button class="btn btn-success-outline btn-sm" onclick="printPage('drivers')">🖨 Imprimir</button>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card" style="border-left-color:var(--purple)"><div class="stat-label">Total</div><div class="stat-value" id="dr_statTotal" style="color:var(--purple)">0</div><div class="stat-sub">Choferes registrados</div></div>
    <div class="stat-card" style="border-left-color:var(--success)"><div class="stat-label">Activos</div><div class="stat-value" id="dr_statActive" style="color:var(--success)">0</div><div class="stat-sub">En servicio</div></div>
    <div class="stat-card" style="border-left-color:var(--accent)"><div class="stat-label">CDL-A</div><div class="stat-value" id="dr_statCDLA" style="color:var(--accent)">0</div><div class="stat-sub">Licencia clase A</div></div>
    <div class="stat-card" style="border-left-color:var(--info)"><div class="stat-label">CDL-B</div><div class="stat-value" id="dr_statCDLB" style="color:var(--info)">0</div><div class="stat-sub">Licencia clase B</div></div>
  </div>

  <div class="main-grid">
    <div class="card">
      <div class="card-header"><div class="accent-dot" style="background:var(--purple)"></div><h3 id="driverFormTitle">NUEVO CHOFER</h3></div>
      <div class="card-body">
        <div class="form-row">
          <div class="form-group"><label>Nombre *</label><input type="text" id="dr_first" placeholder="First Name"/></div>
          <div class="form-group"><label>Apellido *</label><input type="text" id="dr_last" placeholder="Last Name"/></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Teléfono</label><input type="tel" id="dr_phone" placeholder="(555) 000-0000"/></div>
          <div class="form-group"><label>Email</label><input type="email" id="dr_email" placeholder="driver@email.com"/></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Licencia (CDL #)</label><input type="text" id="dr_cdl" placeholder="CDL Number"/></div>
          <div class="form-group"><label>Clase CDL</label>
            <select id="dr_cdlClass">
              <option value="A">Class A</option>
              <option value="B">Class B</option>
              <option value="C">Class C</option>
              <option value="none">No CDL</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Venc. Licencia</label><input type="date" id="dr_cdlExp"/></div>
          <div class="form-group"><label>Estado Licencia</label>
            <select id="dr_cdlState">
              <option value="FL">FL</option><option value="TX">TX</option><option value="GA">GA</option>
              <option value="NC">NC</option><option value="CA">CA</option><option value="NY">NY</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Venc. Medical Card</label><input type="date" id="dr_medical"/></div>
          <div class="form-group"><label>Camión Asignado</label>
            <select id="dr_assignedTruck"><option value="">-- Ninguno --</option></select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Pay Rate ($)</label><input type="number" id="dr_payRate" placeholder="0.00" step="0.01"/></div>
          <div class="form-group"><label>Tipo Pay</label>
            <select id="dr_payType">
              <option value="ton">Per Ton</option>
              <option value="load">Per Load</option>
              <option value="hour">Per Hour</option>
              <option value="salary">Salary</option>
            </select>
          </div>
        </div>
        <div class="form-group"><label>Estado</label>
          <select id="dr_status">
            <option value="active">✅ Activo</option>
            <option value="inactive">❌ Inactivo</option>
            <option value="vacation">🏖 Vacaciones</option>
          </select>
        </div>
        <div class="form-group"><label>Notas</label><textarea id="dr_notes" rows="2" placeholder="Observaciones..."></textarea></div>
        <button class="btn btn-primary" id="dr_submitBtn" onclick="saveDriver()" style="background:var(--purple)">GUARDAR CHOFER</button>
        <button class="btn btn-secondary" id="dr_cancelBtn" style="display:none" onclick="cancelDriverEdit()">CANCELAR EDICIÓN</button>
      </div>
    </div>

    <div class="card">
      <div class="table-toolbar">
        <div class="accent-dot" style="width:7px;height:7px;border-radius:50%;background:var(--purple)"></div>
        <h3>CHOFERES</h3>
        <span class="count-badge" style="background:var(--purple)" id="dr_countBadge">0</span>
        <input type="text" class="search-input" id="dr_search" placeholder="Buscar..." oninput="renderDrivers()"/>
      </div>
      <div class="tbl-wrap">
        <table>
          <thead><tr>
            <th>Nombre</th><th>Teléfono</th><th>CDL #</th><th>Clase</th>
            <th>Venc. Licencia</th><th>Medical</th><th>Truck</th><th>Pay</th><th>Estado</th><th></th>
          </tr></thead>
          <tbody id="dr_tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
</div>

<!-- ═══════════════════════════════════════════════════════
     PAGE: COMPANIES
═══════════════════════════════════════════════════════ -->
<!-- ═══════════════════════════════════════════════════════
     PAGE: BROKERS
═══════════════════════════════════════════════════════ -->
<div class="page" id="page-brokers">
<div class="container">
  <div class="print-company-header" style="display:none">
    <div class="pch-info">
      <div class="pch-name" id="prt_brokers_name">DUMPTRACK PRO</div>
      <div class="pch-sub" id="prt_brokers_sub"></div>
    </div>
    <div class="pch-right"><strong>REGISTRO DE BROKERS</strong><br><span id="prt_brokers_date"></span></div>
  </div>
  <div class="section-header">
    <div class="section-icon">🤝</div>
    <div class="section-title"><h1>BROKERS</h1><p>Registro de intermediarios y dispatchers</p></div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button class="btn btn-success-outline btn-sm" onclick="printPage('brokers')">🖨 Imprimir</button>
    </div>
  </div>

  <div class="main-grid">
    <div class="card">
      <div class="card-header"><div class="accent-dot" style="background:var(--purple)"></div><h3 id="brokerFormTitle">NUEVO BROKER</h3></div>
      <div class="card-body">
        <div class="form-group"><label>Nombre / Compañía *</label><input type="text" id="br_name" placeholder="Broker o Empresa"/></div>
        <div class="form-row">
          <div class="form-group"><label>Contacto</label><input type="text" id="br_contact" placeholder="Nombre"/></div>
          <div class="form-group"><label>Teléfono</label><input type="tel" id="br_phone" placeholder="(555) 000-0000"/></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Email</label><input type="email" id="br_email" placeholder="broker@email.com"/></div>
          <div class="form-group"><label>WhatsApp</label><input type="tel" id="br_whatsapp" placeholder="(555) 000-0000"/></div>
        </div>
        <div class="form-group"><label>Dirección</label><input type="text" id="br_address" placeholder="Street Address"/></div>
        <div class="form-row">
          <div class="form-group"><label>Ciudad</label><input type="text" id="br_city" placeholder="City"/></div>
          <div class="form-group"><label>Estado</label>
            <select id="br_state">
              <option value="FL">FL</option><option value="TX">TX</option><option value="GA">GA</option>
              <option value="NC">NC</option><option value="CA">CA</option><option value="NY">NY</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Comisión %</label><input type="number" id="br_commission" placeholder="0.00" step="0.01" min="0" max="100"/></div>
          <div class="form-group"><label>Tipo Broker</label>
            <select id="br_type">
              <option value="dispatcher">Dispatcher</option>
              <option value="freight">Freight Broker</option>
              <option value="construction">Construction</option>
              <option value="independent">Independent</option>
              <option value="other">Otro</option>
            </select>
          </div>
        </div>
        <div class="form-group"><label>Áreas de Trabajo</label><input type="text" id="br_areas" placeholder="Miami, Broward, Palm Beach..."/></div>
        <div class="form-group"><label>Estado</label>
          <select id="br_status">
            <option value="active">✅ Activo</option>
            <option value="inactive">❌ Inactivo</option>
          </select>
        </div>
        <div class="form-group"><label>Notas</label><textarea id="br_notes" rows="2" placeholder="Observaciones..."></textarea></div>
        <button class="btn btn-primary" id="br_submitBtn" onclick="saveBroker()">GUARDAR BROKER</button>
        <button class="btn btn-secondary" id="br_cancelBtn" style="display:none" onclick="cancelBrokerEdit()">CANCELAR EDICIÓN</button>
      </div>
    </div>

    <div class="card">
      <div class="table-toolbar">
        <div class="accent-dot" style="width:7px;height:7px;border-radius:50%;background:var(--purple)"></div>
        <h3>BROKERS</h3>
        <span class="count-badge" style="background:var(--purple)" id="br_countBadge">0</span>
        <input type="text" class="search-input" id="br_search" placeholder="Buscar..." oninput="renderBrokers()"/>
      </div>
      <div class="tbl-wrap">
        <table>
          <thead><tr>
            <th>Broker</th><th>Contacto</th><th>Teléfono</th><th>Email</th><th>Tipo</th><th>Comisión</th><th>Áreas</th><th>Estado</th><th></th>
          </tr></thead>
          <tbody id="br_tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
</div>

<!-- ═══════════════════════════════════════════════════════
     PAGE: EARNINGS — Resumen de Ganancias Semanales
═══════════════════════════════════════════════════════ -->
<div class="page" id="page-earnings">
<div class="container">
  <div class="print-company-header" style="display:none">
    <div class="pch-info">
      <div class="pch-name" id="prt_earnings_name">DUMPTRACK PRO</div>
      <div class="pch-sub" id="prt_earnings_sub"></div>
    </div>
    <div class="pch-right">
      <strong>GANANCIAS SEMANALES</strong>
      <span id="prt_earnings_week"></span><br>
      <span id="prt_earnings_date"></span>
    </div>
  </div>

  <!-- Week nav -->
  <div class="week-nav">
    <button class="btn-wk" onclick="changeWeekE(-1)">◀</button>
    <div class="week-info" id="ew_weekLabel">—</div>
    <button class="btn-wk" onclick="changeWeekE(1)">▶</button>
    <h2 id="ew_weekTitle">SEMANA</h2>
    <button class="btn-wk" onclick="goToCurrentWeekE()" style="margin-left:8px;border-color:var(--success);color:var(--success)">HOY</button>
    <div style="margin-left:auto;display:flex;gap:8px;">
      <button class="btn btn-success-outline btn-sm" onclick="exportEarningsCSV()">⬇ CSV</button>
      <button class="btn btn-outline btn-sm" onclick="printPage('earnings')">🖨 Imprimir</button>
    </div>
  </div>

  <!-- HERO totals -->
  <div class="earnings-hero" id="ew_hero">
    <div>
      <div class="hero-label">Ganancias Estimadas</div>
      <div class="hero-amount" id="ew_heroTotal">$0.00</div>
      <div class="hero-sub" id="ew_heroSub">0 tickets · 0 brokers</div>
      <div class="progress-bar-wrap" style="width:280px;margin-top:10px">
        <div class="progress-bar" id="ew_progressBar" style="width:0%"></div>
      </div>
    </div>
    <div class="hero-divider"></div>
    <div class="hero-stat"><div class="hero-stat-val" id="ew_heroCount">0</div><div class="hero-stat-lbl">Tickets</div></div>
    <div class="hero-divider"></div>
    <div class="hero-stat"><div class="hero-stat-val" id="ew_heroTrucks">0</div><div class="hero-stat-lbl">Camiones</div></div>
    <div class="hero-divider"></div>
    <div class="hero-stat"><div class="hero-stat-val" id="ew_heroBrokers">0</div><div class="hero-stat-lbl">Brokers</div></div>
    <div class="hero-divider"></div>
    <div class="hero-stat"><div class="hero-stat-val" id="ew_heroAvg" style="font-size:1.5rem">$0</div><div class="hero-stat-lbl">Promedio/Ticket</div></div>
  </div>

  <!-- QUICK ENTRY FORM -->
  <div class="qentry-panel">
    <div class="qentry-title">
      <span style="font-size:1rem">➕</span> REGISTRAR TICKET RÁPIDO
      <span style="font-size:0.65rem;color:var(--muted);font-family:'IBM Plex Mono',monospace;font-weight:normal;letter-spacing:1px;margin-left:4px">— el camión se llena automático</span>
    </div>
    <div class="qentry-grid">
      <div class="form-group">
        <label>Broker *</label>
        <select id="ew_broker" onchange="autoCalcQuickTotal()"><option value="">-- Broker --</option></select>
      </div>
      <div class="form-group">
        <label>Fecha *</label>
        <input type="date" id="ew_date"/>
      </div>
      <div class="form-group">
        <label>No. Ticket *</label>
        <input type="text" id="ew_ticketNum" placeholder="T-001" oninput="autoFillTruckFromTicket()" autocomplete="off"/>
        <div id="ew_ticketHint" style="display:none" class="autofill-indicator">✓ Ticket encontrado</div>
      </div>
      <div class="form-group">
        <label>🚛 Camión #</label>
        <select id="ew_truck" onchange="syncQuickTruckNum()"><option value="">-- Camión --</option></select>
      </div>
      <div class="form-group">
        <label>Cant.</label>
        <input type="number" id="ew_qty" placeholder="1" min="0" step="0.01" oninput="autoCalcQuickTotal()"/>
      </div>
      <div class="form-group">
        <label>Precio</label>
        <input type="number" id="ew_price" placeholder="$0.00" min="0" step="0.01" oninput="autoCalcQuickTotal()" onkeydown="if(event.key==='Enter')addEarningEntry()"/>
      </div>
      <div class="form-group">
        <label>Total</label>
        <input type="number" id="ew_total" placeholder="$0.00" min="0" step="0.01" oninput="autoCalcQuickNet()"/>
      </div>
      <div class="form-group">
        <label>% Broker</label>
        <input type="number" id="ew_brokerPct" placeholder="0" min="0" max="100" step="0.01" oninput="autoCalcQuickNet()"/>
        <div id="ew_netPreview" class="autofill-indicator" style="display:flex;margin-top:4px">NET: $0.00</div>
      </div>
      <button class="btn-add-entry" onclick="addEarningEntry()">+ AGREGAR</button>
    </div>
    <!-- Autocomplete dropdown -->
    <div id="ew_autocomplete" style="display:none;background:var(--surface2);border:1px solid var(--border);border-top:none;border-radius:0 0 3px 3px;max-height:180px;overflow-y:auto;position:relative;z-index:10;margin-top:-1px;"></div>
  </div>

  <!-- BROKER SECTIONS -->
  <div id="ew_brokerSections"></div>

  <!-- TOTALS FOOTER -->
  <div class="earnings-footer" id="ew_footer" style="display:none">
    <div class="ef-item"><div class="ef-label">Total Ganancia</div><div class="ef-value" id="ew_footTotal">$0</div></div>
    <div style="width:1px;height:40px;background:var(--border);flex-shrink:0"></div>
    <div class="ef-item"><div class="ef-label">Tickets Registrados</div><div class="ef-value" id="ew_footCount">0</div></div>
    <div style="width:1px;height:40px;background:var(--border);flex-shrink:0"></div>
    <div class="ef-item"><div class="ef-label">Promedio por Ticket</div><div class="ef-value" id="ew_footAvg">$0</div></div>
    <div style="width:1px;height:40px;background:var(--border);flex-shrink:0"></div>
    <div class="ef-item"><div class="ef-label">Mejor Broker</div><div class="ef-value" id="ew_footBest" style="font-size:1.1rem;color:var(--accent)">—</div></div>
    <div style="margin-left:auto;text-align:right">
      <div style="font-size:0.62rem;color:var(--muted);font-family:'IBM Plex Mono',monospace;letter-spacing:1px">PROYECCIÓN MENSUAL</div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--accent);letter-spacing:2px" id="ew_monthly">$0</div>
    </div>
  </div>

</div>
</div>

<!-- ═══════════════════════════════════════════════════════
     PAGE: CIERRE DE SEMANA
═══════════════════════════════════════════════════════ -->
<div class="page" id="page-closing">
<div class="container">
  <div class="print-company-header" style="display:none">
    <div class="pch-info">
      <div class="pch-name" id="prt_closing_name">DUMPTRACK PRO</div>
      <div class="pch-sub" id="prt_closing_sub"></div>
    </div>
    <div class="pch-right">
      <strong>CIERRE DE SEMANA</strong>
      <span id="prt_closing_week"></span><br>
      <span id="prt_closing_date"></span>
    </div>
  </div>

  <!-- Week nav -->
  <div class="week-nav">
    <button class="btn-wk" onclick="clChangeWeek(-1)">◀</button>
    <div class="week-info" id="cl_weekLabel">—</div>
    <button class="btn-wk" onclick="clChangeWeek(1)">▶</button>
    <h2 id="cl_weekTitle">SEMANA</h2>
    <button class="btn-wk" onclick="clGoToCurrentWeek()" style="margin-left:8px;border-color:var(--accent);color:var(--accent)">HOY</button>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button class="btn btn-outline btn-sm" onclick="exportClosingCSV()">⬇ CSV</button>
      <button class="btn btn-outline btn-sm" onclick="printPage('closing')">🖨 Imprimir</button>
    </div>
  </div>

  <!-- ── AI PDF READER ── -->
  <div class="pdf-reader-panel" id="pdfReaderPanel">
    <div class="pdf-reader-header" onclick="togglePdfReader()">
      <span style="font-size:1.2rem">🤖</span>
      <h3>LECTOR DE REPORTE — IA</h3>
      <span style="font-size:0.68rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);margin-left:4px">Sube el PDF o imagen del broker para extraer y comparar automáticamente</span>
      <span id="pdfReaderArrow" style="margin-left:auto;color:var(--muted);font-size:0.7rem;transition:transform .2s">▼</span>
    </div>
    <div id="pdfReaderBody" class="pdf-reader-body">

      <div class="ai-broker-selector">
        <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
          <div class="form-group" style="margin-bottom:0;flex:1;min-width:180px">
            <label>Broker del reporte</label>
            <select id="ai_broker"><option value="">-- Seleccionar broker --</option></select>
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label>Tipo de archivo</label>
            <select id="ai_fileType" style="width:130px">
              <option value="auto">Auto-detectar</option>
              <option value="pdf">PDF</option>
              <option value="image">Imagen</option>
            </select>
          </div>
        </div>
        <!-- API Key input -->
        <div style="margin-top:10px;display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap">
          <div class="form-group" style="margin-bottom:0;flex:1;min-width:260px">
            <label style="display:flex;align-items:center;gap:6px">
              🔑 Anthropic API Key
              <span style="font-size:0.6rem;color:var(--muted);font-family:'IBM Plex Mono',monospace">(se guarda localmente, nunca se envía a terceros)</span>
            </label>
            <div style="display:flex;gap:6px">
              <input type="password" id="ai_apiKey" placeholder="sk-ant-..." style="flex:1;font-family:'IBM Plex Mono',monospace;font-size:0.75rem" oninput="saveAPIKey()" autocomplete="off"/>
              <button class="btn btn-outline btn-sm" onclick="toggleAPIKeyVisibility()" id="ai_eyeBtn" style="padding:0 10px">👁</button>
            </div>
          </div>
          <div id="ai_keyStatus" style="font-size:0.68rem;font-family:'IBM Plex Mono',monospace;padding-bottom:8px"></div>
        </div>
      </div>

      <!-- Drop zone -->
      <div class="drop-zone" id="aiDropZone" onclick="document.getElementById('aiFileInput').click()">
        <input type="file" id="aiFileInput" accept=".pdf,.png,.jpg,.jpeg,.webp,.gif" onchange="onAIFileSelected(event)" style="display:none"/>
        <div class="drop-zone-icon" id="aiDropIcon">📄</div>
        <div class="drop-zone-title" id="aiDropTitle">ARRASTRA AQUÍ EL REPORTE</div>
        <div class="drop-zone-sub" id="aiDropSub">PDF, PNG, JPG, JPEG, WEBP — haz clic o arrastra el archivo</div>
      </div>

      <!-- Progress -->
      <div class="ai-progress-wrap" id="aiProgressWrap">
        <div class="ai-progress-label">
          <span class="ai-progress-title" id="aiProgressLabel">Procesando...</span>
          <span class="ai-progress-pct" id="aiProgressPct">0%</span>
        </div>
        <div class="ai-progress-bar-outer">
          <div class="ai-progress-bar-inner" id="aiProgressBar" style="width:0%"></div>
        </div>
        <div class="ai-stages">
          <div class="ai-stage" id="aiStage1"><div class="ai-stage-dot"></div>CARGANDO ARCHIVO</div>
          <div class="ai-stage" id="aiStage2"><div class="ai-stage-dot"></div>ENVIANDO A IA</div>
          <div class="ai-stage" id="aiStage3"><div class="ai-stage-dot"></div>EXTRAYENDO DATOS</div>
          <div class="ai-stage" id="aiStage4"><div class="ai-stage-dot"></div>COMPARANDO TICKETS</div>
          <div class="ai-stage" id="aiStage5"><div class="ai-stage-dot"></div>LISTO</div>
        </div>
      </div>

      <!-- Results table -->
      <div class="ai-results" id="aiResults">
        <div class="ai-results-header">
          <div class="ai-results-title">RESULTADO DEL ANÁLISIS</div>
          <div class="ai-results-stats" id="aiResultsStats"></div>
          <button class="btn btn-outline btn-sm" onclick="clearAIResults()" style="margin-left:8px;font-size:0.65rem">✕ Limpiar</button>
        </div>
        <!-- Column headers -->
        <div class="ai-row ai-row-header">
          <span style="font-family:'IBM Plex Mono',monospace;font-size:0.6rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted)">Ticket #</span>
          <span style="font-family:'IBM Plex Mono',monospace;font-size:0.6rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted)">Fecha</span>
          <span style="font-family:'IBM Plex Mono',monospace;font-size:0.6rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);text-align:right">Nuestro $</span>
          <span style="font-family:'IBM Plex Mono',monospace;font-size:0.6rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);text-align:right">Broker $</span>
          <span style="font-family:'IBM Plex Mono',monospace;font-size:0.6rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);text-align:right">Descuento</span>
          <span style="font-family:'IBM Plex Mono',monospace;font-size:0.6rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted)">Estado</span>
          <span></span>
        </div>
        <div id="aiResultsBody"></div>
        <!-- Summary row -->
        <div id="aiResultsSummary" style="padding:.75rem 1rem;background:var(--surface2);border:1px solid var(--border);border-top:none;font-family:'IBM Plex Mono',monospace;font-size:0.75rem;display:flex;gap:2rem;flex-wrap:wrap"></div>
        <button class="btn-apply-all" id="aiBtnApplyAll" onclick="applyAllAIResults()">
          ⚡ APLICAR TODO AL CIERRE DE SEMANA
        </button>
        <!-- Raw extracted text toggle -->
        <div style="padding:.75rem 1rem;border:1px solid var(--border);border-top:none">
          <div style="display:flex;align-items:center;gap:8px;cursor:pointer" onclick="document.getElementById('aiRawText').style.display=document.getElementById('aiRawText').style.display==='none'?'block':'none'">
            <span style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;color:var(--muted)">🔍 VER TEXTO EXTRAÍDO POR IA</span>
            <span style="font-size:0.6rem;color:var(--muted)">▾</span>
          </div>
          <div id="aiRawText" class="ai-raw-text" style="display:none"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- Status & info bar -->
  <div class="cl-status-bar" id="cl_statusBar">
    <div id="cl_statusPill" class="cl-status-pill cl-pill-open">⬤ Semana Abierta</div>
    <div style="font-family:'IBM Plex Mono',monospace;font-size:0.72rem;color:var(--muted)" id="cl_statusInfo">Confirma los tickets recibidos de cada broker</div>
    <div style="margin-left:auto;display:flex;align-items:center;gap:12px">
      <div style="font-size:0.7rem;font-family:'IBM Plex Mono',monospace;color:var(--muted)">PROGRESO</div>
      <div style="width:160px;height:6px;background:var(--surface3);border-radius:3px;overflow:hidden">
        <div id="cl_progressBar" style="height:100%;background:var(--success);border-radius:3px;transition:width .4s;width:0%"></div>
      </div>
      <div id="cl_progressText" style="font-family:'IBM Plex Mono',monospace;font-size:0.72rem;color:var(--label)">0/0</div>
    </div>
  </div>

  <!-- Closed banner (hidden by default) -->
  <div class="cl-closed-banner" id="cl_closedBanner" style="display:none">
    <span style="font-size:1.5rem">✅</span>
    <div>
      <h3>SEMANA CERRADA Y CONFIRMADA</h3>
      <div style="font-size:0.75rem;color:var(--muted);font-family:'IBM Plex Mono',monospace" id="cl_closedDate">—</div>
    </div>
    <div style="margin-left:auto;font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--success);letter-spacing:2px" id="cl_closedTotal">$0</div>
  </div>

  <!-- BROKER CHECKLISTS -->
  <div id="cl_brokerCards"></div>

  <!-- GLOBAL SUMMARY -->
  <div class="cl-summary-card" id="cl_summaryCard" style="display:none">
    <div style="font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:3px;color:var(--label);margin-bottom:1rem;padding-bottom:.75rem;border-bottom:1px solid var(--border)">
      📊 RESUMEN GLOBAL DE CIERRE
    </div>
    <div class="cl-summary-grid">
      <div class="cl-sum-box" style="border-left-color:var(--accent)">
        <div class="cl-sum-label">Nuestro Total</div>
        <div class="cl-sum-val accent" id="cl_sumOurs">$0</div>
        <div style="font-size:0.65rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);margin-top:3px" id="cl_sumOursCount">0 tickets</div>
      </div>
      <div class="cl-sum-box" style="border-left-color:var(--info)">
        <div class="cl-sum-label">Total Broker</div>
        <div class="cl-sum-val" style="color:var(--info)" id="cl_sumBroker">$0</div>
        <div style="font-size:0.65rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);margin-top:3px" id="cl_sumBrokerCount">0 confirmados</div>
      </div>
      <div class="cl-sum-box" id="cl_diffBox" style="border-left-color:var(--muted)">
        <div class="cl-sum-label">Diferencia</div>
        <div class="cl-sum-val" id="cl_sumDiff">$0</div>
        <div style="font-size:0.65rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);margin-top:3px" id="cl_sumDiffNote">—</div>
      </div>
      <div class="cl-sum-box" style="border-left-color:var(--danger)">
        <div class="cl-sum-label">En Disputa</div>
        <div class="cl-sum-val" style="color:var(--danger)" id="cl_sumDisputed">$0</div>
        <div style="font-size:0.65rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);margin-top:3px" id="cl_sumDisputedCount">0 tickets</div>
      </div>
    </div>

    <!-- Per-broker summary table -->
    <div style="margin-bottom:1.25rem">
      <table>
        <thead><tr>
          <th>Broker</th>
          <th style="text-align:right">Nuestro Total</th>
          <th style="text-align:right">Total Broker</th>
          <th style="text-align:right">Diferencia</th>
          <th style="text-align:right">Descuento</th>
          <th style="text-align:center">Tickets</th>
          <th style="text-align:center">Estado</th>
        </tr></thead>
        <tbody id="cl_brokerSummaryTbody"></tbody>
      </table>
    </div>

    <!-- Notes -->
    <div class="form-group" style="margin-bottom:1rem">
      <label>Notas de Cierre</label>
      <textarea class="cl-notes" id="cl_weekNotes" rows="2" placeholder="Observaciones generales de la semana..."></textarea>
    </div>

    <!-- Close button -->
    <button class="btn-close-week" id="cl_closeBtn" onclick="closeWeek()">
      🔒 CONFIRMAR Y CERRAR SEMANA
    </button>
    <button class="btn-reopen" id="cl_reopenBtn" style="display:none" onclick="reopenWeek()">
      🔓 REABRIR SEMANA
    </button>
  </div>

</div>
</div>

<!-- ═══════════════════════════════════════════════════
     PAGE: GASTOS
═══════════════════════════════════════════════════ -->
<div class="page" id="page-expenses">
<div class="container">
  <div class="print-company-header" style="display:none">
    <div class="pch-info">
      <div class="pch-name" id="prt_expenses_name">DUMPTRACK PRO</div>
      <div class="pch-sub" id="prt_expenses_sub"></div>
    </div>
    <div class="pch-right"><strong>REGISTRO DE GASTOS</strong><br><span id="prt_expenses_date"></span></div>
  </div>
  <div class="section-header">
    <div class="section-icon">📉</div>
    <div class="section-title"><h1>REGISTRO DE GASTOS</h1><p>Control de gastos operacionales</p></div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <select id="exp_filterMonth" onchange="renderExpenses()" class="search-input print-hide" style="width:160px">
        <option value="">Todos los meses</option>
      </select>
      <button class="btn btn-outline btn-sm" onclick="exportExpensesCSV()">⬇ CSV</button>
      <button class="btn btn-success-outline btn-sm" onclick="printPage('expenses')">🖨 Imprimir</button>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card" style="border-left-color:var(--danger)"><div class="stat-label">Total Gastos</div><div class="stat-value" id="exp_statTotal" style="color:var(--danger);font-size:1.6rem">$0</div><div class="stat-sub" id="exp_statPeriod">Este mes</div></div>
    <div class="stat-card" style="border-left-color:#e8890a"><div class="stat-label">Diesel / Fuel</div><div class="stat-value" id="exp_statFuel" style="color:#e8890a;font-size:1.6rem">$0</div><div class="stat-sub">Combustible</div></div>
    <div class="stat-card" style="border-left-color:#4a9fcf"><div class="stat-label">Reparaciones</div><div class="stat-value" id="exp_statRepair" style="color:#4a9fcf;font-size:1.6rem">$0</div><div class="stat-sub">Mecánica / Taller</div></div>
    <div class="stat-card" style="border-left-color:#9b7fd4"><div class="stat-label">Otros</div><div class="stat-value" id="exp_statOther" style="color:#9b7fd4;font-size:1.6rem">$0</div><div class="stat-sub">Seguros, llantas, etc.</div></div>
  </div>

  <div class="main-grid">
    <div class="card form-card">
      <div class="card-header"><div class="accent-dot" style="background:var(--danger)"></div><h3 id="expFormTitle">NUEVO GASTO</h3></div>
      <div class="card-body">
        <div class="form-row">
          <div class="form-group"><label>Fecha *</label><input type="date" id="exp_date"/></div>
          <div class="form-group"><label>Monto *</label><input type="number" id="exp_amount" placeholder="$0.00" min="0" step="0.01"/></div>
        </div>
        <div class="form-group"><label>Categoría *</label>
          <select id="exp_category">
            <option value="fuel">⛽ Diesel / Fuel</option>
            <option value="repair">🔧 Reparación / Mecánica</option>
            <option value="tire">🛞 Llantas / Neumáticos</option>
            <option value="insurance">🛡 Seguro</option>
            <option value="truck_payment">💳 Pago de Truck / Financiamiento</option>
            <option value="oil">🛢 Cambio de Aceite</option>
            <option value="inspection">📋 Inspección / DOT</option>
            <option value="toll">🛣 Peajes / Toll</option>
            <option value="wash">🚿 Lavado</option>
            <option value="permit">📄 Permisos / Licencias</option>
            <option value="driver_pay">👤 Pago a Chofer</option>
            <option value="other">📦 Otro</option>
          </select>
        </div>
        <div class="form-group"><label>Camión Relacionado</label>
          <select id="exp_truck"><option value="">-- General / Todos --</option></select>
        </div>
        <div class="form-group"><label>Descripción *</label><input type="text" id="exp_desc" placeholder="Descripción del gasto"/></div>
        <div class="form-group"><label>Método de Pago</label>
          <select id="exp_method">
            <option value="cash">💵 Cash</option>
            <option value="check">🧾 Check</option>
            <option value="card">💳 Tarjeta</option>
            <option value="zelle">📱 Zelle</option>
            <option value="wire">🏦 Wire Transfer</option>
          </select>
        </div>
        <div class="form-group"><label>Recibo / Referencia</label><input type="text" id="exp_ref" placeholder="# recibo o referencia"/></div>
        <div class="form-group"><label>Notas</label><textarea id="exp_notes" rows="2" placeholder="Observaciones..."></textarea></div>
        <button class="btn btn-primary" id="exp_submitBtn" onclick="saveExpense()" style="background:var(--danger)">GUARDAR GASTO</button>
        <button class="btn btn-secondary" id="exp_cancelBtn" style="display:none" onclick="cancelExpenseEdit()">CANCELAR</button>
      </div>
    </div>

    <div class="card">
      <div class="table-toolbar">
        <div class="accent-dot" style="width:7px;height:7px;border-radius:50%;background:var(--danger)"></div>
        <h3>GASTOS</h3>
        <span class="count-badge" style="background:var(--danger)" id="exp_countBadge">0</span>
        <input type="text" class="search-input" id="exp_search" placeholder="Buscar..." oninput="renderExpenses()"/>
      </div>
      <!-- Category breakdown -->
      <div style="padding:1rem 1.25rem;border-bottom:1px solid var(--border)">
        <div style="font-size:0.62rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);font-family:'IBM Plex Mono',monospace;margin-bottom:.75rem">DESGLOSE POR CATEGORÍA</div>
        <div id="exp_catBreakdown"></div>
      </div>
      <div class="tbl-wrap">
        <table>
          <thead><tr><th>Fecha</th><th>Categoría</th><th>Descripción</th><th>Camión</th><th>Método</th><th>Monto</th><th></th></tr></thead>
          <tbody id="exp_tbody"></tbody>
          <tfoot id="exp_tfoot"></tfoot>
        </table>
      </div>
    </div>
  </div>
</div>
</div>

<!-- ═══════════════════════════════════════════════════
     PAGE: P&L
═══════════════════════════════════════════════════ -->
<div class="page" id="page-pl">
<div class="container">
  <div class="print-company-header" style="display:none">
    <div class="pch-info">
      <div class="pch-name" id="prt_pl_name">DUMPTRACK PRO</div>
      <div class="pch-sub" id="prt_pl_sub"></div>
    </div>
    <div class="pch-right"><strong>REPORTE P&amp;L — PÉRDIDAS Y GANANCIAS</strong><br><span id="prt_pl_period"></span><br><span id="prt_pl_date"></span></div>
  </div>
  <div class="section-header">
    <div class="section-icon">📈</div>
    <div class="section-title"><h1>P&L — PÉRDIDAS Y GANANCIAS</h1><p>Análisis financiero detallado</p></div>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <select id="pl_period" onchange="renderPL()" class="search-input print-hide" style="width:160px">
        <option value="week">Esta Semana</option>
        <option value="month" selected>Este Mes</option>
        <option value="quarter">Este Trimestre</option>
        <option value="year">Este Año</option>
      </select>
      <button class="btn btn-outline btn-sm" onclick="exportPLCSV()">⬇ CSV</button>
      <button class="btn btn-success-outline btn-sm" onclick="printPage('pl')">🖨 Imprimir</button>
    </div>
  </div>

  <div class="pl-hero">
    <div class="pl-card" style="border-left:4px solid var(--success)">
      <div class="pl-card-icon">💰</div>
      <div class="pl-label">Ingresos Brutos</div>
      <div class="pl-val" id="pl_income" style="color:var(--success)">$0</div>
      <div class="pl-sub" id="pl_incomeTickets">0 tickets</div>
    </div>
    <div class="pl-card" style="border-left:4px solid var(--danger)">
      <div class="pl-card-icon">📉</div>
      <div class="pl-label">Total Gastos</div>
      <div class="pl-val" id="pl_expenses" style="color:var(--danger)">$0</div>
      <div class="pl-sub" id="pl_expensesCount">0 gastos</div>
    </div>
    <div class="pl-card" id="pl_netCard" style="border-left:4px solid var(--accent)">
      <div class="pl-card-icon">📊</div>
      <div class="pl-label">Ganancia Neta</div>
      <div class="pl-val" id="pl_net" style="color:var(--accent)">$0</div>
      <div class="pl-sub" id="pl_margin">Margen: 0%</div>
    </div>
  </div>

  <!-- Bar chart by week/month -->
  <div class="chart-container">
    <div style="font-family:'Bebas Neue',sans-serif;font-size:0.9rem;letter-spacing:2px;color:var(--label);margin-bottom:1rem">TENDENCIA DE INGRESOS VS GASTOS</div>
    <div class="bar-chart" id="pl_chart"></div>
    <div style="display:flex;gap:1.5rem;margin-top:.75rem">
      <div style="display:flex;align-items:center;gap:6px;font-size:0.68rem;font-family:'IBM Plex Mono',monospace;color:var(--muted)"><div style="width:10px;height:10px;border-radius:2px;background:var(--success)"></div>Ingresos</div>
      <div style="display:flex;align-items:center;gap:6px;font-size:0.68rem;font-family:'IBM Plex Mono',monospace;color:var(--muted)"><div style="width:10px;height:10px;border-radius:2px;background:var(--danger)"></div>Gastos</div>
      <div style="display:flex;align-items:center;gap:6px;font-size:0.68rem;font-family:'IBM Plex Mono',monospace;color:var(--muted)"><div style="width:10px;height:10px;border-radius:2px;background:var(--accent)"></div>Neto</div>
    </div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
    <!-- Income breakdown -->
    <div class="pl-table-section">
      <div class="pl-section-hdr" style="color:var(--success)"><span>💰</span> INGRESOS POR BROKER</div>
      <table>
        <thead><tr><th>Broker</th><th style="text-align:right">Tickets</th><th style="text-align:right">Total</th><th style="text-align:right">%</th></tr></thead>
        <tbody id="pl_incomeTable"></tbody>
      </table>
    </div>
    <!-- Expense breakdown -->
    <div class="pl-table-section">
      <div class="pl-section-hdr" style="color:var(--danger)"><span>📉</span> GASTOS POR CATEGORÍA</div>
      <table>
        <thead><tr><th>Categoría</th><th style="text-align:right">Items</th><th style="text-align:right">Total</th><th style="text-align:right">%</th></tr></thead>
        <tbody id="pl_expTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Weekly P&L detail table -->
  <div class="pl-table-section" style="margin-top:1rem">
    <div class="pl-section-hdr"><span>📅</span> DETALLE POR SEMANA</div>
    <table>
      <thead><tr><th>Semana</th><th style="text-align:right">Ingresos</th><th style="text-align:right">Gastos</th><th style="text-align:right">Neto</th><th style="text-align:right">Margen</th><th style="text-align:right">Tickets</th></tr></thead>
      <tbody id="pl_weekTable"></tbody>
    </table>
  </div>
</div>
</div>

<!-- ═══════════════════════════════════════════════════
     PAGE: BROKER REPORT
═══════════════════════════════════════════════════ -->
<div class="page" id="page-brokerreport">
<div class="container">
  <div class="print-company-header" style="display:none">
    <div class="pch-info">
      <div class="pch-name" id="prt_brr_name">DUMPTRACK PRO</div>
      <div class="pch-sub" id="prt_brr_sub"></div>
    </div>
    <div class="pch-right"><strong>REPORTE POR BROKER</strong><br><span id="prt_brr_period"></span><br><span id="prt_brr_date"></span></div>
  </div>
  <div class="section-header">
    <div class="section-icon">🤝</div>
    <div class="section-title"><h1>REPORTE POR BROKER</h1><p>Análisis de rendimiento y pagos</p></div>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <select id="brr_period" onchange="renderBrokerReport()" class="search-input print-hide" style="width:160px">
        <option value="month" selected>Este Mes</option>
        <option value="quarter">Este Trimestre</option>
        <option value="year">Este Año</option>
        <option value="all">Todo el Tiempo</option>
      </select>
      <button class="btn btn-success-outline btn-sm" onclick="printPage('brokerreport')">🖨 Imprimir</button>
    </div>
  </div>

  <div id="brr_cards"></div>

  <div class="pl-table-section" style="margin-top:1rem">
    <div class="pl-section-hdr"><span>📊</span> COMPARATIVO DE BROKERS</div>
    <table>
      <thead><tr>
        <th>Broker</th><th style="text-align:right">Tickets</th><th style="text-align:right">Ingresos</th>
        <th style="text-align:right">Promedio/Ticket</th><th style="text-align:right">Mejor Semana</th>
        <th style="text-align:right">Desc. Total</th><th style="text-align:center">Estado</th>
      </tr></thead>
      <tbody id="brr_compTable"></tbody>
    </table>
  </div>
</div>
</div>

<!-- ═══════════════════════════════════════════════════
     PAGE: ALERTAS
═══════════════════════════════════════════════════ -->
<div class="page" id="page-alerts">
<div class="container">
  <div class="print-company-header" style="display:none">
    <div class="pch-info">
      <div class="pch-name" id="prt_alerts_name">DUMPTRACK PRO</div>
      <div class="pch-sub" id="prt_alerts_sub"></div>
    </div>
    <div class="pch-right"><strong>ALERTAS DE VENCIMIENTO</strong><br><span id="prt_alerts_date"></span></div>
  </div>
  <div class="section-header">
    <div class="section-icon">🔔</div>
    <div class="section-title"><h1>ALERTAS DE VENCIMIENTO</h1><p>Documentos y licencias próximas a vencer</p></div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button class="btn btn-outline btn-sm" onclick="renderAlerts()">🔄 Actualizar</button>
      <button class="btn btn-success-outline btn-sm" onclick="printPage('alerts')">🖨 Imprimir</button>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card" style="border-left-color:var(--danger)"><div class="stat-label">🚨 Vencidos</div><div class="stat-value" id="al_statExpired" style="color:var(--danger)">0</div><div class="stat-sub">Requieren acción inmediata</div></div>
    <div class="stat-card" style="border-left-color:#e8890a"><div class="stat-label">⚠ Próximos 30 días</div><div class="stat-value" id="al_stat30" style="color:#e8890a">0</div><div class="stat-sub">Vencen pronto</div></div>
    <div class="stat-card" style="border-left-color:var(--accent)"><div class="stat-label">📅 31-90 días</div><div class="stat-value" id="al_stat90" style="color:var(--accent)">0</div><div class="stat-sub">Renovar pronto</div></div>
    <div class="stat-card" style="border-left-color:var(--success)"><div class="stat-label">✅ Al día</div><div class="stat-value" id="al_statOk" style="color:var(--success)">0</div><div class="stat-sub">Documentos vigentes</div></div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem">
    <div>
      <div class="alert-section-title">🚛 DOCUMENTOS DE CAMIONES</div>
      <div id="al_trucks"></div>
    </div>
    <div>
      <div class="alert-section-title">👤 DOCUMENTOS DE CHOFERES</div>
      <div id="al_drivers"></div>
    </div>
  </div>
</div>
</div>

<!-- ═══════════════════════════════════════════════════
     PAGE: SETTINGS
═══════════════════════════════════════════════════ -->
<div class="page" id="page-settings">
<div class="container">

  <div class="section-header">
    <div class="section-icon">⚙</div>
    <div class="section-title"><h1>CONFIGURACIÓN</h1><p>Información de la empresa y preferencias del sistema</p></div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 340px;gap:1.5rem;align-items:start">
    <div>

      <!-- ── MI EMPRESA ── -->
      <div class="settings-section">
        <div class="settings-section-hdr">
          <span style="font-size:1.2rem">🏢</span>
          <h3>MI EMPRESA</h3>
          <p>Aparece en reportes y documentos impresos</p>
        </div>
        <div style="padding:1.5rem">
          <!-- Logo + nombre en la misma fila -->
          <div style="display:flex;gap:1.25rem;align-items:flex-start;margin-bottom:1.25rem">
            <div>
              <label style="font-size:0.62rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);font-family:'IBM Plex Mono',monospace;display:block;margin-bottom:8px">Logo</label>
              <div class="company-logo-box" id="logoBox" onclick="document.getElementById('logoFileInput').click()" title="Click para cargar logo">
                <span id="logoPlaceholder">🏢</span>
                <img id="logoPreview" style="display:none"/>
              </div>
              <input type="file" id="logoFileInput" accept="image/*" style="display:none" onchange="loadCompanyLogo(event)"/>
              <button style="margin-top:6px;font-size:0.6rem;font-family:'IBM Plex Mono',monospace;background:none;border:none;color:var(--muted);cursor:pointer;display:block;width:80px;text-align:center" onclick="clearCompanyLogo()">Quitar logo</button>
            </div>
            <div style="flex:1;display:grid;grid-template-columns:1fr 1fr;gap:1rem">
              <div class="form-group" style="grid-column:1/-1;margin-bottom:0">
                <label>Nombre de la Empresa *</label>
                <input type="text" id="cfg_companyName" placeholder="PLEASEME LLC" style="font-size:1rem;font-weight:600"/>
              </div>
              <div class="form-group" style="margin-bottom:0">
                <label>DBA / Nombre Comercial</label>
                <input type="text" id="cfg_dba" placeholder="DBA si aplica"/>
              </div>
              <div class="form-group" style="margin-bottom:0">
                <label>Tipo de Entidad</label>
                <select id="cfg_entityType">
                  <option value="LLC">LLC</option>
                  <option value="Inc">Inc. / Corporation</option>
                  <option value="Sole">Sole Proprietor</option>
                  <option value="Partnership">Partnership</option>
                  <option value="Other">Otro</option>
                </select>
              </div>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;margin-bottom:1rem">
            <div class="form-group" style="margin-bottom:0">
              <label>EIN / Tax ID</label>
              <input type="text" id="cfg_ein" placeholder="XX-XXXXXXX"/>
            </div>
            <div class="form-group" style="margin-bottom:0">
              <label>DOT Number</label>
              <input type="text" id="cfg_dot" placeholder="USDOT XXXXXXX"/>
            </div>
            <div class="form-group" style="margin-bottom:0">
              <label>MC Number</label>
              <input type="text" id="cfg_mc" placeholder="MC-XXXXXXX"/>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">
            <div class="form-group" style="margin-bottom:0">
              <label>Teléfono Principal</label>
              <input type="tel" id="cfg_phone" placeholder="(786) 000-0000"/>
            </div>
            <div class="form-group" style="margin-bottom:0">
              <label>Teléfono Alternativo / Fax</label>
              <input type="tel" id="cfg_phone2" placeholder="(786) 000-0000"/>
            </div>
            <div class="form-group" style="margin-bottom:0">
              <label>Email Principal</label>
              <input type="email" id="cfg_email" placeholder="info@empresa.com"/>
            </div>
            <div class="form-group" style="margin-bottom:0">
              <label>Sitio Web</label>
              <input type="text" id="cfg_website" placeholder="www.empresa.com"/>
            </div>
          </div>
        </div>
      </div>

      <!-- ── DIRECCIÓN ── -->
      <div class="settings-section">
        <div class="settings-section-hdr">
          <span style="font-size:1.2rem">📍</span>
          <h3>DIRECCIÓN</h3>
        </div>
        <div style="padding:1.5rem;display:grid;grid-template-columns:1fr 1fr;gap:1rem">
          <div class="form-group" style="grid-column:1/-1;margin-bottom:0">
            <label>Dirección (Street Address)</label>
            <input type="text" id="cfg_address1" placeholder="123 Main Street, Suite 100"/>
          </div>
          <div class="form-group" style="grid-column:1/-1;margin-bottom:0">
            <label>Dirección Línea 2</label>
            <input type="text" id="cfg_address2" placeholder="Apt, Suite, Unit (opcional)"/>
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label>Ciudad</label>
            <input type="text" id="cfg_city" placeholder="Miami"/>
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label>Estado</label>
            <select id="cfg_state">
              <option value="">-- Estado --</option>
              <option>AL</option><option>AK</option><option>AZ</option><option>AR</option><option>CA</option>
              <option>CO</option><option>CT</option><option>DE</option><option>FL</option><option>GA</option>
              <option>HI</option><option>ID</option><option>IL</option><option>IN</option><option>IA</option>
              <option>KS</option><option>KY</option><option>LA</option><option>ME</option><option>MD</option>
              <option>MA</option><option>MI</option><option>MN</option><option>MS</option><option>MO</option>
              <option>MT</option><option>NE</option><option>NV</option><option>NH</option><option>NJ</option>
              <option>NM</option><option>NY</option><option>NC</option><option>ND</option><option>OH</option>
              <option>OK</option><option>OR</option><option>PA</option><option>RI</option><option>SC</option>
              <option>SD</option><option>TN</option><option>TX</option><option>UT</option><option>VT</option>
              <option selected>FL</option><option>VA</option><option>WA</option><option>WV</option><option>WI</option><option>WY</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label>ZIP Code</label>
            <input type="text" id="cfg_zip" placeholder="33101"/>
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label>País</label>
            <input type="text" id="cfg_country" value="United States"/>
          </div>
        </div>
      </div>

      <!-- ── INFORMACIÓN BANCARIA ── -->
      <div class="settings-section">
        <div class="settings-section-hdr">
          <span style="font-size:1.2rem">🏦</span>
          <h3>INFORMACIÓN BANCARIA</h3>
          <p style="color:rgba(224,82,82,.7)">🔒 Solo guardado localmente</p>
        </div>
        <div style="padding:1.5rem;display:grid;grid-template-columns:1fr 1fr;gap:1rem">
          <div class="form-group" style="margin-bottom:0">
            <label>Nombre del Banco</label>
            <input type="text" id="cfg_bankName" placeholder="Bank of America"/>
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label>Nombre en la Cuenta</label>
            <input type="text" id="cfg_bankAccName" placeholder="PLEASEME LLC"/>
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label>Routing Number</label>
            <input type="text" id="cfg_bankRouting" placeholder="XXXXXXXXX"/>
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label>Account Number</label>
            <input type="password" id="cfg_bankAccount" placeholder="••••••••"/>
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label>Tipo de Cuenta</label>
            <select id="cfg_bankType">
              <option value="checking">Checking</option>
              <option value="savings">Savings</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label>Zelle / Venmo / CashApp</label>
            <input type="text" id="cfg_zelle" placeholder="email o teléfono"/>
          </div>
        </div>
      </div>

      <!-- ── PREFERENCIAS ── -->
      <div class="settings-section">
        <div class="settings-section-hdr">
          <span style="font-size:1.2rem">🎛</span>
          <h3>PREFERENCIAS DEL SISTEMA</h3>
        </div>
        <div style="padding:1.5rem;display:grid;grid-template-columns:1fr 1fr;gap:1rem">
          <div class="form-group" style="margin-bottom:0">
            <label>Moneda</label>
            <select id="cfg_currency">
              <option value="USD" selected>USD — Dólar Americano</option>
              <option value="EUR">EUR — Euro</option>
              <option value="MXN">MXN — Peso Mexicano</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label>Formato de Fecha</label>
            <select id="cfg_dateFormat">
              <option value="MM/DD/YYYY" selected>MM/DD/YYYY (US)</option>
              <option value="DD/MM/YYYY">DD/MM/YYYY</option>
              <option value="YYYY-MM-DD">YYYY-MM-DD</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label>Semana inicia el</label>
            <select id="cfg_weekStart">
              <option value="1" selected>Lunes</option>
              <option value="0">Domingo</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label>Prefijo de Ticket</label>
            <input type="text" id="cfg_ticketPrefix" placeholder="T-" maxlength="5"/>
          </div>
        </div>
      </div>


      <!-- ── USUARIOS ── -->
      <div class="settings-section" id="usersSettingsSection">
        <div class="settings-section-hdr">
          <span style="font-size:1.2rem">👥</span>
          <h3>REGISTRO DE USUARIOS</h3>
          <p>Usuarios locales para login</p>
        </div>
        <div style="padding:1.5rem">
          <div style="display:grid;grid-template-columns:1.2fr 1fr 1fr auto;gap:10px;align-items:end">
            <div class="form-group" style="margin-bottom:0"><label>Usuario</label><input type="text" id="usr_name" placeholder="admin"/></div>
            <div class="form-group" style="margin-bottom:0"><label>Rol</label><select id="usr_role"><option value="admin">Admin</option><option value="dispatcher">Dispatcher</option><option value="viewer">Viewer</option></select></div>
            <div class="form-group" style="margin-bottom:0"><label>Contraseña</label><input type="password" id="usr_pass" placeholder="******"/></div>
            <button class="backup-btn" style="height:38px;margin:0" onclick="saveUser()">➕ Guardar</button>
          </div>
          <div class="tbl-wrap" style="margin-top:12px;border:1px solid var(--border);border-radius:3px">
            <table>
              <thead><tr><th>Usuario</th><th>Rol</th><th>Creado</th><th></th></tr></thead>
              <tbody id="users_tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <button class="settings-save-btn" onclick="saveSettings()">💾 GUARDAR CONFIGURACIÓN</button>

      <!-- ── DATOS ── -->
      <div class="data-danger-zone" style="margin-top:1.5rem">
        <h4>🗃 BACKUP Y DATOS</h4>
        <p style="font-size:0.72rem;color:var(--muted);font-family:'IBM Plex Mono',monospace;margin-bottom:1rem">Exporta o restaura todos los datos del sistema</p>
        <button class="backup-btn" onclick="exportBackup()">📥 Exportar Backup (JSON)</button>
        <button class="backup-btn" onclick="document.getElementById('importFileInput').click()">📤 Importar Backup</button>
        <input type="file" id="importFileInput" accept=".json" style="display:none" onchange="importBackup(event)"/>
        <br>
        <button class="backup-btn danger" onclick="confirmResetAllData()" style="margin-top:.5rem">🗑 Borrar Todos los Datos</button>
      </div>

    </div>

    <!-- ── PREVIEW CARD ── -->
    <div style="position:sticky;top:80px">
      <div style="font-size:0.62rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);font-family:'IBM Plex Mono',monospace;margin-bottom:.75rem">VISTA PREVIA DEL ENCABEZADO</div>
      <div class="company-preview">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:1rem;padding-bottom:1rem;border-bottom:1px solid var(--border)">
          <div id="prev_logoBox" style="width:50px;height:50px;border-radius:3px;background:var(--surface3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:1.4rem;overflow:hidden;flex-shrink:0">
            <img id="prev_logo" style="display:none;width:100%;height:100%;object-fit:contain"/>
            <span id="prev_logoIcon">🏢</span>
          </div>
          <div>
            <div id="prev_name" style="font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;color:var(--text)">MI EMPRESA LLC</div>
            <div id="prev_entity" style="font-size:0.65rem;font-family:'IBM Plex Mono',monospace;color:var(--muted)">LLC</div>
          </div>
        </div>
        <div style="font-size:0.72rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);line-height:1.8">
          <div id="prev_address" style="margin-bottom:.5rem">📍 —</div>
          <div id="prev_phone">📞 —</div>
          <div id="prev_email">✉ —</div>
          <div id="prev_ein" style="margin-top:.5rem;color:var(--label)">EIN: —</div>
          <div id="prev_dot">DOT: —</div>
          <div id="prev_mc">MC: —</div>
        </div>
      </div>

      <!-- API Key section in settings -->
      <div style="margin-top:1.25rem;background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:1.25rem;border-top:2px solid var(--info)">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:.75rem">
          <span>🤖</span>
          <span style="font-family:'Bebas Neue',sans-serif;font-size:0.9rem;letter-spacing:2px;color:var(--info)">ANTHROPIC API KEY</span>
        </div>
        <p style="font-size:0.65rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);margin-bottom:.75rem;line-height:1.5">Necesaria para el lector de reportes IA en Cierre de Semana. Guardada solo en este dispositivo.</p>
        <div style="display:flex;gap:6px">
          <input type="password" id="cfg_apiKey" placeholder="sk-ant-..." style="flex:1;font-family:'IBM Plex Mono',monospace;font-size:0.72rem" oninput="syncAPIKey()" autocomplete="off"/>
          <button class="btn btn-outline btn-sm" onclick="toggleCfgAPIKey()" style="padding:0 10px">👁</button>
        </div>
        <div id="cfg_keyStatus" style="font-size:0.65rem;font-family:'IBM Plex Mono',monospace;margin-top:6px;color:var(--muted)">
          Obtén tu key en console.anthropic.com
        </div>
      </div>

      <div style="margin-top:1rem;font-size:0.62rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);text-align:center;line-height:1.7">
        🚛 DumpTrack Pro<br>
        Todos los datos se guardan localmente<br>en este dispositivo
      </div>
    </div>
  </div>

</div>
</div>

<!-- ── TOAST ── -->
<div class="toast" id="toast"></div>

<!-- ── LOGIN MODAL ── -->
<div class="login-overlay" id="loginOverlay" onclick="if(event.target===this) closeLoginModal()">
  <div class="login-box">
    <div class="login-box-hdr">
      <span style="font-size:1.1rem">🔐</span>
      <h3>INICIAR SESIÓN</h3>
      <button class="btn-icon" onclick="closeLoginModal()" style="margin-left:auto;padding:5px 9px">✕</button>
    </div>
    <div class="login-box-body">
      <div class="form-group">
        <label>Usuario</label>
        <input type="text" id="lg_user" placeholder="admin" autocomplete="username" onkeydown="if(event.key==='Enter') doLogin()">
      </div>
      <div class="form-group">
        <label>Contraseña</label>
        <input type="password" id="lg_pass" placeholder="••••••••" autocomplete="current-password" onkeydown="if(event.key==='Enter') doLogin()">
      </div>
      <div id="lg_msg" style="min-height:18px;font-size:0.72rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);margin:2px 0 8px">
        Usa un usuario creado en <span class="accent">Settings → Registro de Usuarios</span>
      </div>
      <div class="login-progress-wrap" id="lg_loaderWrap">
        <div class="login-progress-meta">
          <span id="lg_loaderText">Cargando perfil...</span>
          <span id="lg_loaderPct">0%</span>
        </div>
        <div class="login-progress-bar"><div class="login-progress-fill" id="lg_loaderFill"></div></div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn-cancel-modal" style="flex:1" onclick="closeLoginModal()">Cancelar</button>
        <button class="btn btn-primary" style="flex:1;margin-top:0" onclick="doLogin()">Entrar</button>
<button type="button" id="btnResetPass" class="btn secondary" style="margin-left:8px;">🔑 Restaurar contraseña</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn btn-outline btn-sm" style="flex:1" onclick="logoutUser()">Cerrar sesión</button>
        <button class="btn btn-outline btn-sm" style="flex:1" onclick="showPage('settings');closeLoginModal();setTimeout(()=>document.getElementById('usersSettingsSection')?.scrollIntoView({behavior:'smooth',block:'start'}),120)">Ir a usuarios</button>
      </div>
    </div>
  </div>
</div>


<!-- ── DELETE MODAL ── -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal">
    <div style="font-size:2rem;margin-bottom:.75rem">⚠️</div>
    <h3>CONFIRMAR ELIMINACIÓN</h3>
    <p>¿Seguro que deseas eliminar este registro? Esta acción no se puede deshacer.</p>
    <div class="modal-btns">
      <button class="btn-cancel-modal" onclick="closeModal()">Cancelar</button>
      <button class="btn-del-confirm" onclick="confirmDelete()">Eliminar</button>
    </div>
  </div>
</div>

<script>

function __dtMatchUser(username, password){
  const u = (username||"").trim().toLowerCase();
  const p = (password||"").toString();
  let users = [];
  try { users = JSON.parse(localStorage.getItem("dt_users") || "[]"); } catch(e){}
  return users.find(x => (x.username||"").toString().trim().toLowerCase() === u && (x.password||"").toString() === p);
}

// ════════════════════════════════════════════════
//  DATA STORE
// ════════════════════════════════════════════════
const DB = {
  tickets:   JSON.parse(localStorage.getItem('dt_tickets')   || '[]'),
  trucks:    JSON.parse(localStorage.getItem('dt_trucks')    || '[]'),
  drivers:   JSON.parse(localStorage.getItem('dt_drivers')   || '[]'),
  companies: JSON.parse(localStorage.getItem('dt_companies') || '[]'),
  brokers:   JSON.parse(localStorage.getItem('dt_brokers')   || '[]'),
  users:     JSON.parse(localStorage.getItem('dt_users')     || '[]'),
};
function save(key) { localStorage.setItem('dt_' + key, JSON.stringify(DB[key])); }
function uid() { return Date.now().toString(36) + Math.random().toString(36).substr(2,5); }

// ════════════════════════════════════════════════
//  NAVIGATION
// ════════════════════════════════════════════════
let currentPage = 'tickets';
function closeAllDropdowns(){
  document.querySelectorAll('.dropdown.open').forEach(d => d.classList.remove('open'));
}
function showPage(page, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  // Close all dropdowns when navigating
  document.querySelectorAll('.dropdown.open').forEach(d => d.classList.remove('open'));
  document.getElementById('page-' + page).classList.add('active');
  currentPage = page;
  if (page === 'tickets') {
    document.querySelector('.nav-btn').classList.add('active');
  } else if (page === 'earnings') {
    document.getElementById('earningsNavBtn').classList.add('active');
    renderEarnings();
  } else if (page === 'closing') {
    document.getElementById('closingNavBtn').classList.add('active');
    renderClosing();
  } else if (page === 'expenses') {
    document.getElementById('expensesNavBtn').classList.add('active');
    renderExpenses();
  } else if (page === 'alerts') {
    document.getElementById('alertsNavBtn').classList.add('active');
    renderAlerts();
  } else if (page === 'pl') {
    document.getElementById('reportsBtn').classList.add('active');
    renderPL();
  } else if (page === 'brokerreport') {
    document.getElementById('reportsBtn').classList.add('active');
    renderBrokerReport();
  } else if (page === 'settings') {
    document.getElementById('settingsNavBtn').classList.add('active');
    renderSettings();
  } else {
    document.getElementById('registrosBtn').classList.add('active');
    document.querySelectorAll('.dropdown-menu a').forEach(a => a.classList.remove('active'));
    if (el && el.tagName === 'A') el.classList.add('active');
  }
  updateMenuBadges();
  updateUserPill();
}

// ════════════════════════════════════════════════
//  WEEK LOGIC
// ════════════════════════════════════════════════
let weekOffset = 0;
function getWeekRange(off = 0) {
  const now = new Date();
  const day = now.getDay();
  const diff = day === 0 ? -6 : 1 - day;
  const mon = new Date(now); mon.setDate(now.getDate() + diff + off * 7); mon.setHours(0,0,0,0);
  const sun = new Date(mon); sun.setDate(mon.getDate() + 6); sun.setHours(23,59,59,999);
  return { mon, sun };
}
function getWeekNum(d) {
  const dt = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  dt.setUTCDate(dt.getUTCDate() + 4 - (dt.getUTCDay()||7));
  const yr = new Date(Date.UTC(dt.getUTCFullYear(),0,1));
  return Math.ceil((((dt - yr) / 86400000) + 1) / 7);
}
function fmtD(d) { return d.toLocaleDateString('en-US', {month:'short', day:'numeric'}); }
function isInWeek(dateStr, off) {
  const {mon, sun} = getWeekRange(off);
  const d = new Date(dateStr + 'T12:00:00');
  return d >= mon && d <= sun;
}
function updateWeekUI() {
  const {mon, sun} = getWeekRange(weekOffset);
  document.getElementById('weekLabel').textContent = `${fmtD(mon)} — ${fmtD(sun)}, ${mon.getFullYear()}`;
  document.getElementById('weekTitle').textContent = `SEMANA ${getWeekNum(mon)}`;
  document.getElementById('headerWeekBadge').textContent = weekOffset === 0 ? 'SEMANA ACTUAL' : `WK ${weekOffset > 0 ? '+':''}${weekOffset}`;
}
function changeWeek(d) { weekOffset += d; updateWeekUI(); renderTickets(); }
function goToCurrentWeek() { weekOffset = 0; updateWeekUI(); renderTickets(); }

// ════════════════════════════════════════════════
//  TOAST & MODAL
// ════════════════════════════════════════════════
function toast(msg, err = false) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast' + (err ? ' error' : '');
  t.classList.add('show');
  clearTimeout(t._t); t._t = setTimeout(() => t.classList.remove('show'), 3200);
}
let deleteTarget = null;
function openDeleteModal(id, collection) {
  deleteTarget = { id, collection };
  document.getElementById('deleteModal').classList.add('open');
}
function closeModal() { document.getElementById('deleteModal').classList.remove('open'); deleteTarget = null; }
function confirmDelete() {
  if (!deleteTarget) return;
  const col = deleteTarget.collection;
  DB[col] = DB[col].filter(x => x.id !== deleteTarget.id);
  if (col === 'expenses') saveExpenses();
  else save(col);
  closeModal();
  seedDefaultUser();
renderAll();
  toast('🗑 Registro eliminado');
}

// ════════════════════════════════════════════════
//  HELPERS
// ════════════════════════════════════════════════
function fmtDate(s) { if (!s) return '—'; const d = new Date(s + 'T12:00:00'); return d.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'2-digit'}); }
function fmtAmt(v) { return '$' + (parseFloat(v)||0).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2}); }
function isExpired(dateStr) { if (!dateStr) return false; return new Date(dateStr + 'T12:00:00') < new Date(); }
function expireClass(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr + 'T12:00:00');
  const now = new Date();
  const days = (d - now) / 86400000;
  if (days < 0) return 'badge-red';
  if (days < 30) return 'badge-yellow';
  return 'badge-green';
}

const MAT_COLORS = {Dirt:'#a0714f',Gravel:'#8a8a5a',Sand:'#c9a84c',Concrete:'#7a9fc0',Asphalt:'#555',Debris:'#c07070',Fill:'#7aaa7a',Stone:'#9090a0',Other:'#888'};
function matBadge(m) {
  if (!m) return '—';
  const c = MAT_COLORS[m] || '#888';
  return `<span class="mat-badge" style="background:${c}22;color:${c};border:1px solid ${c}44">${m}</span>`;
}

function statusBadge(s) {
  const map = {
    active:`<span class="badge badge-green">Activo</span>`,
    inactive:`<span class="badge badge-red">Inactivo</span>`,
    maintenance:`<span class="badge badge-yellow">Mantenim.</span>`,
    vacation:`<span class="badge badge-blue">Vacaciones</span>`,
  };
  return map[s] || `<span class="badge">${s}</span>`;
}

function truckTypeBadge(t) {
  const map = {dump:'badge-yellow',semi:'badge-blue',tandem:'badge-purple',triaxle:'badge-green',quad:'badge-red',other:''};
  return `<span class="badge ${map[t]||''}">${t}</span>`;
}

// ════════════════════════════════════════════════
//  POPULATE SELECTS
// ════════════════════════════════════════════════
function populateSelects() {
  // Drivers
  const dSel = document.getElementById('t_driver');
  const cv = dSel.value;
  dSel.innerHTML = '<option value="">-- Seleccionar --</option>';
  DB.drivers.filter(d => d.status === 'active').forEach(d => {
    const o = document.createElement('option');
    o.value = d.id; o.textContent = `${d.first} ${d.last}`;
    dSel.appendChild(o);
  });
  dSel.value = cv;

  // Trucks
  const tSel = document.getElementById('t_truck');
  const tv = tSel.value;
  tSel.innerHTML = '<option value="">-- Seleccionar --</option>';
  DB.trucks.filter(t => t.status === 'active').forEach(t => {
    const o = document.createElement('option');
    o.value = t.id; o.textContent = `${t.num} — ${t.make} ${t.model}`;
    tSel.appendChild(o);
  });
  tSel.value = tv;

  // Brokers
  const bSel = document.getElementById('t_broker');
  const bv = bSel.value;
  bSel.innerHTML = '<option value="">-- Ninguno --</option>';
  DB.brokers.filter(b => b.status === 'active').forEach(b => {
    const o = document.createElement('option');
    o.value = b.id; o.textContent = b.name;
    bSel.appendChild(o);
  });
  bSel.value = bv;

  // Truck select in driver form
  const drTruck = document.getElementById('dr_assignedTruck');
  const dtv = drTruck.value;
  drTruck.innerHTML = '<option value="">-- Ninguno --</option>';
  DB.trucks.filter(t => t.status === 'active').forEach(t => {
    const o = document.createElement('option');
    o.value = t.id; o.textContent = `${t.num} — ${t.make}`;
    drTruck.appendChild(o);
  });
  drTruck.value = dtv;
}

// ════════════════════════════════════════════════
//  TICKETS
// ════════════════════════════════════════════════
let t_editId = null;
function nextTicketNum() {
  const nums = DB.tickets.map(t => { const m = (t.num||'').match(/(\d+)$/); return m ? parseInt(m[1]) : 0; });
  return 'T-' + String((nums.length ? Math.max(...nums) : 0) + 1).padStart(3,'0');
}

function onTruckSelect(sel) {
  const truck = DB.trucks.find(t => t.id === sel.value);
  const badge = document.getElementById('t_truckBadge');
  const badgeText = document.getElementById('t_truckBadgeText');
  if (truck) {
    badgeText.textContent = `${truck.num}  ·  ${truck.year} ${truck.make} ${truck.model}  ·  ${truck.plate || 'Sin placa'}`;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }
}

function toggleDiscount() {
  const hasDiscount = document.getElementById('t_hasDiscount').checked;
  document.getElementById('t_discountFields').style.display = hasDiscount ? 'block' : 'none';
  if (!hasDiscount) {
    document.getElementById('t_discount').value = '';
    document.getElementById('t_discountDisplay').textContent = '$0.00';
    autoCalcNet();
  }
}

function autoCalcTicket() {
  const rate  = parseFloat(document.getElementById('t_rate').value)  || 0;
  const type  = document.getElementById('t_rateType').value;
  const loads = parseFloat(document.getElementById('t_loads').value) || 0;
  const tons  = parseFloat(document.getElementById('t_tons').value)  || 0;
  let total = 0;
  if (type === 'ton')  total = rate * tons;
  else if (type === 'load') total = rate * loads;
  else if (type === 'flat') total = rate;
  else if (type === 'hour') total = rate * loads; // loads = hours in this mode
  if (total > 0) {
    document.getElementById('t_total').value = total.toFixed(2);
    autoCalcNet();
  }
}

function autoCalcNet() {
  const total       = parseFloat(document.getElementById('t_total').value) || 0;
  const hasDiscount = document.getElementById('t_hasDiscount').checked;
  const discType    = document.getElementById('t_discountType').value;
  const discVal     = parseFloat(document.getElementById('t_discount').value) || 0;

  // Update label
  document.getElementById('t_discountLabel').textContent = discType === 'pct' ? 'Descuento (%)' : 'Descuento ($)';

  let discountAmt = 0;
  if (hasDiscount && discVal > 0) {
    discountAmt = discType === 'pct' ? (total * discVal / 100) : discVal;
  }
  const net = Math.max(0, total - discountAmt);
  document.getElementById('t_net').value = net.toFixed(2);
  document.getElementById('t_discountDisplay').textContent = fmtAmt(discountAmt);
}

function saveTicket() {
  const num  = document.getElementById('t_num').value.trim();
  const date = document.getElementById('t_date').value;
  const from = document.getElementById('t_from').value.trim();
  const to   = document.getElementById('t_to').value.trim();
  if (!num || !date) { toast('⚠ Ticket # y Fecha son requeridos', true); return; }

  const driverId = document.getElementById('t_driver').value;
  const truckId  = document.getElementById('t_truck').value;
  const driver   = DB.drivers.find(d => d.id === driverId);
  const truck    = DB.trucks.find(t => t.id === truckId);

  const hasDiscount = document.getElementById('t_hasDiscount').checked;
  const discountAmt = hasDiscount ? (parseFloat(document.getElementById('t_discountDisplay').textContent.replace(/[$,]/g,'')) || 0) : 0;

  const record = {
    id: t_editId || uid(), num, date,
    driverId, driverName: driver ? `${driver.first} ${driver.last}` : '',
    truckId, truckNum: truck ? truck.num : '',
    brokerId: document.getElementById('t_broker').value,
    brokerName: (DB.brokers.find(b => b.id === document.getElementById('t_broker').value)||{}).name || '',
    from, to,
    material: document.getElementById('t_material').value,
    loads:   document.getElementById('t_loads').value,
    tons:    document.getElementById('t_tons').value,
    rate:    document.getElementById('t_rate').value,
    rateType:document.getElementById('t_rateType').value,
    total:   document.getElementById('t_total').value,
    hasDiscount,
    discountType: document.getElementById('t_discountType').value,
    discountVal:  document.getElementById('t_discount').value,
    discountAmt:  discountAmt.toFixed(2),
    net:     document.getElementById('t_net').value,
    notes:   document.getElementById('t_notes').value.trim(),
  };

  if (t_editId) {
    const i = DB.tickets.findIndex(x => x.id === t_editId);
    if (i >= 0) DB.tickets[i] = record;
    toast('✓ Ticket actualizado'); cancelTicketEdit();
  } else {
    DB.tickets.push(record);
    toast('✓ Ticket guardado: ' + num); clearTicketForm();
  }
  save('tickets'); renderAll();
}

function clearTicketForm() {
  ['t_num','t_from','t_to','t_loads','t_tons','t_rate','t_total','t_net','t_discount','t_notes'].forEach(id => {
    const el = document.getElementById(id); if(el) el.value = '';
  });
  document.getElementById('t_driver').value = '';
  document.getElementById('t_truck').value = '';
  document.getElementById('t_broker').value = '';
  document.getElementById('t_material').value = '';
  document.getElementById('t_rateType').value = 'ton';
  document.getElementById('t_hasDiscount').checked = false;
  document.getElementById('t_discountType').value = 'pct';
  document.getElementById('t_discountFields').style.display = 'none';
  document.getElementById('t_discountDisplay').textContent = '$0.00';
  document.getElementById('t_truckBadge').style.display = 'none';
  document.getElementById('t_date').value = new Date().toISOString().split('T')[0];
  document.getElementById('t_num').value = nextTicketNum();
}

function cancelTicketEdit() {
  t_editId = null;
  document.getElementById('ticketFormTitle').textContent = 'NUEVO TICKET';
  document.getElementById('t_submitBtn').textContent = 'GUARDAR TICKET';
  document.getElementById('t_submitBtn').classList.remove('edit-mode');
  document.getElementById('t_cancelBtn').style.display = 'none';
  clearTicketForm();
}

function editTicket(id) {
  const t = DB.tickets.find(x => x.id === id); if (!t) return;
  t_editId = id;
  document.getElementById('t_num').value    = t.num;
  document.getElementById('t_date').value   = t.date;
  document.getElementById('t_driver').value = t.driverId || '';
  document.getElementById('t_truck').value  = t.truckId  || '';
  onTruckSelect(document.getElementById('t_truck'));
  document.getElementById('t_broker').value = t.brokerId || '';
  document.getElementById('t_from').value   = t.from || '';
  document.getElementById('t_to').value     = t.to   || '';
  document.getElementById('t_material').value = t.material || '';
  document.getElementById('t_loads').value    = t.loads    || '';
  document.getElementById('t_tons').value     = t.tons     || '';
  document.getElementById('t_rate').value     = t.rate     || '';
  document.getElementById('t_rateType').value = t.rateType || 'ton';
  document.getElementById('t_total').value    = t.total    || '';
  document.getElementById('t_hasDiscount').checked = !!t.hasDiscount;
  document.getElementById('t_discountType').value  = t.discountType || 'pct';
  document.getElementById('t_discount').value      = t.discountVal  || '';
  document.getElementById('t_discountFields').style.display = t.hasDiscount ? 'block' : 'none';
  document.getElementById('t_discountDisplay').textContent = fmtAmt(t.discountAmt || 0);
  document.getElementById('t_net').value = t.net || t.total || '';
  document.getElementById('t_notes').value = t.notes || '';
  document.getElementById('ticketFormTitle').textContent = 'EDITAR TICKET';
  document.getElementById('t_submitBtn').textContent = 'ACTUALIZAR';
  document.getElementById('t_submitBtn').classList.add('edit-mode');
  document.getElementById('t_cancelBtn').style.display = 'block';
  document.querySelector('#page-tickets .form-card').scrollIntoView({behavior:'smooth'});
}

function renderTickets() {
  const q = (document.getElementById('t_search').value||'').toLowerCase();
  const wt = DB.tickets.filter(t => isInWeek(t.date, weekOffset));
  const filtered = wt.filter(t => !q ||
    (t.num||'').toLowerCase().includes(q) ||
    (t.driverName||'').toLowerCase().includes(q) ||
    (t.truckNum||'').toLowerCase().includes(q) ||
    (t.brokerName||'').toLowerCase().includes(q) ||
    (t.from||'').toLowerCase().includes(q) ||
    (t.to||'').toLowerCase().includes(q) ||
    (t.material||'').toLowerCase().includes(q)
  ).sort((a,b) => a.date.localeCompare(b.date) || a.num.localeCompare(b.num));

  document.getElementById('t_countBadge').textContent = filtered.length;

  const tbody = document.getElementById('t_tbody');
  if (!filtered.length) {
    tbody.innerHTML = `<tr><td colspan="11"><div class="empty-state"><div class="icon">🎫</div><p>Sin tickets esta semana</p></div></td></tr>`;
    document.getElementById('t_tfoot').innerHTML = '';
  } else {
    tbody.innerHTML = filtered.map(t => {
      const netVal  = parseFloat(t.net  || t.total) || 0;
      const totVal  = parseFloat(t.total) || 0;
      const discVal = parseFloat(t.discountAmt) || 0;
      const discBadge = t.hasDiscount && discVal > 0
        ? `<span style="background:rgba(224,82,82,.15);color:var(--danger);border:1px solid rgba(224,82,82,.3);padding:2px 7px;border-radius:10px;font-size:0.62rem;font-family:'IBM Plex Mono',monospace;white-space:nowrap">−${fmtAmt(discVal)}</span>`
        : `<span style="color:var(--muted);font-size:0.7rem">—</span>`;
      return `<tr>
        <td><span class="mono accent">${t.num}</span></td>
        <td><span class="mono muted" style="font-size:0.72rem">${fmtDate(t.date)}</span></td>
        <td>
          <div style="font-size:0.82rem">${t.driverName || '—'}</div>
          <div style="font-size:0.68rem;color:var(--muted);font-family:'IBM Plex Mono',monospace">${t.truckNum || ''}</div>
        </td>
        <td style="font-size:0.78rem;color:var(--label)">${t.brokerName || '—'}</td>
        <td>${matBadge(t.material)}</td>
        <td class="mono" style="text-align:right">${t.loads||'—'}</td>
        <td class="mono" style="text-align:right;font-size:0.8rem">${t.rate ? fmtAmt(t.rate) : '—'}<div style="font-size:0.6rem;color:var(--muted)">${t.rateType||''}</div></td>
        <td class="mono" style="color:var(--success);text-align:right">${fmtAmt(totVal)}</td>
        <td style="text-align:center">${discBadge}</td>
        <td class="mono" style="color:var(--accent);font-weight:700;text-align:right;font-size:0.95rem">${fmtAmt(netVal)}</td>
        <td><div class="actions">
          <button class="btn-icon btn-edit" onclick="editTicket('${t.id}')">✏</button>
          <button class="btn-icon btn-del" onclick="openDeleteModal('${t.id}','tickets')">🗑</button>
        </div></td>
      </tr>`;
    }).join('');

    const tL  = filtered.reduce((s,t) => s + (parseFloat(t.loads)||0), 0);
    const tA  = filtered.reduce((s,t) => s + (parseFloat(t.total)||0), 0);
    const tD  = filtered.reduce((s,t) => s + (parseFloat(t.discountAmt)||0), 0);
    const tN  = filtered.reduce((s,t) => s + (parseFloat(t.net||t.total)||0), 0);
    document.getElementById('t_tfoot').innerHTML = `<tr class="totals-row">
      <td colspan="5" style="text-align:right;font-size:0.65rem;letter-spacing:2px">TOTALES</td>
      <td style="text-align:right">${tL}</td>
      <td></td>
      <td style="text-align:right;color:var(--success)">${fmtAmt(tA)}</td>
      <td style="text-align:center;color:var(--danger);font-size:0.78rem">${tD>0?'−'+fmtAmt(tD):'—'}</td>
      <td style="text-align:right;color:var(--accent);font-weight:700">${fmtAmt(tN)}</td>
      <td></td>
    </tr>`;
  }

  // Stats
  const tL2 = wt.reduce((s,t) => s + (parseFloat(t.loads)||0), 0);
  const tA2 = wt.reduce((s,t) => s + (parseFloat(t.total)||0), 0);
  const tD2 = wt.reduce((s,t) => s + (parseFloat(t.discountAmt)||0), 0);
  const tN2 = wt.reduce((s,t) => s + (parseFloat(t.net||t.total)||0), 0);
  document.getElementById('stTickets').textContent = wt.length;
  document.getElementById('stLoads').textContent   = tL2;
  document.getElementById('stTotal').textContent   = fmtAmt(tA2);
  document.getElementById('stDiscount').textContent = fmtAmt(tD2);
  document.getElementById('stNet').textContent      = fmtAmt(tN2);
}


// ════════════════════════════════════════════════
//  TRUCKS
// ════════════════════════════════════════════════
let tk_editId = null;
function saveTruck() {
  const num = document.getElementById('tk_num').value.trim();
  const make = document.getElementById('tk_make').value.trim();
  if (!num || !make) { toast('⚠ No. Unidad y Marca son requeridos', true); return; }
  const rec = {
    id: tk_editId || uid(),
    num, year: document.getElementById('tk_year').value,
    make, model: document.getElementById('tk_model').value.trim(),
    color: document.getElementById('tk_color').value.trim(),
    type: document.getElementById('tk_type').value,
    plate: document.getElementById('tk_plate').value.trim(),
    state: document.getElementById('tk_state').value,
    vin: document.getElementById('tk_vin').value.trim(),
    gvwr: document.getElementById('tk_gvwr').value,
    payload: document.getElementById('tk_payload').value,
    capacity: document.getElementById('tk_capacity').value,
    insurance: document.getElementById('tk_insurance').value,
    dot: document.getElementById('tk_dot').value,
    status: document.getElementById('tk_status').value,
    notes: document.getElementById('tk_notes').value.trim(),
  };
  if (tk_editId) {
    const i = DB.trucks.findIndex(x => x.id === tk_editId);
    if (i >= 0) DB.trucks[i] = rec;
    toast('✓ Camión actualizado'); cancelTruckEdit();
  } else {
    DB.trucks.push(rec);
    toast('✓ Camión guardado: ' + num); clearTruckForm();
  }
  save('trucks'); renderAll();
}
function clearTruckForm() {
  ['tk_num','tk_year','tk_make','tk_model','tk_color','tk_plate','tk_vin','tk_gvwr','tk_payload','tk_capacity','tk_insurance','tk_dot','tk_notes'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('tk_type').value = 'dump';
  document.getElementById('tk_state').value = 'FL';
  document.getElementById('tk_status').value = 'active';
}
function cancelTruckEdit() {
  tk_editId = null;
  document.getElementById('truckFormTitle').textContent = 'NUEVO CAMIÓN';
  document.getElementById('tk_submitBtn').textContent = 'GUARDAR CAMIÓN';
  document.getElementById('tk_submitBtn').classList.remove('edit-mode');
  document.getElementById('tk_cancelBtn').style.display = 'none';
  clearTruckForm();
}
function editTruck(id) {
  const t = DB.trucks.find(x => x.id === id); if (!t) return;
  tk_editId = id;
  document.getElementById('tk_num').value = t.num;
  document.getElementById('tk_year').value = t.year;
  document.getElementById('tk_make').value = t.make;
  document.getElementById('tk_model').value = t.model;
  document.getElementById('tk_color').value = t.color;
  document.getElementById('tk_type').value = t.type;
  document.getElementById('tk_plate').value = t.plate;
  document.getElementById('tk_state').value = t.state;
  document.getElementById('tk_vin').value = t.vin;
  document.getElementById('tk_gvwr').value = t.gvwr;
  document.getElementById('tk_payload').value = t.payload;
  document.getElementById('tk_capacity').value = t.capacity;
  document.getElementById('tk_insurance').value = t.insurance;
  document.getElementById('tk_dot').value = t.dot;
  document.getElementById('tk_status').value = t.status;
  document.getElementById('tk_notes').value = t.notes;
  document.getElementById('truckFormTitle').textContent = 'EDITAR CAMIÓN';
  document.getElementById('tk_submitBtn').textContent = 'ACTUALIZAR';
  document.getElementById('tk_submitBtn').classList.add('edit-mode');
  document.getElementById('tk_cancelBtn').style.display = 'block';
  document.querySelector('#page-trucks .form-card').scrollIntoView({behavior:'smooth'});
}
function renderTrucks() {
  const q = (document.getElementById('tk_search').value||'').toLowerCase();
  const list = DB.trucks.filter(t => !q || (t.num||'').toLowerCase().includes(q) || (t.make||'').toLowerCase().includes(q) || (t.plate||'').toLowerCase().includes(q));
  document.getElementById('tk_countBadge').textContent = list.length;

  const active = DB.trucks.filter(t => t.status === 'active').length;
  const inactive = DB.trucks.filter(t => t.status === 'inactive').length;
  const maint = DB.trucks.filter(t => t.status === 'maintenance').length;
  document.getElementById('tk_statTotal').textContent = DB.trucks.length;
  document.getElementById('tk_statActive').textContent = active;
  document.getElementById('tk_statInactive').textContent = inactive;
  document.getElementById('tk_statMaint').textContent = maint;

  document.getElementById('tk_tbody').innerHTML = !list.length
    ? `<tr><td colspan="9"><div class="empty-state"><div class="icon">🚛</div><p>Sin camiones registrados</p></div></td></tr>`
    : list.map(t => `<tr>
        <td>
          <div style="display:flex;align-items:center;gap:8px">
            <div class="truck-avatar" style="background:var(--surface3)">🚛</div>
            <div><div class="mono accent" style="font-weight:600">${t.num}</div>
            <div style="font-size:0.68rem;color:var(--muted)">${t.color||''}</div></div>
          </div>
        </td>
        <td><div>${t.year} ${t.make}</div><div style="font-size:0.68rem;color:var(--muted)">${t.model||''}</div></td>
        <td>${truckTypeBadge(t.type)}</td>
        <td class="mono" style="font-size:0.78rem">${t.plate||'—'}<br><span style="font-size:0.65rem;color:var(--muted)">${t.state||''}</span></td>
        <td class="mono" style="font-size:0.78rem">${t.payload ? t.payload + ' ton' : '—'}</td>
        <td><span class="badge ${expireClass(t.insurance)}">${t.insurance ? fmtDate(t.insurance) : '—'}</span></td>
        <td><span class="badge ${expireClass(t.dot)}">${t.dot ? fmtDate(t.dot) : '—'}</span></td>
        <td>${statusBadge(t.status)}</td>
        <td><div class="actions">
          <button class="btn-icon btn-edit" onclick="editTruck('${t.id}')">✏</button>
          <button class="btn-icon btn-del" onclick="openDeleteModal('${t.id}','trucks')">🗑</button>
        </div></td>
      </tr>`).join('');
}

// ════════════════════════════════════════════════
//  DRIVERS
// ════════════════════════════════════════════════
let dr_editId = null;
function saveDriver() {
  const first = document.getElementById('dr_first').value.trim();
  const last  = document.getElementById('dr_last').value.trim();
  if (!first || !last) { toast('⚠ Nombre y Apellido son requeridos', true); return; }
  const truckId = document.getElementById('dr_assignedTruck').value;
  const truck   = DB.trucks.find(t => t.id === truckId);
  const rec = {
    id: dr_editId || uid(),
    first, last,
    phone: document.getElementById('dr_phone').value.trim(),
    email: document.getElementById('dr_email').value.trim(),
    cdl: document.getElementById('dr_cdl').value.trim(),
    cdlClass: document.getElementById('dr_cdlClass').value,
    cdlExp: document.getElementById('dr_cdlExp').value,
    cdlState: document.getElementById('dr_cdlState').value,
    medical: document.getElementById('dr_medical').value,
    truckId, truckNum: truck ? truck.num : '',
    payRate: document.getElementById('dr_payRate').value,
    payType: document.getElementById('dr_payType').value,
    status: document.getElementById('dr_status').value,
    notes: document.getElementById('dr_notes').value.trim(),
  };
  if (dr_editId) {
    const i = DB.drivers.findIndex(x => x.id === dr_editId);
    if (i >= 0) DB.drivers[i] = rec;
    toast('✓ Chofer actualizado'); cancelDriverEdit();
  } else {
    DB.drivers.push(rec);
    toast('✓ Chofer guardado: ' + first + ' ' + last); clearDriverForm();
  }
  save('drivers'); renderAll();
}
function clearDriverForm() {
  ['dr_first','dr_last','dr_phone','dr_email','dr_cdl','dr_cdlExp','dr_medical','dr_payRate','dr_notes'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('dr_cdlClass').value = 'A';
  document.getElementById('dr_cdlState').value = 'FL';
  document.getElementById('dr_payType').value = 'ton';
  document.getElementById('dr_status').value = 'active';
  document.getElementById('dr_assignedTruck').value = '';
}
function cancelDriverEdit() {
  dr_editId = null;
  document.getElementById('driverFormTitle').textContent = 'NUEVO CHOFER';
  document.getElementById('dr_submitBtn').textContent = 'GUARDAR CHOFER';
  document.getElementById('dr_submitBtn').classList.remove('edit-mode');
  document.getElementById('dr_cancelBtn').style.display = 'none';
  clearDriverForm();
}
function editDriver(id) {
  const d = DB.drivers.find(x => x.id === id); if (!d) return;
  dr_editId = id;
  document.getElementById('dr_first').value = d.first;
  document.getElementById('dr_last').value = d.last;
  document.getElementById('dr_phone').value = d.phone;
  document.getElementById('dr_email').value = d.email;
  document.getElementById('dr_cdl').value = d.cdl;
  document.getElementById('dr_cdlClass').value = d.cdlClass;
  document.getElementById('dr_cdlExp').value = d.cdlExp;
  document.getElementById('dr_cdlState').value = d.cdlState;
  document.getElementById('dr_medical').value = d.medical;
  document.getElementById('dr_assignedTruck').value = d.truckId || '';
  document.getElementById('dr_payRate').value = d.payRate;
  document.getElementById('dr_payType').value = d.payType;
  document.getElementById('dr_status').value = d.status;
  document.getElementById('dr_notes').value = d.notes;
  document.getElementById('driverFormTitle').textContent = 'EDITAR CHOFER';
  document.getElementById('dr_submitBtn').textContent = 'ACTUALIZAR';
  document.getElementById('dr_submitBtn').classList.add('edit-mode');
  document.getElementById('dr_cancelBtn').style.display = 'block';
  document.querySelector('#page-drivers .form-card').scrollIntoView({behavior:'smooth'});
}
function renderDrivers() {
  const q = (document.getElementById('dr_search').value||'').toLowerCase();
  const list = DB.drivers.filter(d => !q ||
    `${d.first} ${d.last}`.toLowerCase().includes(q) ||
    (d.cdl||'').toLowerCase().includes(q) ||
    (d.phone||'').includes(q)
  );
  document.getElementById('dr_countBadge').textContent = list.length;

  document.getElementById('dr_statTotal').textContent = DB.drivers.length;
  document.getElementById('dr_statActive').textContent = DB.drivers.filter(d => d.status === 'active').length;
  document.getElementById('dr_statCDLA').textContent = DB.drivers.filter(d => d.cdlClass === 'A').length;
  document.getElementById('dr_statCDLB').textContent = DB.drivers.filter(d => d.cdlClass === 'B').length;

  const cdlColor = {'A':'badge-yellow','B':'badge-blue','C':'badge-purple','none':'badge-red'};
  document.getElementById('dr_tbody').innerHTML = !list.length
    ? `<tr><td colspan="10"><div class="empty-state"><div class="icon">👤</div><p>Sin choferes registrados</p></div></td></tr>`
    : list.map(d => `<tr>
        <td>
          <div style="font-weight:600">${d.first} ${d.last}</div>
          <div style="font-size:0.68rem;color:var(--muted)">${d.email||''}</div>
        </td>
        <td class="mono" style="font-size:0.78rem">${d.phone||'—'}</td>
        <td class="mono" style="font-size:0.75rem">${d.cdl||'—'}</td>
        <td><span class="badge ${cdlColor[d.cdlClass]||''}">CDL-${d.cdlClass}</span></td>
        <td><span class="badge ${expireClass(d.cdlExp)}">${d.cdlExp ? fmtDate(d.cdlExp) : '—'}</span></td>
        <td><span class="badge ${expireClass(d.medical)}">${d.medical ? fmtDate(d.medical) : '—'}</span></td>
        <td class="mono accent" style="font-size:0.75rem">${d.truckNum||'—'}</td>
        <td class="mono" style="font-size:0.72rem">${d.payRate ? fmtAmt(d.payRate)+'/'+d.payType : '—'}</td>
        <td>${statusBadge(d.status)}</td>
        <td><div class="actions">
          <button class="btn-icon btn-edit" onclick="editDriver('${d.id}')">✏</button>
          <button class="btn-icon btn-del" onclick="openDeleteModal('${d.id}','drivers')">🗑</button>
        </div></td>
      </tr>`).join('');
}

// ════════════════════════════════════════════════
//  COMPANIES
// ════════════════════════════════════════════════
// ════════════════════════════════════════════════
//  BROKERS
// ════════════════════════════════════════════════
let br_editId = null;
function saveBroker() {
  const name = document.getElementById('br_name').value.trim();
  if (!name) { toast('⚠ Nombre de broker requerido', true); return; }
  const rec = {
    id: br_editId || uid(), name,
    contact: document.getElementById('br_contact').value.trim(),
    phone: document.getElementById('br_phone').value.trim(),
    email: document.getElementById('br_email').value.trim(),
    whatsapp: document.getElementById('br_whatsapp').value.trim(),
    address: document.getElementById('br_address').value.trim(),
    city: document.getElementById('br_city').value.trim(),
    state: document.getElementById('br_state').value,
    commission: document.getElementById('br_commission').value,
    type: document.getElementById('br_type').value,
    areas: document.getElementById('br_areas').value.trim(),
    status: document.getElementById('br_status').value,
    notes: document.getElementById('br_notes').value.trim(),
  };
  if (br_editId) {
    const i = DB.brokers.findIndex(x => x.id === br_editId);
    if (i >= 0) DB.brokers[i] = rec;
    toast('✓ Broker actualizado'); cancelBrokerEdit();
  } else {
    DB.brokers.push(rec);
    toast('✓ Broker guardado: ' + name); clearBrokerForm();
  }
  save('brokers'); renderAll();
}
function clearBrokerForm() {
  ['br_name','br_contact','br_phone','br_email','br_whatsapp','br_address','br_city','br_commission','br_areas','br_notes'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('br_type').value = 'dispatcher';
  document.getElementById('br_state').value = 'FL';
  document.getElementById('br_status').value = 'active';
}
function cancelBrokerEdit() {
  br_editId = null;
  document.getElementById('brokerFormTitle').textContent = 'NUEVO BROKER';
  document.getElementById('br_submitBtn').textContent = 'GUARDAR BROKER';
  document.getElementById('br_cancelBtn').style.display = 'none';
  clearBrokerForm();
}
function editBroker(id) {
  const b = DB.brokers.find(x => x.id === id); if (!b) return;
  br_editId = id;
  document.getElementById('br_name').value = b.name;
  document.getElementById('br_contact').value = b.contact;
  document.getElementById('br_phone').value = b.phone;
  document.getElementById('br_email').value = b.email;
  document.getElementById('br_whatsapp').value = b.whatsapp;
  document.getElementById('br_address').value = b.address;
  document.getElementById('br_city').value = b.city;
  document.getElementById('br_state').value = b.state;
  document.getElementById('br_commission').value = b.commission;
  document.getElementById('br_type').value = b.type;
  document.getElementById('br_areas').value = b.areas;
  document.getElementById('br_status').value = b.status;
  document.getElementById('br_notes').value = b.notes;
  document.getElementById('brokerFormTitle').textContent = 'EDITAR BROKER';
  document.getElementById('br_submitBtn').textContent = 'ACTUALIZAR';
  document.getElementById('br_cancelBtn').style.display = 'block';
  document.querySelector('#page-brokers .form-card').scrollIntoView({behavior:'smooth'});
}
function renderBrokers() {
  const q = (document.getElementById('br_search').value||'').toLowerCase();
  const list = DB.brokers.filter(b => !q || (b.name||'').toLowerCase().includes(q) || (b.contact||'').toLowerCase().includes(q) || (b.areas||'').toLowerCase().includes(q));
  document.getElementById('br_countBadge').textContent = list.length;
  const typeMap = {dispatcher:'badge-blue',freight:'badge-yellow',construction:'badge-green',independent:'badge-purple',other:''};
  document.getElementById('br_tbody').innerHTML = !list.length
    ? `<tr><td colspan="9"><div class="empty-state"><div class="icon">🤝</div><p>Sin brokers registrados</p></div></td></tr>`
    : list.map(b => `<tr>
        <td>
          <div style="font-weight:600">${b.name}</div>
          <div style="font-size:0.68rem;color:var(--muted)">${b.city||''} ${b.state||''}</div>
        </td>
        <td style="font-size:0.8rem">${b.contact||'—'}</td>
        <td class="mono" style="font-size:0.75rem">${b.phone||'—'}</td>
        <td style="font-size:0.75rem">${b.email||'—'}</td>
        <td><span class="badge ${typeMap[b.type]||''}">${b.type}</span></td>
        <td class="mono accent">${b.commission ? b.commission+'%' : '—'}</td>
        <td style="font-size:0.75rem;color:var(--muted)">${b.areas||'—'}</td>
        <td>${statusBadge(b.status)}</td>
        <td><div class="actions">
          <button class="btn-icon btn-edit" onclick="editBroker('${b.id}')">✏</button>
          <button class="btn-icon btn-del" onclick="openDeleteModal('${b.id}','brokers')">🗑</button>
        </div></td>
      </tr>`).join('');
}

// ════════════════════════════════════════════════
//  EXPORT CSV
// ════════════════════════════════════════════════
function exportCSV() {
  const wt = DB.tickets.filter(t => isInWeek(t.date, weekOffset));
  if (!wt.length) { toast('Sin tickets para exportar', true); return; }
  const hd = ['Ticket','Fecha','Driver','Truck','Company','Broker','Desde','Hasta','Material','Loads','Tons','Rate','Rate Type','Total'];
  const rows = wt.map(t => [t.num,t.date,t.driverName,t.truckNum,t.companyName,t.brokerName,t.from,t.to,t.material,t.loads,t.tons,t.rate,t.rateType,t.total].map(v => `"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
  const csv = [hd.join(','),...rows].join('\n');
  const {mon, sun} = getWeekRange(weekOffset);
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download = `tickets_${mon.toISOString().split('T')[0]}_${sun.toISOString().split('T')[0]}.csv`;
  a.click();
  toast('✓ CSV exportado');
}

// ════════════════════════════════════════════════
//  EARNINGS DATA
// ════════════════════════════════════════════════
DB.earnings = JSON.parse(localStorage.getItem('dt_earnings') || '[]');

// Extend save to handle earnings
const _origSave = save;
// Already defined above, just add persistence call inline

let ewOffset = 0;

function updateWeekE() {
  const {mon, sun} = getWeekRange(ewOffset);
  document.getElementById('ew_weekLabel').textContent = `${fmtD(mon)} — ${fmtD(sun)}, ${mon.getFullYear()}`;
  document.getElementById('ew_weekTitle').textContent = `SEMANA ${getWeekNum(mon)}`;
}
function changeWeekE(d) { ewOffset += d; updateWeekE(); renderEarnings(); }
function goToCurrentWeekE() { ewOffset = 0; updateWeekE(); renderEarnings(); }

// Populate broker select in earnings form
function populateEarningsTrucks() {
  const sel = document.getElementById('ew_truck');
  if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">-- Camión --</option>';
  DB.trucks.filter(t=>t.status!=='inactive').forEach(t=>{
    const o=document.createElement('option'); o.value=t.id; o.textContent=t.num || (t.make+' '+(t.model||'')); sel.appendChild(o);
  });
  sel.value = cur;
}
function syncQuickTruckNum(){
  const sel=document.getElementById('ew_truck');
  const t=DB.trucks.find(x=>x.id===sel.value);
  if (!t) return;
  const hint=document.getElementById('ew_ticketHint');
  hint.textContent='✓ Camión: '+(t.num||'—'); hint.style.display='flex';
}
function autoCalcQuickTotal(){
  const qty=parseFloat(document.getElementById('ew_qty')?.value)||0;
  const price=parseFloat(document.getElementById('ew_price')?.value)||0;
  const totalEl=document.getElementById('ew_total');
  if (totalEl) {
    const calc=qty>0? qty*price : price;
    totalEl.value = calc ? calc.toFixed(2) : '';
  }
  autoCalcQuickNet();
}
function autoCalcQuickNet(){
  const total=parseFloat(document.getElementById('ew_total')?.value)||0;
  const pct=parseFloat(document.getElementById('ew_brokerPct')?.value)||0;
  const disc = total * (pct/100);
  const net = total - disc;
  const el=document.getElementById('ew_netPreview');
  if (el) el.textContent = `NET: ${fmtAmt(net)}${pct?`  (Desc ${fmtAmt(disc)})`:''}`;
}

function populateEarningsBrokers() {
  const sel = document.getElementById('ew_broker');
  const cv = sel.value;
  sel.innerHTML = '<option value="">-- Broker --</option>';
  DB.brokers.filter(b => b.status === 'active').forEach(b => {
    const o = document.createElement('option');
    o.value = b.id; o.textContent = b.name;
    sel.appendChild(o);
  });
  // Also add "Sin broker" fallback
  const ob = document.createElement('option');
  ob.value = '_none'; ob.textContent = '(Sin Broker)';
  sel.appendChild(ob);
  sel.value = cv;
}

// Auto-fill truck from ticket number
function autoFillTruckFromTicket() {
  const num = document.getElementById('ew_ticketNum').value.trim();
  const hint = document.getElementById('ew_ticketHint');
  const truckSel = document.getElementById('ew_truck');
  const ac = document.getElementById('ew_autocomplete');

  if (!num) {
    if (truckSel) truckSel.value = '';
    hint.style.display = 'none';
    ac.style.display = 'none';
    return;
  }

  // Find matching tickets
  const matches = DB.tickets.filter(t =>
    (t.num||'').toLowerCase().includes(num.toLowerCase())
  ).slice(0, 8);

  // Exact match
  const exact = DB.tickets.find(t => t.num.toLowerCase() === num.toLowerCase());
  if (exact) {
    if (truckSel && exact.truckId) truckSel.value = exact.truckId;
    const tkExact = DB.trucks.find(t => t.id === exact.truckId);
    const truckTxt = exact.truckNum || (tkExact ? tkExact.num : '');
    hint.textContent = '✓ ' + (truckTxt ? `Camión: ${truckTxt}` : 'Ticket encontrado');
    hint.style.display = 'flex';
    ac.style.display = 'none';
    // Auto-fill price if not set
    if (!document.getElementById('ew_price').value && exact.total) { document.getElementById('ew_price').value = parseFloat(exact.total).toFixed(2); }
    if (!document.getElementById('ew_total').value && exact.total) { document.getElementById('ew_total').value = parseFloat(exact.total).toFixed(2); }
    if (!document.getElementById('ew_qty').value && exact.loads) { document.getElementById('ew_qty').value = exact.loads; }
    if (!document.getElementById('ew_brokerPct').value && exact.discountType === 'pct' && exact.discount) { document.getElementById('ew_brokerPct').value = exact.discount; }
    autoCalcQuickNet();
    // Auto-fill broker if not selected
    if (!document.getElementById('ew_broker').value && exact.brokerId) {
      document.getElementById('ew_broker').value = exact.brokerId;
    }
    return;
  }

  hint.style.display = 'none';
  if (truckSel) truckSel.value = '';

  // Show autocomplete
  if (matches.length > 0) {
    ac.style.display = 'block';
    ac.innerHTML = matches.map(t => {
      const tk = DB.trucks.find(x => x.id === t.truckId);
      const truckStr = t.truckNum || (tk ? tk.num : '') || '—';
      const broker = DB.brokers.find(b => b.id === t.brokerId);
      return `<div onclick="selectTicketSuggestion('${t.id}')" style="padding:9px 14px;cursor:pointer;border-bottom:1px solid var(--border);font-family:'IBM Plex Mono',monospace;font-size:0.75rem;display:flex;align-items:center;gap:12px;transition:background .1s" onmouseover="this.style.background='var(--surface3)'" onmouseout="this.style.background=''">`
        + `<span style="color:var(--accent);font-weight:600;min-width:60px">${t.num}</span>`
        + `<span style="color:var(--label)">${fmtDate(t.date)}</span>`
        + `<span style="color:var(--info)">🚛 ${truckStr}</span>`
        + `<span style="color:var(--muted);margin-left:auto">${broker ? broker.name : ''}</span>`
        + (t.total ? `<span style="color:var(--success)">${fmtAmt(t.total)}</span>` : '')
        + `</div>`;
    }).join('');
  } else {
    ac.style.display = 'none';
  }
}

function selectTicketSuggestion(ticketId) {
  const t = DB.tickets.find(x => x.id === ticketId); if (!t) return;
  document.getElementById('ew_ticketNum').value = t.num;
  const tk = DB.trucks.find(x => x.id === t.truckId);
  if (t.truckId) document.getElementById('ew_truck').value = t.truckId;
  if (t.total && !document.getElementById('ew_price').value) document.getElementById('ew_price').value = parseFloat(t.total).toFixed(2);
  if (t.total && !document.getElementById('ew_total').value) document.getElementById('ew_total').value = parseFloat(t.total).toFixed(2);
  if (t.loads && !document.getElementById('ew_qty').value) document.getElementById('ew_qty').value = t.loads;
  if (t.discountType==='pct' && t.discount && !document.getElementById('ew_brokerPct').value) document.getElementById('ew_brokerPct').value = t.discount;
  autoCalcQuickNet();
  if (t.brokerId && !document.getElementById('ew_broker').value)
    document.getElementById('ew_broker').value = t.brokerId;
  document.getElementById('ew_autocomplete').style.display = 'none';
  const hint = document.getElementById('ew_ticketHint');
  hint.textContent = '✓ Camión: ' + ((tk&&tk.num)||t.truckNum||'N/A');
  hint.style.display = 'flex';
  document.getElementById('ew_price').focus();
}

function addEarningEntry() {
  const brokerId = document.getElementById('ew_broker').value;
  const date     = document.getElementById('ew_date').value;
  const ticketNum= document.getElementById('ew_ticketNum').value.trim();
  const truckId  = document.getElementById('ew_truck').value;
  const truckObj = DB.trucks.find(t=>t.id===truckId);
  const truckNum = (truckObj && truckObj.num) || '';
  const qty      = parseFloat(document.getElementById('ew_qty').value) || 0;
  const price    = parseFloat(document.getElementById('ew_price').value) || 0;
  const totalVal = parseFloat(document.getElementById('ew_total').value) || price;
  const brokerPct= parseFloat(document.getElementById('ew_brokerPct').value) || 0;
  const netPrice = totalVal - (totalVal * brokerPct / 100);

  if (!date || !ticketNum || totalVal <= 0) {
    toast('⚠ Fecha, No. Ticket y Total son requeridos', true); return;
  }

  // Check for duplicate ticket in same week
  const wEntries = DB.earnings.filter(e => isInWeek(e.date, ewOffset));
  if (wEntries.find(e => e.ticketNum.toLowerCase() === ticketNum.toLowerCase())) {
    toast('⚠ Ticket ' + ticketNum + ' ya registrado esta semana', true); return;
  }

  const broker = DB.brokers.find(b => b.id === brokerId);
  const brokerName = brokerId === '_none' ? 'Sin Broker' : (broker ? broker.name : 'Sin Broker');

  const entry = {
    id: uid(),
    brokerId: brokerId || '_none',
    brokerName,
    date, ticketNum, truckId, truckNum, qty, unitPrice: price, total: totalVal, brokerPct, price: netPrice,
  };

  DB.earnings.push(entry);
  localStorage.setItem('dt_earnings', JSON.stringify(DB.earnings));
  toast('✓ ' + ticketNum + ' — NET ' + fmtAmt(netPrice));

  // Clear entry fields (keep broker & date)
  document.getElementById('ew_ticketNum').value = '';
  document.getElementById('ew_truck').value = '';
  document.getElementById('ew_qty').value = '';
  document.getElementById('ew_price').value = '';
  document.getElementById('ew_total').value = '';
  document.getElementById('ew_brokerPct').value = '';
  autoCalcQuickNet();
  document.getElementById('ew_ticketHint').style.display = 'none';
  document.getElementById('ew_autocomplete').style.display = 'none';
  document.getElementById('ew_ticketNum').focus();

  renderEarnings();
}

function deleteEarning(id) {
  DB.earnings = DB.earnings.filter(e => e.id !== id);
  localStorage.setItem('dt_earnings', JSON.stringify(DB.earnings));
  renderEarnings();
  toast('🗑 Entrada eliminada');
}

const BROKER_COLORS = [
  '#f5a623','#4a9fcf','#4cbfb0','#9b7fd4','#4caf7d','#e05252','#e8890a','#7a9fc0'
];

function renderEarnings() {
  updateWeekE();
  populateEarningsBrokers();
  populateEarningsTrucks();

  const wEntries = DB.earnings.filter(e => isInWeek(e.date, ewOffset));
  const total = wEntries.reduce((s,e) => s + e.price, 0);
  const uniqueTrucks = new Set(wEntries.map(e => e.truckNum).filter(Boolean)).size;
  const uniqueBrokers = new Set(wEntries.map(e => e.brokerId)).size;
  const avg = wEntries.length ? total / wEntries.length : 0;

  // Hero
  document.getElementById('ew_heroTotal').textContent = fmtAmt(total);
  document.getElementById('ew_heroSub').textContent = `${wEntries.length} tickets · ${uniqueBrokers} broker${uniqueBrokers !== 1 ? 's' : ''}`;
  document.getElementById('ew_heroCount').textContent = wEntries.length;
  document.getElementById('ew_heroTrucks').textContent = uniqueTrucks;
  document.getElementById('ew_heroBrokers').textContent = uniqueBrokers;
  document.getElementById('ew_heroAvg').textContent = fmtAmt(avg);

  // Group by broker
  const groups = {};
  wEntries.forEach(e => {
    const key = e.brokerId;
    if (!groups[key]) groups[key] = { name: e.brokerName, entries: [], total: 0 };
    groups[key].entries.push(e);
    groups[key].total += e.price;
  });

  const sorted = Object.entries(groups).sort((a,b) => b[1].total - a[1].total);
  const maxTotal = sorted.length ? sorted[0][1].total : 1;

  // Footer
  const footer = document.getElementById('ew_footer');
  footer.style.display = wEntries.length ? 'flex' : 'none';
  document.getElementById('ew_footTotal').textContent = fmtAmt(total);
  document.getElementById('ew_footCount').textContent = wEntries.length;
  document.getElementById('ew_footAvg').textContent = fmtAmt(avg);
  document.getElementById('ew_footBest').textContent = sorted.length ? sorted[0][1].name : '—';
  document.getElementById('ew_monthly').textContent = fmtAmt(total * 4);
  document.getElementById('ew_progressBar').style.width = Math.min(100, (total / Math.max(total * 1.1, 1)) * 100) + '%';

  const container = document.getElementById('ew_brokerSections');

  if (!wEntries.length) {
    container.innerHTML = `<div style="text-align:center;padding:4rem 2rem;color:var(--muted)">
      <div style="font-size:3rem;margin-bottom:1rem;opacity:.3">💰</div>
      <div style="font-family:'IBM Plex Mono',monospace;font-size:0.72rem;text-transform:uppercase;letter-spacing:2px">Sin entradas esta semana</div>
      <div style="font-size:0.75rem;margin-top:8px;color:var(--muted)">Usa el formulario de arriba para registrar tus tickets</div>
    </div>`;
    return;
  }

  container.innerHTML = sorted.map(([brokerId, group], idx) => {
    const color = BROKER_COLORS[idx % BROKER_COLORS.length];
    const pct = total > 0 ? ((group.total / total) * 100).toFixed(1) : 0;
    const barPct = maxTotal > 0 ? ((group.total / maxTotal) * 100).toFixed(1) : 0;

    const rows = group.entries
      .sort((a,b) => a.date.localeCompare(b.date) || a.ticketNum.localeCompare(b.ticketNum))
      .map(e => `<tr>
        <td><span class="mono accent" style="color:${color}">${e.ticketNum}</span></td>
        <td class="mono muted" style="font-size:0.72rem">${fmtDate(e.date)}</td>
        <td>
          <div style="display:flex;align-items:center;gap:6px">
            <span style="font-size:0.9rem">🚛</span>
            <span class="mono" style="font-size:0.8rem">${e.truckNum || '<span style="color:var(--muted)">—</span>'}</span>
          </div>
        </td>
        <td class="mono">${e.qty || '—'}</td>
        <td class="mono" style="color:var(--info)">${fmtAmt(e.total || e.price)}</td>
        <td class="mono">${Number(e.brokerPct||0).toFixed(2)}%</td>
        <td class="mono" style="color:var(--success);font-weight:600;font-size:0.9rem">${fmtAmt(e.price)}</td>
        <td>
          <div style="display:flex;align-items:center;gap:4px">
            <div style="flex:1;height:3px;background:var(--surface3);border-radius:2px;min-width:60px">
              <div style="width:${total > 0 ? ((e.price/group.total)*100).toFixed(0) : 0}%;height:100%;background:${color};border-radius:2px"></div>
            </div>
            <span style="font-size:0.65rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);min-width:32px">${total > 0 ? ((e.price/total)*100).toFixed(1) : 0}%</span>
          </div>
        </td>
        <td>
          <button class="btn-icon btn-del" onclick="deleteEarning('${e.id}')" title="Eliminar">🗑</button>
        </td>
      </tr>`).join('');

    return `<div class="broker-section" id="bs_${brokerId.replace(/[^a-z0-9]/gi,'_')}">
      <div class="broker-header" onclick="toggleBrokerSection(this)" style="border-left-color:${color}">
        <div style="width:10px;height:10px;border-radius:50%;background:${color};flex-shrink:0"></div>
        <div class="broker-name">${group.name}</div>
        <div class="broker-count">${group.entries.length} ticket${group.entries.length !== 1 ? 's' : ''}</div>
        <div style="flex:1;margin:0 1rem">
          <div style="height:3px;background:var(--surface3);border-radius:2px;overflow:hidden">
            <div style="width:${barPct}%;height:100%;background:${color};border-radius:2px;transition:width .4s"></div>
          </div>
          <div style="font-size:0.62rem;color:var(--muted);font-family:'IBM Plex Mono',monospace;margin-top:3px">${pct}% del total semanal</div>
        </div>
        <div class="broker-total" style="color:${color}">${fmtAmt(group.total)}</div>
        <div class="collapse-icon" style="margin-left:12px">▼</div>
      </div>
      <div class="broker-body">
        <table>
          <thead><tr>
            <th>Ticket #</th><th>Fecha</th><th>Camión</th><th>Cant</th><th>Total</th><th>% Broker</th><th>NET</th><th>% Contrib.</th><th></th>
          </tr></thead>
          <tbody>${rows}</tbody>
          <tfoot><tr style="background:var(--surface2)">
            <td colspan="6" style="text-align:right;font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:2px;color:var(--muted)">SUBTOTAL NET</td>
            <td colspan="3" style="font-family:'IBM Plex Mono',monospace;font-weight:700;color:${color};font-size:0.95rem">${fmtAmt(group.total)}</td>
          </tr></tfoot>
        </table>
      </div>
    </div>`;
  }).join('');
}

function toggleBrokerSection(headerEl) {
  headerEl.closest('.broker-section').classList.toggle('broker-collapsed');
}

function exportEarningsCSV() {
  const wEntries = DB.earnings.filter(e => isInWeek(e.date, ewOffset));
  if (!wEntries.length) { toast('Sin entradas para exportar', true); return; }
  const hd = ['Broker','Fecha','Ticket #','Camión','Precio'];
  const rows = wEntries.map(e => [e.brokerName, e.date, e.ticketNum, e.truckNum, e.price].map(v => `"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
  const csv = [hd.join(','), ...rows].join('\n');
  const {mon, sun} = getWeekRange(ewOffset);
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
  a.download = `ganancias_${mon.toISOString().split('T')[0]}.csv`;
  a.click();
  toast('✓ CSV exportado');
}

// Close autocomplete on outside click
document.addEventListener('click', e => {
  if (!e.target.closest('#ew_ticketNum') && !e.target.closest('#ew_autocomplete'))
    document.getElementById('ew_autocomplete').style.display = 'none';
});

// ════════════════════════════════════════════════
//  CLOSING WEEK DATA
// ════════════════════════════════════════════════
DB.weekClosings = JSON.parse(localStorage.getItem('dt_weekClosings') || '{}');
function clSaveClosings() { localStorage.setItem('dt_weekClosings', JSON.stringify(DB.weekClosings)); }

let clOffset = 0;

function clWeekKey(off) { const {mon} = getWeekRange(off); return mon.toISOString().split('T')[0]; }
function clUpdateWeekUI() {
  const {mon, sun} = getWeekRange(clOffset);
  document.getElementById('cl_weekLabel').textContent = `${fmtD(mon)} — ${fmtD(sun)}, ${mon.getFullYear()}`;
  document.getElementById('cl_weekTitle').textContent = `SEMANA ${getWeekNum(mon)}`;
}
function clChangeWeek(d) { clOffset += d; clUpdateWeekUI(); renderClosing(); }
function clGoToCurrentWeek() { clOffset = 0; clUpdateWeekUI(); renderClosing(); }

function clGetState() {
  const key = clWeekKey(clOffset);
  if (!DB.weekClosings[key]) DB.weekClosings[key] = { status:'open', closedAt:null, notes:'', brokerStates:{} };
  return DB.weekClosings[key];
}
function clBrokerState(state, brokerId) {
  if (!state.brokerStates[brokerId]) state.brokerStates[brokerId] = { tickets:{} };
  return state.brokerStates[brokerId];
}
function clToggleTicket(brokerId, ticketId) {
  const state = clGetState(); const bs = clBrokerState(state, brokerId);
  if (!bs.tickets[ticketId]) bs.tickets[ticketId] = { confirmed:false, brokerPrice:'', disputed:false };
  bs.tickets[ticketId].confirmed = !bs.tickets[ticketId].confirmed;
  if (!bs.tickets[ticketId].confirmed) bs.tickets[ticketId].disputed = false;
  clSaveClosings(); renderClosing();
}
function clToggleDispute(brokerId, ticketId) {
  const state = clGetState(); const bs = clBrokerState(state, brokerId);
  if (!bs.tickets[ticketId]) bs.tickets[ticketId] = { confirmed:false, brokerPrice:'', disputed:false };
  bs.tickets[ticketId].disputed = !bs.tickets[ticketId].disputed;
  if (bs.tickets[ticketId].disputed) bs.tickets[ticketId].confirmed = false;
  clSaveClosings(); renderClosing();
}
function clSetBrokerPrice(brokerId, ticketId, val) {
  const state = clGetState(); const bs = clBrokerState(state, brokerId);
  if (!bs.tickets[ticketId]) bs.tickets[ticketId] = { confirmed:false, brokerPrice:'', disputed:false };
  bs.tickets[ticketId].brokerPrice = val;
  clSaveClosings(); renderClosing();
}
function clLiveUpdate(brokerId, ticketId, input) {
  const val = parseFloat(input.value)||0;
  const entry = DB.earnings.find(e=>e.id===ticketId); if(!entry) return;
  const diff = val - entry.price;
  input.className = `cl-price-input ${diff<0?'under':diff>0?'over':''}`;
}
function clConfirmAll(brokerId) {
  const state = clGetState();
  DB.earnings.filter(e=>isInWeek(e.date,clOffset)&&e.brokerId===brokerId).forEach(e=>{
    const bs = clBrokerState(state, brokerId);
    if(!bs.tickets[e.id]) bs.tickets[e.id]={confirmed:false,brokerPrice:'',disputed:false};
    bs.tickets[e.id].confirmed = true;
    bs.tickets[e.id].disputed = false;
    if(!bs.tickets[e.id].brokerPrice) bs.tickets[e.id].brokerPrice = e.price.toString();
  });
  clSaveClosings(); renderClosing();
  toast('✓ Todos confirmados para '+(DB.brokers.find(b=>b.id===brokerId)||{name:'Broker'}).name);
}
function closeWeek() {
  const state = clGetState();
  state.status='closed'; state.closedAt=new Date().toISOString();
  state.notes=document.getElementById('cl_weekNotes').value;
  clSaveClosings(); renderClosing(); toast('🔒 Semana cerrada y confirmada');
}
function reopenWeek() {
  const state = clGetState(); state.status='open'; state.closedAt=null;
  clSaveClosings(); renderClosing(); toast('🔓 Semana reabierta');
}

const CL_COLORS=['#f5a623','#4a9fcf','#4cbfb0','#9b7fd4','#4caf7d','#e05252','#e8890a','#7a9fc0'];

function renderClosing() {
  clUpdateWeekUI();
  populateAIBrokers();
  const state = clGetState();
  const isClosed = state.status === 'closed';
  const wEntries = DB.earnings.filter(e=>isInWeek(e.date,clOffset));
  const brokerGroups={};
  wEntries.forEach(e=>{
    if(!brokerGroups[e.brokerId]) brokerGroups[e.brokerId]={name:e.brokerName,entries:[]};
    brokerGroups[e.brokerId].entries.push(e);
  });

  let totalConf=0, ourGrand=0, brkGrand=0, dispTotal=0, dispCount=0;
  Object.entries(brokerGroups).forEach(([bid,group])=>{
    const bs=clBrokerState(state,bid);
    group.entries.forEach(e=>{
      const ts=bs.tickets[e.id]||{};
      ourGrand+=e.price;
      if(ts.confirmed){totalConf++;brkGrand+=parseFloat(ts.brokerPrice||e.price)||0;}
      if(ts.disputed){dispTotal+=e.price;dispCount++;}
    });
  });

  const total=wEntries.length;
  document.getElementById('cl_progressBar').style.width=(total>0?(totalConf/total*100):0)+'%';
  document.getElementById('cl_progressText').textContent=`${totalConf}/${total}`;

  const pill=document.getElementById('cl_statusPill'), info=document.getElementById('cl_statusInfo');
  if(isClosed){pill.className='cl-status-pill cl-pill-closed';pill.textContent='✓ SEMANA CERRADA';info.textContent='Cierre confirmado el '+(state.closedAt?new Date(state.closedAt).toLocaleDateString('es-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'}):'—');}
  else if(dispCount>0){pill.className='cl-status-pill cl-pill-disputed';pill.textContent=`⚠ ${dispCount} DISPUTA${dispCount>1?'S':''}`;info.textContent='Tickets en disputa — revisa con el broker';}
  else if(totalConf===total&&total>0){pill.className='cl-status-pill cl-pill-partial';pill.textContent='◎ TODOS CONFIRMADOS';info.textContent='Listo para cerrar';}
  else{pill.className='cl-status-pill cl-pill-open';pill.textContent='⬤ Semana Abierta';info.textContent=`${total-totalConf} ticket${(total-totalConf)!==1?'s':''} pendientes`;}

  const banner=document.getElementById('cl_closedBanner');
  banner.style.display=isClosed?'flex':'none';
  if(isClosed){document.getElementById('cl_closedDate').textContent='Cerrado: '+new Date(state.closedAt).toLocaleString('es-US');document.getElementById('cl_closedTotal').textContent=fmtAmt(brkGrand);}

  document.getElementById('cl_summaryCard').style.display=wEntries.length?'block':'none';
  document.getElementById('cl_sumOurs').textContent=fmtAmt(ourGrand);
  document.getElementById('cl_sumOursCount').textContent=wEntries.length+' tickets';
  document.getElementById('cl_sumBroker').textContent=fmtAmt(brkGrand);
  document.getElementById('cl_sumBrokerCount').textContent=totalConf+' confirmados';
  document.getElementById('cl_sumDisputed').textContent=fmtAmt(dispTotal);
  document.getElementById('cl_sumDisputedCount').textContent=dispCount+' tickets';

  const diff=brkGrand-ourGrand;
  const diffEl=document.getElementById('cl_sumDiff');
  diffEl.textContent=(diff>=0?'+':'')+fmtAmt(diff);
  diffEl.style.color=diff>0?'var(--success)':diff<0?'var(--danger)':'var(--muted)';
  document.getElementById('cl_diffBox').style.borderLeftColor=diff>0?'var(--success)':diff<0?'var(--danger)':'var(--muted)';
  document.getElementById('cl_sumDiffNote').textContent=diff<0?'⚠ Broker debe más':diff>0?'✓ Broker pagó más':'= Montos iguales';

  document.getElementById('cl_weekNotes').value=state.notes||'';
  const closeBtn=document.getElementById('cl_closeBtn'), reopenBtn=document.getElementById('cl_reopenBtn');
  closeBtn.style.display=isClosed?'none':'flex';
  closeBtn.disabled=isClosed;
  reopenBtn.style.display=isClosed?'block':'none';

  // Per-broker summary table
  const brokerSummaryRows=Object.entries(brokerGroups).map(([bid,group],idx)=>{
    const bs=clBrokerState(state,bid),color=CL_COLORS[idx%CL_COLORS.length];
    let ourT=0,brkT=0,confCnt=0,dispCnt=0,discT=0;
    group.entries.forEach(e=>{const ts=bs.tickets[e.id]||{};ourT+=e.price;if(ts.confirmed){confCnt++;const bp=parseFloat(ts.brokerPrice||e.price)||0;brkT+=bp;discT+=(e.price-bp);}if(ts.disputed)dispCnt++;});
    const d=brkT-ourT;
    const stHtml=dispCnt>0?`<span class="badge badge-red">⚠ Disputa</span>`:confCnt===group.entries.length?`<span class="badge badge-green">✓ Completo</span>`:confCnt>0?`<span class="badge badge-blue">${confCnt}/${group.entries.length}</span>`:`<span class="badge badge-yellow">Pendiente</span>`;
    return `<tr><td><div style="display:flex;align-items:center;gap:8px"><div style="width:8px;height:8px;border-radius:50%;background:${color}"></div>${group.name}</div></td><td class="mono accent" style="text-align:right">${fmtAmt(ourT)}</td><td class="mono" style="color:var(--info);text-align:right">${fmtAmt(brkT)}</td><td class="mono" style="color:${d<0?'var(--danger)':d>0?'var(--success)':'var(--muted)'};text-align:right">${d>=0?'+':''}${fmtAmt(d)}</td><td class="mono" style="color:var(--danger);text-align:right">${discT>0?'−'+fmtAmt(discT):'—'}</td><td class="mono" style="text-align:center;color:var(--muted)">${group.entries.length}</td><td style="text-align:center">${stHtml}</td></tr>`;
  }).join('');
  document.getElementById('cl_brokerSummaryTbody').innerHTML=brokerSummaryRows||`<tr><td colspan="7" class="muted" style="text-align:center;padding:1rem;font-family:'IBM Plex Mono',monospace;font-size:0.75rem">Sin datos</td></tr>`;

  // Broker checklist cards
  const container=document.getElementById('cl_brokerCards');
  if(!wEntries.length){
    container.innerHTML=`<div style="text-align:center;padding:4rem 2rem;color:var(--muted)"><div style="font-size:3rem;margin-bottom:1rem;opacity:.3">🔒</div><div style="font-family:'IBM Plex Mono',monospace;font-size:0.72rem;text-transform:uppercase;letter-spacing:2px">Sin tickets esta semana</div><div style="font-size:0.75rem;margin-top:8px">Registra tickets en Ganancias primero</div></div>`;
    return;
  }
  container.innerHTML=Object.entries(brokerGroups).map(([bid,group],idx)=>{
    const bs=clBrokerState(state,bid),color=CL_COLORS[idx%CL_COLORS.length];
    let ourT=0,brkT=0,conf=0,disp=0;
    const rows=group.entries.sort((a,b)=>a.date.localeCompare(b.date)||a.ticketNum.localeCompare(b.ticketNum)).map(e=>{
      const ts=bs.tickets[e.id]||{};
      ourT+=e.price;
      const bp=parseFloat(ts.brokerPrice!==undefined&&ts.brokerPrice!==''?ts.brokerPrice:e.price)||0;
      if(ts.confirmed){conf++;brkT+=parseFloat(ts.brokerPrice||e.price)||0;}
      if(ts.disputed)disp++;
      const diff2=ts.confirmed?(bp-e.price):null;
      const isConf=ts.confirmed,isDisp=ts.disputed;
      const rowClass=isConf?'confirmed':isDisp?'disputed':'';
      const prCls=diff2!==null?(diff2<0?'under':diff2>0?'over':''):'';
      const diffHtml=diff2!==null?`<span class="diff-badge ${diff2<0?'diff-neg':diff2>0?'diff-pos':'diff-zero'}">${diff2>=0?'+':''}${fmtAmt(diff2)}</span>`:`<span class="diff-badge diff-zero">—</span>`;
      return `<div class="cl-ticket-row ${rowClass}">
        <div class="cl-check ${isConf?'checked':isDisp?'disputed-chk':''}" onclick="clToggleTicket('${bid}','${e.id}')" title="${isConf?'Confirmado':'Confirmar'}">${isConf?'✓':isDisp?'!':''}</div>
        <span class="mono" style="font-weight:600;color:${color};font-size:0.82rem">${e.ticketNum}</span>
        <span class="mono muted" style="font-size:0.72rem">${fmtDate(e.date)}</span>
        <span style="font-size:0.8rem;display:flex;align-items:center;gap:6px"><span>🚛</span><span class="mono" style="font-size:0.78rem">${e.truckNum||'—'}</span></span>
        <span class="mono" style="text-align:right;color:var(--accent)">${fmtAmt(e.price)}</span>
        <input type="number" class="cl-price-input ${prCls}" value="${ts.brokerPrice!==undefined&&ts.brokerPrice!==''?ts.brokerPrice:e.price}" step="0.01" min="0"
          onchange="clSetBrokerPrice('${bid}','${e.id}',this.value)"
          oninput="clLiveUpdate('${bid}','${e.id}',this)"
          ${isClosed?'disabled':''} title="Precio del broker"/>
        ${diffHtml}
        <button class="dispute-btn ${isDisp?'active-dispute':''}" onclick="clToggleDispute('${bid}','${e.id}')" ${isClosed?'disabled':''}>
          ${isDisp?'⚠ Disputa':'⚑ Disputar'}
        </button>
      </div>`;
    }).join('');
    const pct2=group.entries.length>0?(conf/group.entries.length*100).toFixed(0):0;
    const diffT=brkT-ourT;
    const brokerSt=disp>0?'cl-pill-disputed':conf===group.entries.length?'cl-pill-closed':conf>0?'cl-pill-partial':'cl-pill-open';
    const brokerStTxt=disp>0?`⚠ ${disp} Disputa${disp>1?'s':''}`:conf===group.entries.length?'✓ Completo':`${conf}/${group.entries.length} confirmados`;
    return `<div class="cl-broker-card">
      <div class="cl-broker-head" style="border-top:3px solid ${color}">
        <div class="cl-broker-dot" style="background:${color}"></div>
        <div>
          <div class="cl-broker-title">${group.name}</div>
          <span class="cl-status-pill ${brokerSt}" style="font-size:0.6rem;padding:2px 8px">${brokerStTxt}</span>
        </div>
        <div><div class="cl-col-head">Nuestro Total</div><div class="cl-col-val accent">${fmtAmt(ourT)}</div></div>
        <div><div class="cl-col-head">Total Broker</div><div class="cl-col-val" style="color:var(--info)">${conf>0?fmtAmt(brkT):'—'}</div></div>
        <div><div class="cl-col-head">Diferencia</div><div class="cl-col-val" style="color:${diffT<0?'var(--danger)':diffT>0?'var(--success)':'var(--muted)'}">${conf>0?(diffT>=0?'+':'')+fmtAmt(diffT):'—'}</div></div>
        <div style="text-align:right">
          ${!isClosed?`<button class="btn btn-outline btn-sm" onclick="clConfirmAll('${bid}')" style="font-size:0.62rem">✓ Todo</button>`:''}
          <div style="height:4px;background:var(--surface3);border-radius:2px;margin-top:6px;overflow:hidden;width:90px;margin-left:auto">
            <div style="width:${pct2}%;height:100%;background:${color};border-radius:2px;transition:width .3s"></div>
          </div>
        </div>
      </div>
      <div class="cl-col-headers">
        <span></span><span>Ticket #</span><span>Fecha</span><span>Camión</span>
        <span style="text-align:right">Nuestro $</span>
        <span style="text-align:right">Broker $</span>
        <span style="text-align:right">Diferencia</span>
        <span>Estado</span>
      </div>
      ${rows}
    </div>`;
  }).join('');
}

function exportClosingCSV() {
  const state=clGetState();
  const wEntries=DB.earnings.filter(e=>isInWeek(e.date,clOffset));
  if(!wEntries.length){toast('Sin datos',true);return;}
  const hd=['Broker','Ticket#','Fecha','Camión','Nuestro $','Broker $','Diferencia','Estado'];
  const rows=wEntries.map(e=>{
    const bs=clBrokerState(state,e.brokerId);const ts=bs.tickets[e.id]||{};
    const bp=parseFloat(ts.brokerPrice||e.price)||0;const d=bp-e.price;
    const st=ts.confirmed?'Confirmado':ts.disputed?'Disputa':'Pendiente';
    return [e.brokerName,e.ticketNum,e.date,e.truckNum,e.price,bp,d,st].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(',');
  });
  const {mon}=getWeekRange(clOffset);
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([[hd.join(','),...rows].join('\n')],{type:'text/csv'}));
  a.download=`cierre_${mon.toISOString().split('T')[0]}.csv`;
  a.click();toast('✓ CSV exportado');
}

// ════════════════════════════════════════════════
//  EXPENSES MODULE
// ════════════════════════════════════════════════
DB.expenses = JSON.parse(localStorage.getItem('dt_expenses') || '[]');
function saveExpenses() { localStorage.setItem('dt_expenses', JSON.stringify(DB.expenses)); }

const EXP_CATS = {
  fuel:         { label:'Diesel / Fuel',        color:'#e8890a', icon:'⛽' },
  repair:       { label:'Reparación',            color:'#4a9fcf', icon:'🔧' },
  tire:         { label:'Llantas',               color:'#9b7fd4', icon:'🛞' },
  insurance:    { label:'Seguro',                color:'#4cbfb0', icon:'🛡' },
  truck_payment:{ label:'Pago de Truck',         color:'#e05252', icon:'💳' },
  oil:          { label:'Aceite',                color:'#c9a84c', icon:'🛢' },
  inspection:   { label:'Inspección DOT',        color:'#4caf7d', icon:'📋' },
  toll:         { label:'Peajes',                color:'#999',    icon:'🛣' },
  wash:         { label:'Lavado',                color:'#7a9fc0', icon:'🚿' },
  permit:       { label:'Permisos',              color:'#c07070', icon:'📄' },
  driver_pay:   { label:'Pago Chofer',           color:'#b07fd4', icon:'👤' },
  other:        { label:'Otro',                  color:'#888',    icon:'📦' },
};
const EXP_METHODS = { cash:'💵 Cash', check:'🧾 Check', card:'💳 Tarjeta', zelle:'📱 Zelle', wire:'🏦 Wire' };

let exp_editId = null;
function saveExpense() {
  const date   = document.getElementById('exp_date').value;
  const amount = parseFloat(document.getElementById('exp_amount').value) || 0;
  const desc   = document.getElementById('exp_desc').value.trim();
  if (!date || amount <= 0 || !desc) { toast('⚠ Fecha, monto y descripción requeridos', true); return; }
  const truckId = document.getElementById('exp_truck').value;
  const truck = DB.trucks.find(t => t.id === truckId);
  const rec = {
    id: exp_editId || uid(), date, amount,
    category: document.getElementById('exp_category').value,
    truckId, truckNum: truck ? truck.num : '',
    desc, method: document.getElementById('exp_method').value,
    ref: document.getElementById('exp_ref').value.trim(),
    notes: document.getElementById('exp_notes').value.trim(),
  };
  if (exp_editId) {
    const i = DB.expenses.findIndex(x => x.id === exp_editId);
    if (i >= 0) DB.expenses[i] = rec;
    toast('✓ Gasto actualizado'); cancelExpenseEdit();
  } else {
    DB.expenses.push(rec);
    toast('✓ Gasto guardado: ' + fmtAmt(amount)); clearExpenseForm();
  }
  saveExpenses(); renderExpenses();
}
function clearExpenseForm() {
  ['exp_desc','exp_ref','exp_notes','exp_amount'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('exp_date').value = new Date().toISOString().split('T')[0];
  document.getElementById('exp_category').value = 'fuel';
  document.getElementById('exp_method').value = 'cash';
  document.getElementById('exp_truck').value = '';
}
function cancelExpenseEdit() {
  exp_editId = null;
  document.getElementById('expFormTitle').textContent = 'NUEVO GASTO';
  document.getElementById('exp_submitBtn').textContent = 'GUARDAR GASTO';
  document.getElementById('exp_cancelBtn').style.display = 'none';
  clearExpenseForm();
}
function editExpense(id) {
  const e = DB.expenses.find(x => x.id === id); if (!e) return;
  exp_editId = id;
  document.getElementById('exp_date').value = e.date;
  document.getElementById('exp_amount').value = e.amount;
  document.getElementById('exp_category').value = e.category;
  document.getElementById('exp_truck').value = e.truckId || '';
  document.getElementById('exp_desc').value = e.desc;
  document.getElementById('exp_method').value = e.method;
  document.getElementById('exp_ref').value = e.ref || '';
  document.getElementById('exp_notes').value = e.notes || '';
  document.getElementById('expFormTitle').textContent = 'EDITAR GASTO';
  document.getElementById('exp_submitBtn').textContent = 'ACTUALIZAR';
  document.getElementById('exp_submitBtn').classList.add('edit-mode');
  document.getElementById('exp_cancelBtn').style.display = 'block';
  document.querySelector('#page-expenses .form-card').scrollIntoView({ behavior: 'smooth' });
}

function getFilteredExpenses() {
  const sel = document.getElementById('exp_filterMonth').value;
  if (!sel) return DB.expenses;
  return DB.expenses.filter(e => e.date.startsWith(sel));
}

function renderExpenses() {
  // Populate month filter
  const months = [...new Set(DB.expenses.map(e => e.date.substr(0,7)))].sort().reverse();
  const sel = document.getElementById('exp_filterMonth');
  const cv = sel.value;
  sel.innerHTML = '<option value="">Todos los meses</option>';
  months.forEach(m => {
    const d = new Date(m + '-01');
    const o = document.createElement('option');
    o.value = m; o.textContent = d.toLocaleDateString('es-US', { month:'long', year:'numeric' });
    sel.appendChild(o);
  });
  sel.value = cv;

  const q = (document.getElementById('exp_search').value || '').toLowerCase();
  const list = getFilteredExpenses().filter(e =>
    !q || (e.desc||'').toLowerCase().includes(q) || (e.truckNum||'').toLowerCase().includes(q) || (EXP_CATS[e.category]?.label||'').toLowerCase().includes(q)
  ).sort((a,b) => b.date.localeCompare(a.date));

  // Stats
  const all = getFilteredExpenses();
  const totAll  = all.reduce((s,e) => s+e.amount, 0);
  const totFuel = all.filter(e=>e.category==='fuel').reduce((s,e)=>s+e.amount,0);
  const totRep  = all.filter(e=>e.category==='repair').reduce((s,e)=>s+e.amount,0);
  const totOth  = totAll - totFuel - totRep;
  document.getElementById('exp_statTotal').textContent  = fmtAmt(totAll);
  document.getElementById('exp_statFuel').textContent   = fmtAmt(totFuel);
  document.getElementById('exp_statRepair').textContent = fmtAmt(totRep);
  document.getElementById('exp_statOther').textContent  = fmtAmt(totOth);
  document.getElementById('exp_countBadge').textContent = list.length;

  // Category breakdown
  const catTotals = {};
  all.forEach(e => { catTotals[e.category] = (catTotals[e.category]||0) + e.amount; });
  const sortedCats = Object.entries(catTotals).sort((a,b)=>b[1]-a[1]);
  const maxCat = sortedCats.length ? sortedCats[0][1] : 1;
  document.getElementById('exp_catBreakdown').innerHTML = sortedCats.map(([cat, amt]) => {
    const c = EXP_CATS[cat] || { label:cat, color:'#888', icon:'📦' };
    const pct = (amt/maxCat*100).toFixed(0);
    return `<div class="cat-bar-wrap">
      <div class="cat-label">${c.icon} ${c.label}</div>
      <div style="flex:1;height:5px;background:var(--surface3);border-radius:3px;overflow:hidden">
        <div class="cat-bar" style="width:${pct}%;background:${c.color};height:100%"></div>
      </div>
      <div class="cat-amount">${fmtAmt(amt)}</div>
    </div>`;
  }).join('') || '<div style="font-size:0.72rem;color:var(--muted);font-family:IBM Plex Mono,monospace;text-align:center;padding:.5rem">Sin gastos</div>';

  // Table
  const tbody = document.getElementById('exp_tbody');
  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="icon">📉</div><p>Sin gastos registrados</p></div></td></tr>`;
    document.getElementById('exp_tfoot').innerHTML = '';
    return;
  }
  tbody.innerHTML = list.map(e => {
    const c = EXP_CATS[e.category] || { label:e.category, color:'#888', icon:'📦' };
    return `<tr>
      <td class="mono muted" style="font-size:0.72rem">${fmtDate(e.date)}</td>
      <td><span class="exp-cat-pill" style="background:${c.color}22;color:${c.color};border:1px solid ${c.color}44">${c.icon} ${c.label}</span></td>
      <td style="font-size:0.82rem">${e.desc}</td>
      <td class="mono accent" style="font-size:0.75rem">${e.truckNum||'—'}</td>
      <td style="font-size:0.72rem;color:var(--muted)">${EXP_METHODS[e.method]||e.method}</td>
      <td class="exp-row-amount">${fmtAmt(e.amount)}</td>
      <td><div class="actions">
        <button class="btn-icon btn-edit" onclick="editExpense('${e.id}')">✏</button>
        <button class="btn-icon btn-del" onclick="openDeleteModal('${e.id}','expenses')">🗑</button>
      </div></td>
    </tr>`;
  }).join('');

  const tot = list.reduce((s,e)=>s+e.amount,0);
  document.getElementById('exp_tfoot').innerHTML = `<tr class="totals-row" style="border-top-color:var(--danger)">
    <td colspan="5" style="text-align:right;font-size:0.65rem;letter-spacing:2px">TOTAL</td>
    <td class="exp-row-amount" style="font-size:1rem">${fmtAmt(tot)}</td><td></td>
  </tr>`;
}

function exportExpensesCSV() {
  if (!DB.expenses.length) { toast('Sin gastos para exportar', true); return; }
  const hd = ['Fecha','Categoría','Descripción','Camión','Método','Ref','Monto'];
  const rows = DB.expenses.map(e => {
    const c = EXP_CATS[e.category];
    return [e.date, c?.label||e.category, e.desc, e.truckNum, EXP_METHODS[e.method]||e.method, e.ref, e.amount].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(',');
  });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([[hd.join(','),...rows].join('\n')],{type:'text/csv'}));
  a.download = 'gastos_dumptrack.csv'; a.click(); toast('✓ CSV exportado');
}

function populateExpenseTrucks() {
  const sel = document.getElementById('exp_truck');
  const cv = sel.value;
  sel.innerHTML = '<option value="">-- General / Todos --</option>';
  DB.trucks.forEach(t => {
    const o = document.createElement('option');
    o.value = t.id; o.textContent = `${t.num} — ${t.make} ${t.model}`;
    sel.appendChild(o);
  });
  sel.value = cv;
}

// ════════════════════════════════════════════════
//  P&L MODULE
// ════════════════════════════════════════════════
function getPLDateRange(period) {
  const now = new Date();
  const y = now.getFullYear(), m = now.getMonth();
  if (period === 'week') {
    const {mon, sun} = getWeekRange(0);
    return { start: mon, end: sun };
  }
  if (period === 'month') return { start: new Date(y,m,1), end: new Date(y,m+1,0,23,59,59) };
  if (period === 'quarter') {
    const q = Math.floor(m/3);
    return { start: new Date(y, q*3, 1), end: new Date(y, q*3+3, 0, 23,59,59) };
  }
  return { start: new Date(y,0,1), end: new Date(y,11,31,23,59,59) };
}

function inRange(dateStr, start, end) {
  const d = new Date(dateStr + 'T12:00:00');
  return d >= start && d <= end;
}

function renderPL() {
  const period = document.getElementById('pl_period').value;
  const { start, end } = getPLDateRange(period);

  const earnIn   = DB.earnings.filter(e => inRange(e.date, start, end));
  const expIn    = DB.expenses.filter(e => inRange(e.date, start, end));
  const income   = earnIn.reduce((s,e)=>s+e.price, 0);
  const expenses = expIn.reduce((s,e)=>s+e.amount, 0);
  const net      = income - expenses;
  const margin   = income > 0 ? (net/income*100).toFixed(1) : 0;

  document.getElementById('pl_income').textContent = fmtAmt(income);
  document.getElementById('pl_incomeTickets').textContent = earnIn.length + ' tickets';
  document.getElementById('pl_expenses').textContent = fmtAmt(expenses);
  document.getElementById('pl_expensesCount').textContent = expIn.length + ' gastos';
  document.getElementById('pl_net').textContent = fmtAmt(net);
  document.getElementById('pl_net').style.color = net >= 0 ? 'var(--success)' : 'var(--danger)';
  document.getElementById('pl_netCard').style.borderLeftColor = net >= 0 ? 'var(--success)' : 'var(--danger)';
  document.getElementById('pl_margin').textContent = `Margen: ${margin}%`;

  // Income by broker
  const brkGroups = {};
  earnIn.forEach(e => {
    if (!brkGroups[e.brokerId]) brkGroups[e.brokerId] = { name:e.brokerName, count:0, total:0 };
    brkGroups[e.brokerId].count++;
    brkGroups[e.brokerId].total += e.price;
  });
  const brkSorted = Object.values(brkGroups).sort((a,b)=>b.total-a.total);
  document.getElementById('pl_incomeTable').innerHTML = brkSorted.length
    ? brkSorted.map(b => {
        const pct = income > 0 ? (b.total/income*100).toFixed(1) : 0;
        return `<tr><td>${b.name}</td><td class="mono" style="text-align:right">${b.count}</td><td class="mono" style="text-align:right;color:var(--success)">${fmtAmt(b.total)}</td><td class="mono muted" style="text-align:right">${pct}%</td></tr>`;
      }).join('') + `<tr style="background:var(--surface2)"><td style="font-weight:600">TOTAL</td><td class="mono" style="text-align:right">${earnIn.length}</td><td class="mono" style="text-align:right;color:var(--success);font-weight:600">${fmtAmt(income)}</td><td></td></tr>`
    : `<tr><td colspan="4" style="text-align:center;padding:1rem;color:var(--muted);font-size:0.75rem;font-family:'IBM Plex Mono',monospace">Sin ingresos</td></tr>`;

  // Expenses by category
  const catGroups = {};
  expIn.forEach(e => {
    const c = EXP_CATS[e.category] || { label:e.category, icon:'📦' };
    if (!catGroups[e.category]) catGroups[e.category] = { label:c.icon+' '+c.label, count:0, total:0 };
    catGroups[e.category].count++;
    catGroups[e.category].total += e.amount;
  });
  const catSorted = Object.values(catGroups).sort((a,b)=>b.total-a.total);
  document.getElementById('pl_expTable').innerHTML = catSorted.length
    ? catSorted.map(c => {
        const pct = expenses > 0 ? (c.total/expenses*100).toFixed(1) : 0;
        return `<tr><td>${c.label}</td><td class="mono" style="text-align:right">${c.count}</td><td class="mono" style="text-align:right;color:var(--danger)">${fmtAmt(c.total)}</td><td class="mono muted" style="text-align:right">${pct}%</td></tr>`;
      }).join('') + `<tr style="background:var(--surface2)"><td style="font-weight:600">TOTAL</td><td class="mono" style="text-align:right">${expIn.length}</td><td class="mono" style="text-align:right;color:var(--danger);font-weight:600">${fmtAmt(expenses)}</td><td></td></tr>`
    : `<tr><td colspan="4" style="text-align:center;padding:1rem;color:var(--muted);font-size:0.75rem;font-family:'IBM Plex Mono',monospace">Sin gastos</td></tr>`;

  // Weekly breakdown
  const weeks = buildWeeklyPL(start, end);
  document.getElementById('pl_weekTable').innerHTML = weeks.length
    ? weeks.map(w => {
        const n = w.inc - w.exp;
        const mg = w.inc > 0 ? (n/w.inc*100).toFixed(0) : 0;
        return `<tr>
          <td class="mono muted" style="font-size:0.75rem">${w.label}</td>
          <td class="mono" style="text-align:right;color:var(--success)">${fmtAmt(w.inc)}</td>
          <td class="mono" style="text-align:right;color:var(--danger)">${fmtAmt(w.exp)}</td>
          <td class="mono" style="text-align:right;color:${n>=0?'var(--success)':'var(--danger)'};font-weight:600">${fmtAmt(n)}</td>
          <td class="mono" style="text-align:right;color:var(--muted)">${mg}%</td>
          <td class="mono" style="text-align:right">${w.tickets}</td>
        </tr>`;
      }).join('')
    : `<tr><td colspan="6" style="text-align:center;padding:1rem;color:var(--muted);font-size:0.75rem;font-family:'IBM Plex Mono',monospace">Sin datos</td></tr>`;

  // Chart
  renderPLChart(weeks);
}

function buildWeeklyPL(start, end) {
  const weeks = [];
  let cur = new Date(start);
  const day = cur.getDay();
  const diffToMon = day === 0 ? -6 : 1 - day;
  cur.setDate(cur.getDate() + diffToMon);
  cur.setHours(0,0,0,0);
  while (cur <= end) {
    const wEnd = new Date(cur); wEnd.setDate(cur.getDate()+6); wEnd.setHours(23,59,59,999);
    const inc = DB.earnings.filter(e=>inRange(e.date,cur,wEnd)).reduce((s,e)=>s+e.price,0);
    const exp = DB.expenses.filter(e=>inRange(e.date,cur,wEnd)).reduce((s,e)=>s+e.amount,0);
    const tickets = DB.earnings.filter(e=>inRange(e.date,cur,wEnd)).length;
    weeks.push({ label: `${fmtD(cur)}–${fmtD(wEnd)}`, inc, exp, tickets });
    cur = new Date(cur); cur.setDate(cur.getDate()+7);
  }
  return weeks;
}

function renderPLChart(weeks) {
  const chartEl = document.getElementById('pl_chart');
  if (!weeks.length) { chartEl.innerHTML = '<div style="color:var(--muted);font-size:0.72rem;font-family:IBM Plex Mono,monospace;margin:auto">Sin datos</div>'; return; }
  const maxVal = Math.max(...weeks.map(w => Math.max(w.inc, w.exp, 1)));
  chartEl.innerHTML = weeks.slice(-12).map(w => {
    const net = w.inc - w.exp;
    const incH = Math.round((w.inc/maxVal)*100);
    const expH = Math.round((w.exp/maxVal)*100);
    const netH = Math.round((Math.abs(net)/maxVal)*100);
    return `<div class="bar-col">
      <div class="bar-amt" style="font-size:0.55rem;color:${net>=0?'var(--success)':'var(--danger)'}">${net>=0?'+':''}${Math.round(net/1000)}k</div>
      <div style="display:flex;gap:2px;align-items:flex-end;flex:1;width:100%">
        <div class="bar-col-inner" style="height:${incH}%;background:rgba(76,175,125,.7);flex:1" title="Ingreso: ${fmtAmt(w.inc)}"></div>
        <div class="bar-col-inner" style="height:${expH}%;background:rgba(224,82,82,.7);flex:1" title="Gasto: ${fmtAmt(w.exp)}"></div>
        <div class="bar-col-inner" style="height:${netH}%;background:${net>=0?'rgba(245,166,35,.8)':'rgba(224,82,82,.4)'};flex:1" title="Neto: ${fmtAmt(net)}"></div>
      </div>
      <div class="bar-lbl">${w.label.split('–')[0]}</div>
    </div>`;
  }).join('');
}

function exportPLCSV() {
  const period = document.getElementById('pl_period').value;
  const { start, end } = getPLDateRange(period);
  const weeks = buildWeeklyPL(start, end);
  const hd = ['Semana','Ingresos','Gastos','Neto','Margen','Tickets'];
  const rows = weeks.map(w => {
    const n = w.inc - w.exp; const m = w.inc>0?(n/w.inc*100).toFixed(1):0;
    return [w.label, w.inc, w.exp, n, m+'%', w.tickets].map(v=>`"${v}"`).join(',');
  });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([[hd.join(','),...rows].join('\n')],{type:'text/csv'}));
  a.download = `pl_dumptrack.csv`; a.click(); toast('✓ P&L exportado');
}

// ════════════════════════════════════════════════
//  BROKER REPORT MODULE
// ════════════════════════════════════════════════
function renderBrokerReport() {
  const period = document.getElementById('brr_period').value;
  let start, end;
  if (period === 'all') { start = new Date('2000-01-01'); end = new Date('2099-12-31'); }
  else { const r = getPLDateRange(period === 'month' ? 'month' : period === 'quarter' ? 'quarter' : 'year'); start = r.start; end = r.end; }

  const earnIn = DB.earnings.filter(e => inRange(e.date, start, end));
  const closings = DB.weekClosings;

  // Group by broker
  const groups = {};
  earnIn.forEach(e => {
    if (!groups[e.brokerId]) groups[e.brokerId] = { id:e.brokerId, name:e.brokerName, entries:[], totalOurs:0, totalBroker:0, confirmed:0, discounts:0, weeklyTotals:{} };
    groups[e.brokerId].entries.push(e);
    groups[e.brokerId].totalOurs += e.price;
    const wKey = getWeekRange_key(e.date);
    groups[e.brokerId].weeklyTotals[wKey] = (groups[e.brokerId].weeklyTotals[wKey]||0) + e.price;
    // Check closing state
    Object.values(closings).forEach(wc => {
      if (wc.brokerStates && wc.brokerStates[e.brokerId] && wc.brokerStates[e.brokerId].tickets && wc.brokerStates[e.brokerId].tickets[e.id]) {
        const ts = wc.brokerStates[e.brokerId].tickets[e.id];
        if (ts.confirmed) {
          groups[e.brokerId].confirmed++;
          const bp = parseFloat(ts.brokerPrice||e.price)||0;
          groups[e.brokerId].totalBroker += bp;
          groups[e.brokerId].discounts += (e.price - bp);
        }
      }
    });
  });

  const allGroups = Object.values(groups).sort((a,b)=>b.totalOurs-a.totalOurs);
  const grandTotal = allGroups.reduce((s,g)=>s+g.totalOurs,0);

  // Cards
  document.getElementById('brr_cards').innerHTML = allGroups.length ? allGroups.map((g,idx) => {
    const color = CL_COLORS[idx % CL_COLORS.length];
    const avgPerTicket = g.entries.length ? g.totalOurs/g.entries.length : 0;
    const weekVals = Object.values(g.weeklyTotals);
    const bestWeek = weekVals.length ? Math.max(...weekVals) : 0;
    const pct = grandTotal > 0 ? (g.totalOurs/grandTotal*100).toFixed(1) : 0;
    const maxWk = Math.max(...weekVals, 1);
    const sparkBars = Object.values(g.weeklyTotals).slice(-8).map(v =>
      `<div class="br-spark-bar" style="height:${Math.round(v/maxWk*100)}%;background:${color}88"></div>`
    ).join('');
    return `<div class="br-report-card">
      <div class="br-report-hdr" style="border-left:4px solid ${color}">
        <div style="width:10px;height:10px;border-radius:50%;background:${color};flex-shrink:0"></div>
        <div class="br-report-name">${g.name}</div>
        <div class="br-spark">${sparkBars}</div>
        <div style="margin-left:auto;font-size:0.65rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);text-align:right">
          ${pct}% del total<br>
          <span style="color:${color};font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px">${fmtAmt(g.totalOurs)}</span>
        </div>
        <div class="br-divider"></div>
        <div class="br-stat"><div class="br-stat-val" style="color:${color}">${g.entries.length}</div><div class="br-stat-lbl">Tickets</div></div>
        <div class="br-divider"></div>
        <div class="br-stat"><div class="br-stat-val" style="font-size:1.1rem">${fmtAmt(avgPerTicket)}</div><div class="br-stat-lbl">Promedio</div></div>
        <div class="br-divider"></div>
        <div class="br-stat"><div class="br-stat-val" style="font-size:1.1rem">${fmtAmt(bestWeek)}</div><div class="br-stat-lbl">Mejor Semana</div></div>
        <div class="br-divider"></div>
        <div class="br-stat"><div class="br-stat-val" style="color:var(--danger);font-size:1.1rem">${g.discounts>0?'−'+fmtAmt(g.discounts):'—'}</div><div class="br-stat-lbl">Descuentos</div></div>
      </div>
    </div>`;
  }).join('') : `<div class="empty-state"><div class="icon">🤝</div><p>Sin datos para el período</p></div>`;

  // Comparison table
  document.getElementById('brr_compTable').innerHTML = allGroups.length ? allGroups.map((g,idx) => {
    const color = CL_COLORS[idx%CL_COLORS.length];
    const avg = g.entries.length ? g.totalOurs/g.entries.length : 0;
    const wkVals = Object.values(g.weeklyTotals);
    const best = wkVals.length ? Math.max(...wkVals) : 0;
    const rel = g.confirmed / (g.entries.length||1);
    const stHtml = rel>=0.9 ? `<span class="badge badge-green">Confiable</span>` : rel>=0.5 ? `<span class="badge badge-yellow">Regular</span>` : `<span class="badge badge-red">Sin datos</span>`;
    return `<tr>
      <td><div style="display:flex;align-items:center;gap:8px"><div style="width:8px;height:8px;border-radius:50%;background:${color}"></div>${g.name}</div></td>
      <td class="mono" style="text-align:right">${g.entries.length}</td>
      <td class="mono" style="text-align:right;color:var(--success)">${fmtAmt(g.totalOurs)}</td>
      <td class="mono" style="text-align:right">${fmtAmt(avg)}</td>
      <td class="mono" style="text-align:right;color:var(--accent)">${fmtAmt(best)}</td>
      <td class="mono" style="text-align:right;color:var(--danger)">${g.discounts>0?'−'+fmtAmt(g.discounts):'—'}</td>
      <td style="text-align:center">${stHtml}</td>
    </tr>`;
  }).join('') : `<tr><td colspan="7" style="text-align:center;padding:1rem;color:var(--muted);font-size:0.75rem;font-family:'IBM Plex Mono',monospace">Sin datos para el período seleccionado</td></tr>`;
}

function getWeekRange_key(dateStr) {
  const d = new Date(dateStr + 'T12:00:00');
  const day = d.getDay();
  const diff = day===0?-6:1-day;
  const mon = new Date(d); mon.setDate(d.getDate()+diff);
  return mon.toISOString().split('T')[0];
}

// ════════════════════════════════════════════════
//  ALERTS MODULE
// ════════════════════════════════════════════════
function getDaysUntil(dateStr) {
  if (!dateStr) return null;
  const d = new Date(dateStr + 'T12:00:00');
  const now = new Date(); now.setHours(0,0,0,0);
  return Math.round((d - now) / 86400000);
}

function alertCardHTML(days, title, sub, type) {
  let color, bg, icon;
  if (days === null) return '';
  if (days < 0) { color='var(--danger)'; bg='rgba(224,82,82,.1)'; icon='🚨'; }
  else if (days <= 30) { color='#e8890a'; bg='rgba(232,137,10,.1)'; icon='⚠️'; }
  else if (days <= 90) { color='var(--accent)'; bg='rgba(245,166,35,.08)'; icon='📅'; }
  else { color='var(--success)'; bg='rgba(76,175,125,.08)'; icon='✅'; }
  const daysText = days < 0 ? Math.abs(days) + ' días vencido' : days === 0 ? 'Vence HOY' : days + ' días';
  return `<div class="alert-card" style="border-left:3px solid ${color};background:${bg}">
    <div class="alert-icon" style="background:${color}22">${icon}</div>
    <div style="flex:1">
      <div class="alert-title">${title}</div>
      <div class="alert-sub">${sub}</div>
    </div>
    <div>
      <div class="alert-days" style="color:${color}">${Math.abs(days)}</div>
      <div class="alert-days-lbl" style="color:${color}">${days<0?'VENCIDO':days===0?'HOY':'DÍAS'}</div>
    </div>
  </div>`;
}

function renderAlerts() {
  const now = new Date(); now.setHours(0,0,0,0);
  let expired=0, soon30=0, soon90=0, ok=0;
  const allAlerts = [];

  // Truck alerts
  DB.trucks.forEach(t => {
    if (t.insurance) {
      const d = getDaysUntil(t.insurance);
      allAlerts.push({ days:d, type:'truck', html: alertCardHTML(d, `Seguro — ${t.num} ${t.make}`, `${t.year} ${t.make} ${t.model} · Placa: ${t.plate||'—'}`, 'truck') });
    }
    if (t.dot) {
      const d = getDaysUntil(t.dot);
      allAlerts.push({ days:d, type:'truck', html: alertCardHTML(d, `Inspección DOT — ${t.num} ${t.make}`, `${t.year} ${t.make} ${t.model} · Venc: ${fmtDate(t.dot)}`, 'truck') });
    }
  });

  // Driver alerts
  DB.drivers.forEach(dr => {
    const name = `${dr.first} ${dr.last}`;
    if (dr.cdlExp) {
      const d = getDaysUntil(dr.cdlExp);
      allAlerts.push({ days:d, type:'driver', html: alertCardHTML(d, `CDL ${dr.cdlClass} — ${name}`, `Lic: ${dr.cdl||'—'} · Est: ${dr.cdlState||'—'}`, 'driver') });
    }
    if (dr.medical) {
      const d = getDaysUntil(dr.medical);
      allAlerts.push({ days:d, type:'driver', html: alertCardHTML(d, `Medical Card — ${name}`, `Venc: ${fmtDate(dr.medical)}`, 'driver') });
    }
  });

  // Count by severity
  allAlerts.forEach(a => {
    if (a.days === null) return;
    if (a.days < 0) expired++;
    else if (a.days <= 30) soon30++;
    else if (a.days <= 90) soon90++;
    else ok++;
  });

  document.getElementById('al_statExpired').textContent = expired;
  document.getElementById('al_stat30').textContent = soon30;
  document.getElementById('al_stat90').textContent = soon90;
  document.getElementById('al_statOk').textContent = ok;

  const hasCritical = expired > 0 || soon30 > 0;
  const alertsBadge = document.getElementById('alertsBadge');
  if (alertsBadge) alertsBadge.style.display = hasCritical ? 'block' : 'none';

  const sortedAlerts = allAlerts.filter(a=>a.days!==null).sort((a,b)=>(a.days??9999)-(b.days??9999));

  const truckAlerts = sortedAlerts.filter(a=>a.type==='truck');
  const driverAlerts = sortedAlerts.filter(a=>a.type==='driver');

  document.getElementById('al_trucks').innerHTML = truckAlerts.length
    ? truckAlerts.map(a=>a.html).join('')
    : `<div class="alert-empty">${DB.trucks.length ? '✅ Todos los documentos al día' : 'Sin camiones registrados'}</div>`;

  document.getElementById('al_drivers').innerHTML = driverAlerts.length
    ? driverAlerts.map(a=>a.html).join('')
    : `<div class="alert-empty">${DB.drivers.length ? '✅ Todos los documentos al día' : 'Sin choferes registrados'}</div>`;
}


// ════════════════════════════════════════════════
//  AI REPORT READER
// ════════════════════════════════════════════════
let aiExtractedData = []; // store last results for apply-all
let aiCurrentBrokerId = '';

function togglePdfReader() {
  const body = document.getElementById('pdfReaderBody');
  const arrow = document.getElementById('pdfReaderArrow');
  const open = body.style.display !== 'none';
  body.style.display = open ? 'none' : 'block';
  arrow.style.transform = open ? 'rotate(-90deg)' : '';
}

function populateAIBrokers() {
  const sel = document.getElementById('ai_broker');
  const cv = sel.value;
  sel.innerHTML = '<option value="">-- Seleccionar broker --</option>';
  DB.brokers.forEach(b => {
    const o = document.createElement('option');
    o.value = b.id; o.textContent = b.name;
    sel.appendChild(o);
  });
  // Also allow brokers from earnings history
  const earnBrokers = [...new Set(DB.earnings.map(e => e.brokerId))];
  earnBrokers.forEach(bid => {
    if (!DB.brokers.find(b => b.id === bid)) {
      const e0 = DB.earnings.find(e => e.brokerId === bid);
      if (e0) {
        const o = document.createElement('option');
        o.value = bid; o.textContent = e0.brokerName;
        sel.appendChild(o);
      }
    }
  });
  sel.value = cv;
}

// Drag and drop
const dz = document.getElementById('aiDropZone');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag-over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
dz.addEventListener('drop', e => {
  e.preventDefault(); dz.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) processAIFile(file);
});

function onAIFileSelected(ev) {
  const file = ev.target.files[0];
  if (file) processAIFile(file);
}

function setAIStage(stageNum, status) {
  // status: 'active' | 'done' | 'error' | '' (reset)
  for (let i = 1; i <= 5; i++) {
    const el = document.getElementById('aiStage' + i);
    el.className = 'ai-stage';
    if (i < stageNum) el.classList.add('done');
    else if (i === stageNum) el.classList.add(status || 'active');
  }
}

function setAIProgress(pct, label) {
  document.getElementById('aiProgressBar').style.width = pct + '%';
  document.getElementById('aiProgressPct').textContent = pct + '%';
  document.getElementById('aiProgressLabel').textContent = label;
}

async function processAIFile(file) {
  const apiKey = getAPIKey();
  if (!apiKey || !apiKey.startsWith('sk-')) {
    toast('⚠ Ingresa tu API Key de Anthropic primero', true);
    document.getElementById('ai_apiKey').focus();
    return;
  }
  const brokerId = document.getElementById('ai_broker').value;
  if (!brokerId) { toast('⚠ Selecciona un broker primero', true); return; }
  aiCurrentBrokerId = brokerId;

  const isImage = file.type.startsWith('image/');
  const isPDF   = file.type === 'application/pdf' || file.name.endsWith('.pdf');
  if (!isImage && !isPDF) { toast('⚠ Solo PDF o imágenes (PNG, JPG, WEBP)', true); return; }

  // Update drop zone UI
  dz.classList.add('has-file');
  document.getElementById('aiDropIcon').textContent = isImage ? '🖼' : '📋';
  document.getElementById('aiDropTitle').textContent = file.name;
  document.getElementById('aiDropSub').textContent = (file.size / 1024).toFixed(0) + ' KB — procesando...';

  // Show progress
  const wrap = document.getElementById('aiProgressWrap');
  wrap.style.display = 'block';
  document.getElementById('aiResults').style.display = 'none';
  setAIStage(1, 'active'); setAIProgress(5, 'Cargando archivo...');

  let base64data, mediaType;

  // Stage 1: Read file
  try {
    base64data = await new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result.split(',')[1]);
      r.onerror = rej;
      r.readAsDataURL(file);
    });
    mediaType = file.type || (isPDF ? 'application/pdf' : 'image/png');
    setAIStage(1, 'done'); setAIProgress(20, 'Archivo cargado — enviando a IA...');
  } catch (e) {
    setAIStage(1, 'error'); setAIProgress(5, '❌ Error al leer el archivo');
    toast('❌ Error al leer el archivo', true); return;
  }

  // Stage 2: Send to API
  setAIStage(2, 'active'); setAIProgress(35, 'Enviando a Claude IA...');

  const broker = DB.brokers.find(b => b.id === brokerId);
  const brokerName = broker ? broker.name : DB.earnings.find(e => e.brokerId === brokerId)?.brokerName || 'Broker';

  // Get our tickets for this broker in this week to give context
  const wEntries = DB.earnings.filter(e => isInWeek(e.date, clOffset) && e.brokerId === brokerId);
  const ourTicketNums = wEntries.map(e => e.ticketNum).join(', ');

  const prompt = `You are analyzing a broker payment report document. Extract ALL ticket/load data from this document.

BROKER: ${brokerName}
Our tickets this week (for reference): ${ourTicketNums || 'none yet'}

INSTRUCTIONS:
1. Find every ticket number, ticket #, load #, or job reference in this document
2. For each ticket extract: ticket number, date (if present), price/amount charged, any discount or deduction, and net amount
3. Also find the GRAND TOTAL the broker is paying
4. Look for any deductions, fees, commissions, or chargebacks

Respond ONLY with valid JSON in this exact format (no markdown, no explanation):
{
  "tickets": [
    {
      "ticketNum": "T-001",
      "date": "2025-01-15",
      "brokerPrice": 450.00,
      "discount": 0,
      "netAmount": 450.00,
      "notes": "any special note or description from document"
    }
  ],
  "grandTotal": 1250.00,
  "totalDeductions": 0,
  "paymentDate": "2025-01-20",
  "rawSummary": "brief description of what the document shows"
}

If a field is not found, use null. Ticket numbers may appear as numbers like 1234, or with prefixes like T-1234, #1234, etc. Try to match the format used in our system.`;

  let apiResponse;
  try {
    const contentBlock = isPDF
      ? { type: 'document', source: { type: 'base64', media_type: 'application/pdf', data: base64data } }
      : { type: 'image',    source: { type: 'base64', media_type: mediaType, data: base64data } };

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': getAPIKey(),
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2000,
        messages: [{ role: 'user', content: [contentBlock, { type: 'text', text: prompt }] }]
      })
    });
    const data = await response.json();
    if (data.error) throw new Error(data.error.message || 'API error');
    apiResponse = data.content.map(c => c.text || '').join('');
    setAIStage(2, 'done'); setAIProgress(60, 'Respuesta recibida — extrayendo datos...');
  } catch (e) {
    setAIStage(2, 'error'); setAIProgress(35, '❌ Error de conexión con la IA');
    toast('❌ Error al conectar con IA: ' + e.message, true); return;
  }

  // Stage 3: Parse JSON
  setAIStage(3, 'active');
  let parsed;
  try {
    const clean = apiResponse.replace(/```json|```/g, '').trim();
    parsed = JSON.parse(clean);
    setAIStage(3, 'done'); setAIProgress(80, 'Datos extraídos — comparando con nuestros tickets...');
    document.getElementById('aiRawText').textContent = parsed.rawSummary || apiResponse.substring(0, 500);
  } catch (e) {
    setAIStage(3, 'error'); setAIProgress(60, '⚠ No se pudo parsear la respuesta');
    document.getElementById('aiRawText').textContent = apiResponse;
    document.getElementById('aiRawText').style.display = 'block';
    document.getElementById('aiResults').style.display = 'block';
    toast('⚠ IA respondió pero no en formato esperado — ver texto extraído', true); return;
  }

  // Stage 4: Compare
  setAIStage(4, 'active'); setAIProgress(92, 'Comparando con tickets registrados...');
  await new Promise(r => setTimeout(r, 400)); // let UI breathe

  const results = compareAIResults(parsed, wEntries, brokerId);
  aiExtractedData = results;

  setAIStage(4, 'done'); setAIStage(5, 'done'); setAIProgress(100, '✓ Análisis completado');

  renderAIResults(results, parsed);
  document.getElementById('aiDropSub').textContent = file.name + ' · ' + (file.size / 1024).toFixed(0) + ' KB ✓';
}

function compareAIResults(parsed, wEntries, brokerId) {
  const aiTickets = parsed.tickets || [];
  const results = [];

  // Try to match AI tickets with our entries
  aiTickets.forEach(at => {
    // Normalize ticket number for matching
    const normalized = (at.ticketNum || '').toString().replace(/^[#T\s-]+/i, '').trim();
    const match = wEntries.find(e => {
      const en = (e.ticketNum || '').toString().replace(/^[#T\s-]+/i, '').trim();
      return en.toLowerCase() === normalized.toLowerCase() ||
             e.ticketNum.toLowerCase() === (at.ticketNum || '').toLowerCase();
    });

    if (match) {
      const brokerPrice = parseFloat(at.netAmount || at.brokerPrice) || 0;
      const diff = brokerPrice - match.price;
      results.push({
        status: Math.abs(diff) < 0.01 ? 'match' : 'diff',
        ticketNum: match.ticketNum,
        date: at.date || match.date,
        ourPrice: match.price,
        brokerPrice,
        discount: parseFloat(at.discount) || 0,
        diff,
        notes: at.notes || '',
        entryId: match.id,
        brokerId
      });
    } else {
      // Broker has it, we don't
      results.push({
        status: 'extra',
        ticketNum: at.ticketNum,
        date: at.date || '',
        ourPrice: null,
        brokerPrice: parseFloat(at.netAmount || at.brokerPrice) || 0,
        discount: parseFloat(at.discount) || 0,
        diff: null,
        notes: at.notes || '',
        entryId: null,
        brokerId
      });
    }
  });

  // Find our entries not in broker report = missing from broker
  wEntries.forEach(e => {
    const normalized = (e.ticketNum || '').replace(/^[#T\s-]+/i, '').trim();
    const found = aiTickets.find(at => {
      const an = (at.ticketNum || '').toString().replace(/^[#T\s-]+/i, '').trim();
      return an.toLowerCase() === normalized.toLowerCase() ||
             (at.ticketNum || '').toLowerCase() === e.ticketNum.toLowerCase();
    });
    if (!found) {
      results.push({
        status: 'missing',
        ticketNum: e.ticketNum,
        date: e.date,
        ourPrice: e.price,
        brokerPrice: null,
        discount: 0,
        diff: null,
        notes: 'No aparece en el reporte del broker',
        entryId: e.id,
        brokerId
      });
    }
  });

  return results;
}

function renderAIResults(results, parsed) {
  const container = document.getElementById('aiResults');
  const body = document.getElementById('aiResultsBody');
  container.style.display = 'block';

  const counts = { match:0, diff:0, missing:0, extra:0 };
  results.forEach(r => counts[r.status]++);

  // Stats chips
  document.getElementById('aiResultsStats').innerHTML = [
    { key:'match',   label:'✓ Correctos', cls:'badge-match' },
    { key:'diff',    label:'≠ Diferencia', cls:'badge-diff' },
    { key:'missing', label:'⚠ Faltantes',  cls:'badge-missing' },
    { key:'extra',   label:'+ Extra',       cls:'badge-extra' },
  ].map(s => counts[s.key] > 0
    ? `<span class="ai-stat-chip ${s.cls}">${s.label}: ${counts[s.key]}</span>` : ''
  ).join('');

  // Rows
  body.innerHTML = results.map(r => {
    const rowCls = { match:'ai-match', diff:'ai-diff', missing:'ai-missing', extra:'ai-extra' }[r.status] || '';
    const badge = {
      match:   `<span class="ai-match-badge badge-match">✓ COINCIDE</span>`,
      diff:    `<span class="ai-match-badge badge-diff">≠ DIFERENCIA</span>`,
      missing: `<span class="ai-match-badge badge-missing">⚠ FALTANTE</span>`,
      extra:   `<span class="ai-match-badge badge-extra">+ EXTRA BROKER</span>`,
    }[r.status];

    const ourStr   = r.ourPrice !== null ? fmtAmt(r.ourPrice) : '<span style="color:var(--muted)">—</span>';
    const brkStr   = r.brokerPrice !== null ? fmtAmt(r.brokerPrice) : '<span style="color:var(--muted)">—</span>';
    const discStr  = r.discount > 0 ? `<span style="color:var(--danger)">−${fmtAmt(r.discount)}</span>` : '<span style="color:var(--muted)">—</span>';
    const diffStr  = r.diff !== null
      ? `<span style="color:${r.diff<0?'var(--danger)':r.diff>0?'var(--success)':'var(--muted)'}">${r.diff>=0?'+':''}${fmtAmt(r.diff)}</span>`
      : '';

    const applyBtn = (r.status === 'match' || r.status === 'diff') && r.entryId
      ? `<button class="btn-apply-row" onclick="applyAISingleResult('${r.entryId}','${r.brokerId}',${r.brokerPrice})" title="Aplicar al cierre">✓ Aplicar</button>`
      : '';

    return `<div class="ai-row ${rowCls}">
      <span class="mono" style="font-weight:600;color:var(--accent);font-size:0.82rem">${r.ticketNum}</span>
      <span class="mono muted" style="font-size:0.72rem">${r.date ? fmtDate(r.date) : '—'}</span>
      <span class="mono" style="text-align:right">${ourStr}</span>
      <span class="mono" style="text-align:right;color:var(--info)">${brkStr}</span>
      <span style="text-align:right">${discStr}</span>
      <span>${badge}</span>
      <span>${applyBtn}</span>
    </div>`;
  }).join('');

  // Summary row
  const totalOurs   = results.reduce((s,r) => s + (r.ourPrice || 0), 0);
  const totalBroker = results.reduce((s,r) => s + (r.brokerPrice || 0), 0);
  const totalDisc   = results.reduce((s,r) => s + (r.discount || 0), 0);
  const grandDiff   = totalBroker - totalOurs;
  document.getElementById('aiResultsSummary').innerHTML = `
    <span>Nuestro total: <strong style="color:var(--accent)">${fmtAmt(totalOurs)}</strong></span>
    <span>Total broker: <strong style="color:var(--info)">${fmtAmt(parsed.grandTotal || totalBroker)}</strong></span>
    <span>Descuentos: <strong style="color:var(--danger)">${totalDisc > 0 ? '−' + fmtAmt(totalDisc) : '—'}</strong></span>
    <span>Diferencia: <strong style="color:${grandDiff<0?'var(--danger)':grandDiff>0?'var(--success)':'var(--muted)'}">${grandDiff>=0?'+':''}${fmtAmt(grandDiff)}</strong></span>
    ${parsed.paymentDate ? `<span style="color:var(--muted)">Fecha pago: <strong>${parsed.paymentDate}</strong></span>` : ''}
  `;

  const canApply = counts.match + counts.diff > 0;
  document.getElementById('aiBtnApplyAll').disabled = !canApply;
}

function applyAISingleResult(entryId, brokerId, brokerPrice) {
  const state = clGetState();
  const bs = clBrokerState(state, brokerId);
  if (!bs.tickets[entryId]) bs.tickets[entryId] = { confirmed:false, brokerPrice:'', disputed:false };
  bs.tickets[entryId].brokerPrice = brokerPrice.toString();
  bs.tickets[entryId].confirmed = true;
  clSaveClosings();
  renderClosing();
  toast('✓ Ticket aplicado al cierre');
}

function applyAllAIResults() {
  const state = clGetState();
  let applied = 0;
  aiExtractedData.forEach(r => {
    if ((r.status === 'match' || r.status === 'diff') && r.entryId && r.brokerPrice !== null) {
      const bs = clBrokerState(state, r.brokerId);
      if (!bs.tickets[r.entryId]) bs.tickets[r.entryId] = { confirmed:false, brokerPrice:'', disputed:false };
      bs.tickets[r.entryId].brokerPrice = r.brokerPrice.toString();
      bs.tickets[r.entryId].confirmed = true;
      applied++;
    }
    if (r.status === 'missing' && r.entryId) {
      const bs = clBrokerState(state, r.brokerId);
      if (!bs.tickets[r.entryId]) bs.tickets[r.entryId] = { confirmed:false, brokerPrice:'', disputed:false };
      bs.tickets[r.entryId].disputed = true;
    }
  });
  clSaveClosings();
  renderClosing();
  toast(`⚡ ${applied} tickets aplicados — faltantes marcados como disputa`);
}

function clearAIResults() {
  document.getElementById('aiResults').style.display = 'none';
  document.getElementById('aiProgressWrap').style.display = 'none';
  document.getElementById('aiDropTitle').textContent = 'ARRASTRA AQUÍ EL REPORTE';
  document.getElementById('aiDropSub').textContent = 'PDF, PNG, JPG, JPEG, WEBP — haz clic o arrastra el archivo';
  document.getElementById('aiDropIcon').textContent = '📄';
  dz.classList.remove('has-file');
  document.getElementById('aiFileInput').value = '';
  aiExtractedData = [];
}

// ════════════════════════════════════════════════
//  API KEY MANAGEMENT
// ════════════════════════════════════════════════
function getAPIKey() { return localStorage.getItem('dt_api_key') || ''; }
function saveAPIKey() {
  const key = document.getElementById('ai_apiKey').value.trim();
  localStorage.setItem('dt_api_key', key);
  const status = document.getElementById('ai_keyStatus');
  if (key.startsWith('sk-ant-')) {
    status.innerHTML = '<span style="color:var(--success)">✓ API Key válida</span>';
  } else if (key.length > 0) {
    status.innerHTML = '<span style="color:var(--accent)">⚠ Debe iniciar con sk-ant-</span>';
  } else {
    status.innerHTML = '<span style="color:var(--muted)">Sin key — necesaria para leer reportes</span>';
  }
}
function toggleAPIKeyVisibility() {
  const inp = document.getElementById('ai_apiKey');
  inp.type = inp.type === 'password' ? 'text' : 'password';
}
function loadSavedAPIKey() {
  const key = getAPIKey();
  const inp = document.getElementById('ai_apiKey');
  if (inp && key) {
    inp.value = key;
    saveAPIKey();
  }
}

// ════════════════════════════════════════════════
//  DROPDOWN CLICK TOGGLE
// ════════════════════════════════════════════════
function toggleDropdown(id) {
  const dd = document.getElementById(id);
  if (!dd) return;
  const isOpen = dd.classList.contains('open');
  closeAllDropdowns();
  if (!isOpen) dd.classList.add('open');
}
// Close dropdowns when clicking outside
document.addEventListener('click', e => {
  if (!e.target.closest('.dropdown')) {
    document.querySelectorAll('.dropdown.open').forEach(d => d.classList.remove('open'));
  }
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    try { closeLoginModal(); } catch(_) {}
    try { closeModal(); } catch(_) {}
    document.querySelectorAll('.dropdown.open').forEach(d => d.classList.remove('open'));
  }
});

// ════════════════════════════════════════════════
//  USERS / LOGIN MODULE
// ════════════════════════════════════════════════
let currentUser = JSON.parse(localStorage.getItem('dt_session_user') || 'null');
let loginProgressTimer = null;
function setAppLocked(locked){
  document.body.classList.toggle('app-locked', !!locked);
}
function resetLoginProgress(){
  const wrap=document.getElementById('lg_loaderWrap');
  const fill=document.getElementById('lg_loaderFill');
  const pct=document.getElementById('lg_loaderPct');
  const txt=document.getElementById('lg_loaderText');
  if(wrap) wrap.classList.remove('show');
  if(fill) fill.style.width='0%';
  if(pct) pct.textContent='0%';
  if(txt) txt.textContent='Cargando perfil...';
  if(loginProgressTimer){ clearInterval(loginProgressTimer); loginProgressTimer=null; }
  ['lg_user','lg_pass'].forEach(id=>{ const el=document.getElementById(id); if(el) el.disabled=false; });
}
function runLoginProgress(rec){
  const wrap=document.getElementById('lg_loaderWrap');
  const fill=document.getElementById('lg_loaderFill');
  const pct=document.getElementById('lg_loaderPct');
  const txt=document.getElementById('lg_loaderText');
  const msg=document.getElementById('lg_msg');
  const enterBtn=[...document.querySelectorAll('#loginOverlay button')].find(b=>b.textContent.trim()==='Entrar');
  if(msg) msg.innerHTML='<span style="color:var(--info)">Validando usuario…</span>';
  if(wrap) wrap.classList.add('show');
  ['lg_user','lg_pass'].forEach(id=>{ const el=document.getElementById(id); if(el) el.disabled=true; });
  if(enterBtn) enterBtn.disabled=true;
  let v=0;
  const steps=[
    [18,'Validando credenciales...'],
    [45,'Cargando datos del usuario...'],
    [72,'Preparando menú principal...'],
    [100,'Listo, entrando...']
  ];
  let idx=0;
  loginProgressTimer=setInterval(()=>{
    const target=steps[Math.min(idx,steps.length-1)][0];
    const label=steps[Math.min(idx,steps.length-1)][1];
    if(txt) txt.textContent=label;
    v=Math.min(v+4,target);
    if(fill) fill.style.width=v+'%';
    if(pct) pct.textContent=v+'%';
    if(v>=target){ idx++; }
    if(v>=100){
      clearInterval(loginProgressTimer); loginProgressTimer=null;
      currentUser={id:rec.id, username:rec.username, role:rec.role};
      localStorage.setItem('dt_session_user', JSON.stringify(currentUser));
      if(msg) msg.innerHTML='<span style="color:var(--success)">✓ Sesión iniciada</span>';
      updateUserPill();
      setTimeout(()=>{
        resetLoginProgress();
        if(enterBtn) enterBtn.disabled=false;
        closeLoginModal();
        setAppLocked(false);
        toast('✓ Bienvenido ' + rec.username);
      },220);
    }
  },120);
}
function persistUsers(){ localStorage.setItem('dt_users', JSON.stringify(DB.users)); }
function seedDefaultUser(){
  try{
    if(!Array.isArray(DB.users)) DB.users = [];
    // Normalizar usuarios viejos (algunas versiones usaban "password" en vez de "pass")
    DB.users = DB.users.map(u => {
      if(!u) return u;
      if(!u.pass && u.password){ u.pass = u.password; }
      if(!u.role) u.role = 'viewer';
      if(!u.id) u.id = uid();
      return u;
    }).filter(Boolean);

    const adminExists = DB.users.some(u => (u.username||'').toLowerCase() === 'admin');
    if(!adminExists){
      DB.users.unshift({
        id: uid(),
        username: 'admin',
        role: 'admin',
        pass: hashPass('1234'),
        createdAt: new Date().toISOString()
      });
    }
    persistUsers();
  }catch(e){ console.error('seedDefaultUser error', e); }
}

function hashPass(v){ return btoa(unescape(encodeURIComponent(v||''))); }
function updateUserPill(){
  const pill=document.getElementById('userPill');
  if (!pill) return;
  pill.textContent = currentUser ? `👤 ${currentUser.username} (${currentUser.role})` : '👤 Invitado';
}
function renderUsersTable(){
  const tb=document.getElementById('users_tbody'); if(!tb) return;
  if (!DB.users.length){ tb.innerHTML='<tr><td colspan="4" class="muted" style="text-align:center;padding:12px">Sin usuarios</td></tr>'; return; }
  tb.innerHTML = DB.users.map(u=>`<tr><td class="mono">${u.username}</td><td>${u.role}</td><td class="mono muted">${(u.createdAt||'').split('T')[0]||'—'}</td><td class="actions"><button class="btn-icon btn-del" onclick="deleteUser('${u.id}')">🗑</button></td></tr>`).join('');
}
function saveUser(){
  const username=(document.getElementById('usr_name')||{}).value?.trim();
  const role=(document.getElementById('usr_role')||{}).value || 'viewer';
  const password=(document.getElementById('usr_pass')||{}).value || '';
  if(!username||!password){ toast('⚠ Usuario y contraseña requeridos', true); return; }
  const exists=DB.users.find(u=>u.username.toLowerCase()===username.toLowerCase());
  if(exists){ exists.role=role; exists.pass=hashPass(password); }
  else DB.users.push({id:uid(), username, role, pass:hashPass(password), createdAt:new Date().toISOString()});
  persistUsers();
  document.getElementById('usr_name').value=''; document.getElementById('usr_pass').value='';
  renderUsersTable(); toast('✓ Usuario guardado');
}
function deleteUser(id){ DB.users = DB.users.filter(u=>u.id!==id); persistUsers(); renderUsersTable(); toast('🗑 Usuario eliminado'); }
function openLoginModal(){
  const o=document.getElementById('loginOverlay');
  if(o){
    closeAllDropdowns();
    o.classList.add('open');
    const msg=document.getElementById('lg_msg');
    if(msg) msg.innerHTML = currentUser
      ? `<span style="color:var(--info)">Sesión actual: ${currentUser.username} (${currentUser.role})</span>`
      : 'Usuario inicial: <span class="accent">admin</span> / <span class="accent">1234</span> (cámbialo en Settings → Registro de Usuarios)';
    resetLoginProgress();
    setTimeout(()=>document.getElementById('lg_user')?.focus(), 60);
    updateUserPill();
  }
}
function closeLoginModal(){
  if (document.body.classList.contains('app-locked') && !currentUser) return;
  const o=document.getElementById('loginOverlay');
  if(o) o.classList.remove('open');
  closeAllDropdowns();
}
function doLogin(){
  const u=(document.getElementById('lg_user')||{}).value?.trim()||''; const p=(document.getElementById('lg_pass')||{}).value||'';
  const msg=document.getElementById('lg_msg');
  const rec=DB.users.find(x=> (x.username||'').toLowerCase()===u.toLowerCase() && (x.pass || x.password)===hashPass(p));
  if(!rec){ if(msg) msg.innerHTML='<span style="color:var(--danger)">Usuario o contraseña inválidos</span>'; resetLoginProgress(); return; }
  runLoginProgress(rec);
}
function logoutUser(){
  // Cerrar sesión y limpiar UI sin dejar menús abiertos
  currentUser = null;
  try { localStorage.removeItem('dt_session_user'); } catch(_) {}

  // Cerrar modal login si está abierto
  const overlay = document.getElementById('loginOverlay');
  if (overlay) overlay.classList.remove('open');

  // Cerrar todos los dropdowns
  closeAllDropdowns();

  // Actualizar estado visual
  updateUserPill();

  // Mantener resaltado del menú de la página actual
  document.querySelectorAll('.nav-btn.active').forEach(b => b.classList.remove('active'));
  if (currentPage === 'tickets') {
    document.querySelector('nav .nav-btn')?.classList.add('active');
  } else if (currentPage === 'earnings') {
    document.getElementById('earningsNavBtn')?.classList.add('active');
  } else if (currentPage === 'closing') {
    document.getElementById('closingNavBtn')?.classList.add('active');
  } else if (currentPage === 'expenses') {
    document.getElementById('expensesNavBtn')?.classList.add('active');
  } else if (currentPage === 'alerts') {
    document.getElementById('alertsNavBtn')?.classList.add('active');
  } else if (currentPage === 'pl' || currentPage === 'brokerreport') {
    document.getElementById('reportsBtn')?.classList.add('active');
  } else if (currentPage === 'settings') {
    document.getElementById('settingsNavBtn')?.classList.add('active');
  } else if (['trucks','drivers','brokers'].includes(currentPage)) {
    document.getElementById('registrosBtn')?.classList.add('active');
  }

  const msg = document.getElementById('lg_msg');
  if (msg) msg.innerHTML = 'Usa un usuario creado en <span class="accent">Settings → Registro de Usuarios</span>';
  const u = document.getElementById('lg_user'); if (u) u.value = '';
  const pw = document.getElementById('lg_pass'); if (pw) pw.value = '';

  setAppLocked(true);
  openLoginModal();
  toast('Sesión cerrada');
}

// ════════════════════════════════════════════════
//  SETTINGS MODULE
// ════════════════════════════════════════════════
const CFG_KEY = 'dt_config';
function loadConfig() {
  try { return JSON.parse(localStorage.getItem(CFG_KEY) || '{}'); } catch { return {}; }
}
function saveConfig(cfg) { localStorage.setItem(CFG_KEY, JSON.stringify(cfg)); }

function renderSettings() {
  const cfg = loadConfig();
  const fields = [
    'companyName','dba','entityType','ein','dot','mc',
    'phone','phone2','email','website',
    'address1','address2','city','state','zip','country',
    'bankName','bankAccName','bankRouting','bankAccount','bankType','zelle',
    'currency','dateFormat','weekStart','ticketPrefix'
  ];
  fields.forEach(f => {
    const el = document.getElementById('cfg_' + f);
    if (el && cfg[f] !== undefined) el.value = cfg[f];
  });

  // Logo
  if (cfg.logoData) {
    document.getElementById('logoPreview').src = cfg.logoData;
    document.getElementById('logoPreview').style.display = 'block';
    document.getElementById('logoPlaceholder').style.display = 'none';
    document.getElementById('prev_logo').src = cfg.logoData;
    document.getElementById('prev_logo').style.display = 'block';
    document.getElementById('prev_logoIcon').style.display = 'none';
  }

  // API key
  const apiKey = getAPIKey();
  const cfgKey = document.getElementById('cfg_apiKey');
  if (cfgKey) {
    cfgKey.value = apiKey;
    updateCfgKeyStatus(apiKey);
  }

  updatePreview();
  renderUsersTable();
}

function updatePreview() {
  const get = id => (document.getElementById('cfg_' + id)||{}).value || '';
  const name = get('companyName') || 'MI EMPRESA';
  const entity = get('entityType');
  const addr1 = get('address1');
  const city = get('city'); const state = get('state'); const zip = get('zip');
  const addrStr = [addr1, [city, state, zip].filter(Boolean).join(', ')].filter(Boolean).join(', ') || '—';

  document.getElementById('prev_name').textContent = name.toUpperCase();
  document.getElementById('prev_entity').textContent = entity;
  document.getElementById('prev_address').textContent = '📍 ' + addrStr;
  document.getElementById('prev_phone').textContent = '📞 ' + (get('phone') || '—');
  document.getElementById('prev_email').textContent = '✉ ' + (get('email') || '—');
  document.getElementById('prev_ein').textContent = 'EIN: ' + (get('ein') || '—');
  document.getElementById('prev_dot').textContent = 'DOT: ' + (get('dot') || '—');
  document.getElementById('prev_mc').textContent = 'MC: ' + (get('mc') || '—');
}

// Live preview on input
document.addEventListener('input', e => {
  if (e.target.id && e.target.id.startsWith('cfg_')) updatePreview();
});

function saveSettings() {
  const fields = [
    'companyName','dba','entityType','ein','dot','mc',
    'phone','phone2','email','website',
    'address1','address2','city','state','zip','country',
    'bankName','bankAccName','bankRouting','bankAccount','bankType','zelle',
    'currency','dateFormat','weekStart','ticketPrefix'
  ];
  const cfg = loadConfig();
  fields.forEach(f => {
    const el = document.getElementById('cfg_' + f);
    if (el) cfg[f] = el.value;
  });
  saveConfig(cfg);
  // Also save API key
  const apiKeyEl = document.getElementById('cfg_apiKey');
  if (apiKeyEl) localStorage.setItem('dt_api_key', apiKeyEl.value.trim());
  toast('✓ Configuración guardada');
  updatePreview();
  renderUsersTable();
}

function loadCompanyLogo(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const data = e.target.result;
    document.getElementById('logoPreview').src = data;
    document.getElementById('logoPreview').style.display = 'block';
    document.getElementById('logoPlaceholder').style.display = 'none';
    document.getElementById('prev_logo').src = data;
    document.getElementById('prev_logo').style.display = 'block';
    document.getElementById('prev_logoIcon').style.display = 'none';
    const cfg = loadConfig(); cfg.logoData = data; saveConfig(cfg);
    toast('✓ Logo cargado');
  };
  reader.readAsDataURL(file);
}

function clearCompanyLogo() {
  document.getElementById('logoPreview').style.display = 'none';
  document.getElementById('logoPlaceholder').style.display = 'block';
  document.getElementById('prev_logo').style.display = 'none';
  document.getElementById('prev_logoIcon').style.display = 'block';
  const cfg = loadConfig(); delete cfg.logoData; saveConfig(cfg);
  toast('Logo eliminado');
}

function syncAPIKey() {
  const key = document.getElementById('cfg_apiKey').value.trim();
  localStorage.setItem('dt_api_key', key);
  updateCfgKeyStatus(key);
  // Also sync to the AI reader input if visible
  const aiInp = document.getElementById('ai_apiKey');
  if (aiInp) { aiInp.value = key; }
}
function toggleCfgAPIKey() {
  const inp = document.getElementById('cfg_apiKey');
  inp.type = inp.type === 'password' ? 'text' : 'password';
}
function updateCfgKeyStatus(key) {
  const el = document.getElementById('cfg_keyStatus');
  if (!el) return;
  if (key && key.startsWith('sk-ant-')) {
    el.innerHTML = '<span style="color:var(--success)">✓ API Key válida y guardada</span>';
  } else if (key && key.length > 5) {
    el.innerHTML = '<span style="color:var(--accent)">⚠ Formato inválido — debe iniciar con sk-ant-</span>';
  } else {
    el.innerHTML = '<span style="color:var(--muted)">Obtén tu key en <a href="https://console.anthropic.com" target="_blank" style="color:var(--info)">console.anthropic.com</a></span>';
  }
}

function exportBackup() {
  const backup = {
    version: '1.0',
    exportDate: new Date().toISOString(),
    config: loadConfig(),
    data: {
      tickets:    DB.tickets,
      trucks:     DB.trucks,
      drivers:    DB.drivers,
      companies:  [],
      brokers:    DB.brokers,
      earnings:   DB.earnings,
      weekClosings: DB.weekClosings,
      expenses:   DB.expenses,
    }
  };
  const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'dumptrack_backup_' + new Date().toISOString().split('T')[0] + '.json';
  a.click();
  toast('✓ Backup exportado');
}

function importBackup(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const backup = JSON.parse(e.target.result);
      if (!backup.data) throw new Error('Formato inválido');
      if (!confirm('⚠ Esto reemplazará TODOS los datos actuales. ¿Continuar?')) return;
      const d = backup.data;
      if (d.tickets)     { DB.tickets = d.tickets;         save('tickets'); }
      if (d.trucks)      { DB.trucks = d.trucks;           save('trucks'); }
      if (d.drivers)     { DB.drivers = d.drivers;         save('drivers'); }
      if (d.companies)   { DB.companies = d.companies;     save('companies'); }
      if (d.brokers)     { DB.brokers = d.brokers;         save('brokers'); }
      if (d.earnings)    { DB.earnings = d.earnings;       localStorage.setItem('dt_earnings', JSON.stringify(d.earnings)); }
      if (d.weekClosings){ DB.weekClosings = d.weekClosings; localStorage.setItem('dt_weekClosings', JSON.stringify(d.weekClosings)); }
      if (d.expenses)    { DB.expenses = d.expenses;       saveExpenses(); }
      if (backup.config) saveConfig(backup.config);
      renderAll();
      renderSettings();
      toast('✓ Backup importado exitosamente');
    } catch(err) {
      toast('❌ Error al importar: ' + err.message, true);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function confirmResetAllData() {
  if (!confirm('⚠️ ADVERTENCIA: Esto borrará TODOS los datos permanentemente.\n\nEscribe "BORRAR" para confirmar:')) return;
  const input = prompt('Escribe BORRAR para confirmar:');
  if (input !== 'BORRAR') { toast('Cancelado — datos no borrados'); return; }
  ['dt_tickets','dt_trucks','dt_drivers','dt_brokers','dt_earnings','dt_weekClosings','dt_expenses'].forEach(k => localStorage.removeItem(k));
  DB.tickets=[]; DB.trucks=[]; DB.drivers=[]; DB.brokers=[]; DB.earnings=[]; DB.weekClosings={}; DB.expenses=[];
  renderAll();
  toast('🗑 Todos los datos borrados', true);
}

function updateMenuBadges() {
  document.getElementById('truckMenuBadge').textContent  = DB.trucks.length;
  document.getElementById('driverMenuBadge').textContent = DB.drivers.length;
  document.getElementById('brokerMenuBadge').textContent = DB.brokers.length;
  updateAlertDot();
}

function updateAlertDot() {
  const now = new Date(); now.setHours(0,0,0,0);
  let hasCritical = false;
  DB.trucks.forEach(t => {
    if (t.insurance) { const d = getDaysUntil(t.insurance); if (d !== null && d <= 30) hasCritical = true; }
    if (t.dot)       { const d = getDaysUntil(t.dot);       if (d !== null && d <= 30) hasCritical = true; }
  });
  DB.drivers.forEach(dr => {
    if (dr.cdlExp) { const d = getDaysUntil(dr.cdlExp); if (d !== null && d <= 30) hasCritical = true; }
    if (dr.medical){ const d = getDaysUntil(dr.medical); if (d !== null && d <= 30) hasCritical = true; }
  });
  const badge = document.getElementById('alertsBadge');
  if (badge) badge.style.display = hasCritical ? 'block' : 'none';
}

// ════════════════════════════════════════════════
//  RENDER ALL
// ════════════════════════════════════════════════
function renderAll() {
  populateSelects();
  populateEarningsBrokers();
  populateEarningsTrucks();
  populateExpenseTrucks();
  populateAIBrokers();
  renderTickets();
  renderTrucks();
  renderDrivers();
  renderBrokers();
  renderExpenses();
  updateMenuBadges();
  updateUserPill();
}

// ════════════════════════════════════════════════
//  INIT
// ════════════════════════════════════════════════
updateWeekUI();
updateWeekE();
clUpdateWeekUI();
document.getElementById('t_date').value = new Date().toISOString().split('T')[0];
document.getElementById('ew_date').value = new Date().toISOString().split('T')[0];
document.getElementById('exp_date').value = new Date().toISOString().split('T')[0];
document.getElementById('t_num').value = nextTicketNum();
renderAll();
loadSavedAPIKey();
if (currentUser) {
  setAppLocked(false);
} else {
  setAppLocked(true);
  setTimeout(openLoginModal, 150);
}

/* ── FULLSCREEN STARTUP (auto on first interaction/login, ESC exits native fullscreen) ── */
(function(){
  function requestAppFullscreen(){
    const el = document.documentElement;
    if (!el || document.fullscreenElement) return;
    const fn = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
    if (fn) {
      try { fn.call(el); } catch(e) {}
    }
  }
  function exitAppFullscreen(){
    const fn = document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen;
    if (document.fullscreenElement && fn) {
      try { fn.call(document); } catch(e) {}
    }
  }

  // Intenta entrar en pantalla completa en la primera interacción (requisito del navegador)
  document.addEventListener('click', function firstFS(){
    requestAppFullscreen();
  }, { once:true, capture:true });

  // Si el login llama runLoginProgress desde el botón Entrar, también intenta fullscreen ahí
  if (typeof runLoginProgress === 'function') {
    const _runLoginProgress = runLoginProgress;
    runLoginProgress = function(rec){
      requestAppFullscreen();
      return _runLoginProgress.apply(this, arguments);
    };
  }

  // Al cerrar sesión, opcionalmente salimos de fullscreen
  if (typeof logoutUser === 'function') {
    const _logoutUser = logoutUser;
    logoutUser = function(){
      exitAppFullscreen();
      return _logoutUser.apply(this, arguments);
    };
  }

  // Atajo F11 interno (además del F11 del navegador). ESC ya funciona nativo para salir.
  document.addEventListener('keydown', function(ev){
    if (ev.key === 'F11') {
      ev.preventDefault();
      if (document.fullscreenElement) exitAppFullscreen();
      else requestAppFullscreen();
    }
  });

  // Botón pequeño para activar fullscreen si el navegador bloqueó el auto
  function ensureFsButton(){
    if (document.getElementById('fsQuickBtn')) return;
    const btn = document.createElement('button');
    btn.id = 'fsQuickBtn';
    btn.type = 'button';
    btn.textContent = '⛶ Pantalla completa';
    btn.style.cssText = 'position:fixed;right:12px;bottom:12px;z-index:9999;background:#1c1c1c;color:#f5f5f5;border:1px solid #444;border-radius:8px;padding:8px 10px;font:600 12px/1 system-ui;cursor:pointer;opacity:.92';
    btn.addEventListener('click', function(){
      if (document.fullscreenElement) exitAppFullscreen(); else requestAppFullscreen();
    });
    document.body.appendChild(btn);
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ensureFsButton, {once:true});
  } else {
    ensureFsButton();
  }
})();

</script>
<!-- BUILD: login-startup-progress -->

<script>
(function(){
  // --- Bootstrap de usuarios (compatibilidad con versiones anteriores) ---
  function normalizeUsers(raw){
    let users = [];
    try { users = JSON.parse(raw || "[]"); } catch(e){ users = []; }
    if (!Array.isArray(users)) users = [];

    const normalized = [];
    for (const u of users){
      if (!u) continue;
      if (typeof u === "string"){
        normalized.push({ username: u, password: "1234", role: "Admin" });
        continue;
      }
      const username = (u.username || u.user || u.usuario || "").toString().trim();
      const password = (u.password || u.pass || u.clave || "1234").toString();
      const role = (u.role || u.rol || "Admin").toString();
      if (username) normalized.push({ username, password, role });
    }

    // quitar duplicados por username (último gana)
    const byName = {};
    for (const u of normalized) byName[u.username.toLowerCase()] = u;
    return Object.values(byName);
  }

  function bootstrapUsers(){
    const keyCandidates = ["dt_users","dumptrack_users","users","usuarios"];
    let merged = [];
    for (const k of keyCandidates){
      const n = normalizeUsers(localStorage.getItem(k));
      if (n.length) merged = merged.concat(n);
    }

    // si no hay usuarios, crear admin por defecto
    if (!merged.length){
      merged = [{ username: "admin", password: "1234", role: "Admin" }];
    }

    // dedupe final
    const byName = {};
    for (const u of merged) byName[u.username.toLowerCase()] = u;
    const finalUsers = Object.values(byName);

    // guardar en la llave principal y compatibilidad
    localStorage.setItem("dt_users", JSON.stringify(finalUsers));
    localStorage.setItem("dt_users", JSON.stringify(finalUsers));
    if (!localStorage.getItem("dt_users")) localStorage.setItem("dt_users", JSON.stringify(finalUsers));

    // exponer helper global sin romper diseño
    window.__DT_GET_USERS__ = function(){
      try { return JSON.parse(localStorage.getItem("dt_users") || "[]"); } catch(e){ return []; }
    };
    window.__DT_SET_USERS__ = function(arr){
      localStorage.setItem("dt_users", JSON.stringify(arr || []));
      localStorage.setItem("dt_users", JSON.stringify(arr || []));
    };
  }

  bootstrapUsers();
})();
</script>


<script>
(function(){
  function __dtGetUsersSafe(){
    try {
      if (window.__DT_GET_USERS__) return window.__DT_GET_USERS__();
      return JSON.parse(localStorage.getItem("dt_users") || "[]");
    } catch(e){ return []; }
  }
  function __dtSetUsersSafe(arr){
    try {
      if (window.__DT_SET_USERS__) return window.__DT_SET_USERS__(arr);
      localStorage.setItem("dt_users", JSON.stringify(arr || []));
      localStorage.setItem("dumptrack_users", JSON.stringify(arr || []));
    } catch(e){}
  }

  function attachResetBtn(){
    var btn = document.getElementById("btnResetPass");
    if (!btn) return;

    btn.addEventListener("click", function(){
      var u = prompt("Ingrese el usuario para restaurar la contraseña:");
      if (u === null) return;
      u = String(u).trim();
      if (!u){
        alert("Debe escribir un usuario.");
        return;
      }

      var users = __dtGetUsersSafe();
      var idx = users.findIndex(function(x){
        return String(x.username || "").trim().toLowerCase() === u.toLowerCase();
      });

      if (idx < 0){
        alert("Usuario no encontrado.");
        return;
      }

      var newPass = prompt("Nueva contraseña para '" + u + "':");
      if (newPass === null) return;
      newPass = String(newPass);

      if (newPass.trim().length < 4){
        alert("La contraseña debe tener al menos 4 caracteres.");
        return;
      }

      var confirmPass = prompt("Confirme la nueva contraseña:");
      if (confirmPass === null) return;
      if (String(confirmPass) !== newPass){
        alert("Las contraseñas no coinciden.");
        return;
      }

      users[idx].password = newPass;
      __dtSetUsersSafe(users);

      alert("✅ Contraseña actualizada correctamente para: " + u);
    });
  }

  // attach now and on delayed load (por si el login se renderiza después)
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", attachResetBtn);
  } else {
    attachResetBtn();
  }
  setTimeout(attachResetBtn, 800);
  setTimeout(attachResetBtn, 1800);
})();
</script>


<div id="resetPassModal" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.6);align-items:center;justify-content:center;padding:16px;">
  <div id="resetPassCard" style="width:min(460px,96vw);background:#1c2230;border:1px solid rgba(255,255,255,.12);border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.45);padding:16px;color:#fff;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px;">
      <div style="font-weight:700;font-size:1.05rem;">🔑 Restaurar contraseña</div>
      <button type="button" id="btnCloseResetModal" style="border:1px solid rgba(255,255,255,.18);background:#2a3142;color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;">✕</button>
    </div>
    <div style="color:rgba(255,255,255,.75);font-size:.9rem;margin-bottom:12px;">
      Cambia la contraseña de un usuario registrado.
    </div>

    <div style="display:grid;gap:10px;">
      <label style="display:grid;gap:4px;">
        <span style="font-size:.86rem;color:rgba(255,255,255,.85);">Usuario</span>
        <input id="rpUser" type="text" placeholder="admin" style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:#101521;color:#fff;outline:none;">
      </label>

      <label style="display:grid;gap:4px;">
        <span style="font-size:.86rem;color:rgba(255,255,255,.85);">Nueva contraseña</span>
        <input id="rpPass1" type="password" placeholder="Mínimo 4 caracteres" style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:#101521;color:#fff;outline:none;">
      </label>

      <label style="display:grid;gap:4px;">
        <span style="font-size:.86rem;color:rgba(255,255,255,.85);">Confirmar contraseña</span>
        <input id="rpPass2" type="password" placeholder="Repita la contraseña" style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:#101521;color:#fff;outline:none;">
      </label>
    </div>

    <div id="rpMsg" style="min-height:20px;margin-top:10px;font-size:.88rem;color:#ffcf66;"></div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px;">
      <button type="button" id="btnCancelReset" style="border:1px solid rgba(255,255,255,.18);background:#2a3142;color:#fff;border-radius:10px;padding:9px 12px;cursor:pointer;">Cancelar</button>
      <button type="button" id="btnSaveReset" style="border:1px solid #b88300;background:#d4a017;color:#221700;border-radius:10px;padding:9px 12px;font-weight:700;cursor:pointer;">Guardar</button>
    </div>
  </div>
</div>


<script>
(function(){
  function __dtGetUsersSafe(){
    try {
      if (window.__DT_GET_USERS__) return window.__DT_GET_USERS__();
      return JSON.parse(localStorage.getItem("dt_users") || "[]");
    } catch(e){ return []; }
  }
  function __dtSetUsersSafe(arr){
    try {
      if (window.__DT_SET_USERS__) return window.__DT_SET_USERS__(arr);
      localStorage.setItem("dt_users", JSON.stringify(arr || []));
      localStorage.setItem("dumptrack_users", JSON.stringify(arr || []));
    } catch(e){}
  }

  function $(id){ return document.getElementById(id); }

  function setMsg(msg, ok){
    var el = $("rpMsg");
    if (!el) return;
    el.textContent = msg || "";
    el.style.color = ok ? "#8df5a6" : "#ffcf66";
  }

  function openResetModal(){
    var modal = $("resetPassModal");
    if (!modal) return;
    modal.style.display = "flex";
    setMsg("");
    if ($("rpPass1")) $("rpPass1").value = "";
    if ($("rpPass2")) $("rpPass2").value = "";
    // prefill current username if input exists in login
    var loginUser = document.querySelector('input[type="text"][placeholder*="Usuario"], input[name*="user"], #username, #loginUser');
    if ($("rpUser")) {
      if (loginUser && loginUser.value && !$("rpUser").value) $("rpUser").value = loginUser.value.trim();
      $("rpUser").focus();
    }
  }

  function closeResetModal(){
    var modal = $("resetPassModal");
    if (!modal) return;
    modal.style.display = "none";
  }

  function saveReset(){
    var user = (($("rpUser") && $("rpUser").value) || "").trim();
    var p1 = (($("rpPass1") && $("rpPass1").value) || "");
    var p2 = (($("rpPass2") && $("rpPass2").value) || "");
    if (!user) return setMsg("Escribe el usuario.");
    if (p1.trim().length < 4) return setMsg("La contraseña debe tener mínimo 4 caracteres.");
    if (p1 !== p2) return setMsg("Las contraseñas no coinciden.");

    var users = __dtGetUsersSafe();
    var idx = users.findIndex(function(x){
      return String(x.username || "").trim().toLowerCase() === user.toLowerCase();
    });
    if (idx < 0) return setMsg("Usuario no encontrado.");

    users[idx].password = p1;
    __dtSetUsersSafe(users);
    setMsg("✅ Contraseña actualizada correctamente.", true);

    // clear fields and close after short delay
    setTimeout(function(){ closeResetModal(); }, 700);
  }

  function bindResetUI(){
    var btn = $("btnResetPass");
    if (btn && !btn.__boundReset){
      btn.__boundReset = true;
      btn.addEventListener("click", openResetModal);
    }

    var closeA = $("btnCloseResetModal");
    var closeB = $("btnCancelReset");
    var save = $("btnSaveReset");
    var modal = $("resetPassModal");

    if (closeA && !closeA.__boundReset){ closeA.__boundReset = true; closeA.addEventListener("click", closeResetModal); }
    if (closeB && !closeB.__boundReset){ closeB.__boundReset = true; closeB.addEventListener("click", closeResetModal); }
    if (save && !save.__boundReset){ save.__boundReset = true; save.addEventListener("click", saveReset); }

    if (modal && !modal.__boundReset){
      modal.__boundReset = true;
      modal.addEventListener("click", function(e){
        if (e.target === modal) closeResetModal();
      });
    }

    document.addEventListener("keydown", function(e){
      if (e.key === "Escape" && modal && modal.style.display !== "none") {
        closeResetModal();
      }
    });

    var p2 = $("rpPass2");
    if (p2 && !p2.__boundReset){
      p2.__boundReset = true;
      p2.addEventListener("keydown", function(e){
        if (e.key === "Enter") saveReset();
      });
    }
  }

  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", bindResetUI);
  } else {
    bindResetUI();
  }
  setTimeout(bindResetUI, 700);
  setTimeout(bindResetUI, 1600);
})();
</script>

<!-- ══════════════════════════════════════════════════════════
     PRINT FOOTER — visible only on print
══════════════════════════════════════════════════════════ -->
<div class="print-footer" id="globalPrintFooter" style="display:none">
  <span id="prt_footer_company">DumpTrack Pro</span> &nbsp;·&nbsp;
  Impreso el <span id="prt_footer_date"></span> &nbsp;·&nbsp;
  <span id="prt_footer_user"></span> &nbsp;·&nbsp;
  Generado por DumpTrack Pro
</div>

<script>
/* ══════════════════════════════════════════════════════════
   SISTEMA DE IMPRESIÓN PROFESIONAL — printPage()
   Incluye logo, datos de empresa y pie de página
══════════════════════════════════════════════════════════ */
(function(){
  function getCfg(){ try { return JSON.parse(localStorage.getItem('dumptrack_cfg')||'{}'); } catch(e){ return {}; } }
  function getCurrentUser(){ try { return localStorage.getItem('dt_current_user')||''; } catch(e){ return ''; } }
  function fmtDate(d){ return d.toLocaleDateString('es-US',{year:'numeric',month:'long',day:'numeric'}); }

  function getPeriodLabel(){
    var sel = document.getElementById('pl_period');
    if(sel){ var opts={week:'Esta Semana',month:'Este Mes',quarter:'Este Trimestre',year:'Este Año'}; return opts[sel.value]||sel.options[sel.selectedIndex]?.text||''; }
    sel = document.getElementById('brr_period');
    if(sel) return sel.options[sel.selectedIndex]?.text||'';
    return '';
  }

  function getWeekInfo(pageKey){
    var ids = {
      tickets:{ title:'weekTitle', label:'weekLabel' },
      earnings:{ title:'ew_weekTitle', label:'ew_weekLabel' },
      closing:{ title:'cl_weekTitle', label:'cl_weekLabel' }
    };
    var m = ids[pageKey];
    if(!m) return '';
    var t = document.getElementById(m.title)?.textContent||'';
    var l = document.getElementById(m.label)?.textContent||'';
    return [t, l].filter(Boolean).join(' — ');
  }

  var PAGE_LABELS = {
    tickets:'REPORTE DE TICKETS',
    earnings:'GANANCIAS SEMANALES',
    closing:'CIERRE DE SEMANA',
    expenses:'REGISTRO DE GASTOS',
    pl:'P&L — PÉRDIDAS Y GANANCIAS',
    brokerreport:'REPORTE POR BROKER',
    trucks:'REGISTRO DE CAMIONES',
    drivers:'REGISTRO DE CHOFERES',
    brokers:'REGISTRO DE BROKERS',
    alerts:'ALERTAS DE VENCIMIENTO'
  };

  function buildPrintHeader(pageKey, cfg, now){
    var companyName = cfg.companyName || 'DUMPTRACK PRO';
    var lines = [];
    var parts = [];
    if(cfg.dba) parts.push('DBA: '+cfg.dba);
    if(cfg.entityType) parts.push(cfg.entityType);
    if(parts.length) lines.push(parts.join(' · '));
    var contact = [];
    if(cfg.phone) contact.push(cfg.phone);
    if(cfg.email) contact.push(cfg.email);
    if(contact.length) lines.push(contact.join(' · '));
    var legal = [];
    if(cfg.ein) legal.push('EIN: '+cfg.ein);
    if(cfg.dot) legal.push('DOT: '+cfg.dot);
    if(cfg.mc)  legal.push('MC: '+cfg.mc);
    if(legal.length) lines.push(legal.join(' · '));
    if(cfg.address) lines.push(cfg.address);

    var reportLabel = PAGE_LABELS[pageKey] || 'REPORTE';
    var periodStr = '';
    if(['tickets','earnings','closing'].indexOf(pageKey)>-1) periodStr = getWeekInfo(pageKey);
    else if(['pl','brokerreport'].indexOf(pageKey)>-1) periodStr = getPeriodLabel();

    var logoHtml = '';
    if(cfg.logoData){
      logoHtml = '<img src="'+cfg.logoData+'" style="max-height:70px;max-width:140px;object-fit:contain;margin-right:16px;"/>';
    } else {
      logoHtml = '<div style="font-size:2.2rem;margin-right:12px">🚛</div>';
    }

    return '<div class="print-company-header" style="display:flex;align-items:flex-start;justify-content:space-between;border-bottom:3px solid #c47a00;padding-bottom:12px;margin-bottom:18px;gap:16px">'
      + '<div style="display:flex;align-items:center">'
      + logoHtml
      + '<div>'
      + '<div style="font-size:18pt;font-weight:700;color:#111;letter-spacing:1px;font-family:sans-serif">'+companyName+'</div>'
      + lines.map(function(l){ return '<div style="font-size:8.5pt;color:#555;margin-top:2px;font-family:monospace">'+l+'</div>'; }).join('')
      + '</div>'
      + '</div>'
      + '<div style="text-align:right;min-width:180px">'
      + '<div style="font-size:13pt;font-weight:700;color:#c47a00;letter-spacing:1px;font-family:sans-serif">'+reportLabel+'</div>'
      + (periodStr ? '<div style="font-size:9pt;color:#333;margin-top:4px;font-family:monospace">'+periodStr+'</div>' : '')
      + '<div style="font-size:8pt;color:#777;margin-top:6px;font-family:monospace">'+fmtDate(now)+'</div>'
      + (getCurrentUser() ? '<div style="font-size:8pt;color:#777;font-family:monospace">Usuario: '+getCurrentUser()+'</div>' : '')
      + '</div>'
      + '</div>';
  }

  function buildPrintFooter(cfg, now){
    var companyName = cfg.companyName || 'DumpTrack Pro';
    return companyName + ' &nbsp;·&nbsp; Impreso el '+fmtDate(now)
      + (getCurrentUser() ? ' &nbsp;·&nbsp; Usuario: '+getCurrentUser() : '')
      + ' &nbsp;·&nbsp; Generado por DumpTrack Pro';
  }

  // Inject a hidden print-only container in each page that gets filled on print
  function injectPrintContainers(){
    var pages = ['tickets','earnings','closing','expenses','pl','brokerreport','trucks','drivers','brokers','alerts'];
    pages.forEach(function(p){
      var pageEl = document.getElementById('page-'+p);
      if(!pageEl) return;
      var container = pageEl.querySelector('.container');
      if(!container) return;
      // Remove any existing injected header
      var existing = container.querySelector('.prt-injected-header');
      if(existing) existing.remove();
      // Create placeholder (filled on printPage call)
      var div = document.createElement('div');
      div.className = 'prt-injected-header';
      div.style.cssText = 'display:none';
      div.setAttribute('data-page', p);
      container.insertBefore(div, container.firstChild);
    });
  }

  window.printPage = function(pageKey){
    var cfg = getCfg();
    var now = new Date();

    // Fill header for active page
    var pageEl = document.getElementById('page-'+pageKey);
    if(pageEl){
      var hdr = pageEl.querySelector('.prt-injected-header');
      if(hdr) hdr.innerHTML = buildPrintHeader(pageKey, cfg, now);
    }

    // Fill global footer
    var footer = document.getElementById('globalPrintFooter');
    if(footer) footer.innerHTML = buildPrintFooter(cfg, now);

    // Also update any old static print-company-header divs (from previous session)
    var oldHdrs = document.querySelectorAll('.print-company-header[style*="display:none"]');
    oldHdrs.forEach(function(el){ el.style.display='none'; });

    setTimeout(function(){ window.print(); }, 100);
  };

  // Initialize on load
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', injectPrintContainers);
  } else {
    injectPrintContainers();
  }

})();
</script>

</body>
</html>
